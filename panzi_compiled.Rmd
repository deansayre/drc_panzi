---
title: "Outbreak of Febrile illness with cough and elevated case fatality rate -- Panzi Health Zone, DRC"
author: "Drs. Dean Sayre and Osee Sanogo\nU.S. Centers for Disease Control and Prevention"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
#runtime: shiny
output:
  html_document:
    code_folding: hide
    code_download: true
    highlight: zenburn
    number_sections: no
    theme: spacelab
    toc: no
    includes:
      in_header: header.html
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

#  {.tabset .tabset-fade}

## **Summary** {.tabset .tabset-pills}

```{r}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(rio, 
               Hmisc,
               downloadthis,
               flextable,
               malariaAtlas,
               raster,
               imputeTS,
               here,
               waffle,
               tmap,
               sf,
               leaflet,
               viridisLite,
               stringdist,
               tidyverse)

pacman::p_install_gh("deansayre/Rtesunate")
pacman::p_install_gh("const-ae/ggupset")
pacman::p_install_gh("moodymudskipper/powerjoin")

library(ggupset)
library(Rtesunate)
library(powerjoin)



data_loc <- here::here("linelist", "LL_GPM_PANZI_23_01_2025_AS_RAJ.xlsx")

data <- rio::import(data_loc) %>% 
  Rtesunate::act_clean() %>% 
  rename(n = 1) %>% 
  mutate(id = row_number())

lab_loc <- here::here("linelist", "lab_linelist.xlsx")

lab_1 <- rio::import(lab_loc) %>% 
  Rtesunate::act_clean() %>% 
  select(-1) %>% 
  filter(!is.na(id)) %>% 
  filter(!is.na(noms))

lab_2 <- rio::import(here::here("linelist", "lab_linelist.xlsx"), which = 2) %>% 
  Rtesunate::act_clean() %>% 
  rename(id = labid) %>% 
  mutate(dte_de_reception = as.character(dte_de_reception)) %>% 
  filter(!is.na(id))


lab <- bind_rows(lab_1, lab_2) %>% 
  filter(!is.na(noms))

hf_dhis2 <- rio::import("dhis2_hf_names.xlsx") %>% 
  rename(panzi_zds = 1) %>% 
  mutate(hf = case_when(str_detect(panzi_zds, "Aire") ~ NA_character_, 
                                   .default = panzi_zds),
         panzi_zds = case_when(!is.na(hf) ~ NA_character_, 
                                              .default = panzi_zds)
  ) %>% 
  fill(panzi_zds, .direction = "down") %>% 
  filter(!is.na(hf))

hf_dhis2 %>% 
  Rtesunate::act_clean() %>% 
  rio::export(file = "hf_dhis2_usable.xlsx")


line_name <- word(data_loc, -1, sep = "/")  
line_last <- as.character(max(data$date_de_notification))
line_first <- as.character(min(data$date_de_notification))


lab_name <- word(lab_loc, -1, sep = "/") 
lab_last <- as.character(max(lab$date_de_prelevement, na.rm = TRUE))
lab_first <- as.character(min(lab$date_de_prelevement, na.rm = TRUE))

theme <- ggplot2::theme_minimal()
ggplot2::theme_set(theme)

color3 <- c( "firebrick4", "cadetblue4", "white")

routine_case_a <- rio::import(here("routine_data", "cas_confirme_02_27_25.xlsx"))
routine_case_a1 <- routine_case_a %>% 
  pivot_longer(-c(1,2)) %>% 
  mutate(month_name = word(name, 1, sep = " "),
         month_num = factor(case_when(month_name == "Janvier" ~ "1", 
                           month_name == "Février" ~ "2",
                           month_name == "Mars"  ~ "3", 
                           month_name == "Avril"  ~ "4",
                           month_name == "Mai"  ~ "5", 
                           month_name == "Juin"  ~ "6",
                           month_name == "Juillet"  ~ "7", 
                           str_detect(month_name, "Ao")  ~ "8",
                           month_name == "Septembre"  ~ "9", 
                           month_name == "Octobre"  ~ "10",
                           month_name == "Novembre"  ~ "11", 
                           month_name == "Décembre" ~ "12"), 
                        levels = map(seq(1,12,1), ~as.character(.x))), 
         year = as.numeric(word(name, 2, sep = " "))) %>% 
  arrange(year, month_num) 

routine_first <- slice_head(routine_case_a1, n = 1) %>% 
  pull(name)

routine_last <- slice_tail(routine_case_a1, n = 1) %>% 
  pull(name)


case_name <- word(here("routine_data", "cas_confirme_02_27_25.xlsx"), -1, sep = "/")

data_tab <- tibble(`Data set` = c("Epidemiological line list", 
                                  "Laboratory line list", 
                                  "Confirmed malairia cases--DHIS2"), 
                   `File name` = c(line_name, lab_name, 
                                   case_name), 
                   `Earliest observation` = c(line_first, lab_first, 
                                              routine_first), 
                   `Most recent observation` = c(line_last, lab_last, 
                                                 routine_last), 
                   `Number observations` = c(nrow(data), nrow(lab), 
                                             nrow(routine_case_a1))) %>% 
  flextable::flextable() %>% 
  flextable::autofit()

```

Data availability and quality limits the conclusions that can be drawn
from these analyses. Basic characteristics of data analyzed are provided
in the table below.

```{r echo = FALSE}

data_tab

```

Most individuals in the epidemiological line list exhibited both cough and fever
and a positive RDT for malaria. Case fatality rates were highest in those 
with a 'malaria unknown' status common in the early weeks of the event; those
with information on malaria testing and treatment exhibited better outcomes 
across all age groups and presenting facilities, though deaths were concentrated
in only a subset of receiving facilities.

Laboratory results for respiratory pathogens were unable to be reliably matched
to epidemiological data to glean the impact of influenza testing on patient 
outcomes. Clinical diagnoses provided in the epidemiological line list appeared
inconsistent and were not used in analyses; RDT results and presentation with 
the combination of cough and fever were used instead to denote malaria and 
respiratory illness. Note that given the degree of malaria transmission in the 
area, it is likely that not all those testing positive by RDT had an active
malaria infection at the time of presentation (pfHRP2 is detectable in the blood 
for approximately one month after clearing the infection), but additional 
information from each patient on recently diagnosed and treated malaria 
infections is not available.

Routine data from DHIS2 demonstrated significant issues with completeness. 
However, some facilities did report an unusually high number of confirmed 
malaria cases during the period under investigation. Trends were examined using
imputation for missing values and results at each facility should be 
individually examined with care. Note that many facilities reported an elevated
number of cases _after_ this event had brought significant attention to area, 
likely signaling an increased testing/reporting rate rather than a true causative
increase in transmission. Additionally, comparison of the line list to routine
data show inconsistencies in monthly totals when both are available. This 
underscores the incompleteness of the epidemiological line list. There are many 
people reported with confirmed malaria that are missing from the 
line list, and presumably even more with fever/suspected malaria that would 
qualify based on the case definition used. This can also be seen when examining
the geographic spread of cases on the line list; in such a highly malaria 
endemic area, all facilities likely have individuals reporting with fever every
week. Though expected, it is important to note as the case fatality rate is 
based on totals from the epidemiological line list, which is almost certainly 
inflated.

Not captured in these analyses are anecdotes explaining how the event was 
initially mistakenly flagged as an unknown illness. This 

Top-line recommendations for the remainder of this event and for potential 
similar occurrences in the future include: 

* Reported data should be routinely reviewed by a data manager to assess for 
errors so that they may be corrected in near real-time. Data cleaning after the
fact is not able to correct issues when the logical/probable intent of the 
data collector cannot be determined, resulting in loss of some information.

* Additional data for all patients would be useful, notably linked laboratory 
data and recent past medical history (malaria diagnosis/treatment and influenza
or other respiratory diseases vaccination status). Clinical diagnoses in the 
field are not reliable and diagnostic assays results linked to patient outcomes 
may allow at-risk individuals to be targeted for additional care. A more in-depth
investigation is needed, particularly for those patients that passed away from 
the illness.

* Ancillary information on how many teams are active in the area of interest and
where would be helpful to interpret temporal evolution of the event. Given the
ubiquitous presentation of the disease of interest in a highly malaria endemic
area, the number of individuals in the epidemiological line list is likely to be
influenced by magnitude of field efforts rather than a pure indicator of 
outbreak evolution.

* In-depth review of health facility data and case management practices at 
targeted facilities may provide clarity on why certain facilities exhibited a 
much higher case fatality rate than others. It also may serve as an opportunity 
to obtain improved routine surveillance data and help answer the question of 
whether an increased malaria transmission may have played a role. 

## **Introduction**

In November 2024, reports of an unknown illness in Panzi, a health zone
in the Democratic Republic of the Congo (DRC), including an alarming
number of deaths concentrated in children under five, raised global
alerts. Given the high mortality rate of the outbreak and the country’s
history with outbreaks of highly pathogenic diseases such as Ebola, an
emergency response was established to further investigate this outbreak
and mitigate its impact. Rather than a novel pathogen, the outbreak was
linked to malaria, along with other potential contributors, including
malnutrition and respiratory infections.

In early January 2025, CDC’s malaria subject-matter experts arrived in
country to assist the Ministry of Health with the analysis of data to
inform ongoing response activities to prevent further spread and death
attributed to the outbreak.

DRC is highly endemic for malaria, nationally accounting for the second
greatest number of estimated cases in Africa in 2023 per the World
Malaria Report. All residents are considered at risk for malaria
infection; though incidence is more seasonal in some areas than others,
no portion of the country is spared. Modeled 2022 *Plasmodium
falciparum* (Pf) incidence estimates from the [Malaria Atlas
Project](https://malariaatlas.org/) and Pf prevalence estimates in
children under five years from the [2023 Demographic and Health
Survey](https://dhsprogram.com/methodology/survey/survey-display-597.cfm)
are provided below. A mask illustrating the location of Panzi is may be
added or removed. The blue icon denotes the location of the capital city
of Kinshasa.

```{r include=FALSE}


pf_inc22 <- raster(here("202406_Global_Pf_Incidence_Rate_COD_2022.tiff"))
# pop_dens <- raster(here("cod_general_2020.tif"))

 drc_sf <- getShp(ISO = "COD") %>% 
   st_as_sf()
# 
# sf::st_write(drc_sf, here("spatial", "drc_nat.shp"))

drc_sf <- sf::st_read(here("spatial", "drc_nat.shp"))

geo_codes_dhis2 <- rio::import("C:/Users/omp2/OneDrive - CDC/mgd/drc/geoFeatures_2025-01-19.rds")

drc_prov <- geo_codes_dhis2 %>% 
  sf::st_drop_geometry() %>% 
  filter(levelName == "Province (DPS)") %>% 
  mutate(name = str_remove_all(name, " Province"), 
         name = str_remove(name, paste0(word(name, 1, sep = " "), " "))) %>% 
  left_join(rio::import("drc_prev_provence.xlsx"), by = c("name" = "prov")) %>% 
  mutate(prev = as.numeric(str_replace_all(prev, ",", "."))) %>% 
  sf::st_as_sf()

zds <- geo_codes_dhis2 %>% 
  sf::st_drop_geometry() %>% 
  filter(levelName == "Zone de Sante" & str_detect(name, "Panzi")) %>% 
  sf::st_as_sf()


diff <- st_difference(drc_sf, zds) 


# name as 'Panzi Zone de Santé'

health_area <- geo_codes_dhis2 %>% 
  sf::st_drop_geometry() %>% 
  filter(str_detect(parentName, "Panzi")) %>% 
  filter(!str_detect(parentName, "^sk")) %>% 
  filter(levelName != "Formation Sanitaire (FOSA)") %>% 
  sf::st_as_sf()


fs <- geo_codes_dhis2 %>% 
  sf::st_drop_geometry() %>% 
  filter(parentName %in% health_area$name) %>% 
  mutate(highlight = case_when(name %in% c("kg Panzi Hôpital Général de Référence",
                                           "kg Kabeya Mbamba Centre de Santé", 
                                           "kg Mwini Ngulu Centre de Santé") ~ "color", 
                               .default = "non")) %>% 
  sf::st_as_sf()

fs1 <- geo_codes_dhis2 %>% 
  sf::st_drop_geometry() %>% 
  filter(parentName %in% health_area$name) %>%
  filter(name %in% c("kg Panzi Hôpital Général de Référence",
                                           "kg Kabeya Mbamba Centre de Santé", 
                                           "kg Mwini Ngulu Centre de Santé")) %>% 
  sf::st_as_sf()



a <- tm_shape(zds)+
  tm_borders()+
  tm_shape(fs)+
  tm_dots(col = "highlight", 
          palette = c("firebrick4", "cadetblue4"), 
          size = 0.8)+
  tm_text("name")+
  tm_layout(frame = FALSE, 
            legend.show = FALSE)

a <- tm_shape(zds)+
  tm_borders()+
  tm_shape(fs1)+
  tm_dots()+
  tm_text("name")+
  tm_layout(frame = FALSE, 
            legend.show = FALSE)

tmap_save(tm = a, filename = here::here("mb_presentation", "hf_map.png"), 
          dpi = 700, 
          width = 6, 
          height = 4, units = "in")


al1 <- colorFactor(c(ochRe::ochre_palettes[["nolan_ned"]][[4]], 
                      ochRe::ochre_palettes[["nolan_ned"]][[5]]), domain = c(1, 2))



at <- c(0, seq(0.2,0.6,0.05), 1)
cb <- colorBin(palette = "inferno", bins = at, domain = at, 
               na.color = NA)

 bins <- seq(0, 100, 10)
 pal <- colorBin("YlOrRd", domain = drc_prov$prev, bins = bins)

 
kin <- sf::st_as_sf(tibble(lat = -4.346703, 
              long = 15.307295), 
              coords = c("long", "lat"), 
              crs = 4326)

cheat_codes <- rio::import(here::here("routine_data", "tests_done.xlsx"))

tests_done <- cheat_codes %>% 
  distinct(dataid, dataname) %>% 
  mutate(dataname = str_replace_all(dataname, "Ã©", "é"))

commodity_codes <- rio::import(here::here("routine_data","commodity_data_labels.xlsx"))%>% 
  mutate(dataname = str_replace_all(dataname, "Ã©", "é"))
  

dhis2_data <- tibble(data = c(rep("Confirmed Cases", 8), 
                              rep("Tests Performed", 7), 
                              rep("Commodities", 26)), 
                     name = c("A 1.4 TDR positif 2 - < 5 ans",
                              "A 1.4 TDR positif < 2 ans",
                              "A 1.4 TDR positif <5 ans",
                              "A 1.4 TDR positif >=5 ans",
                              "A 1.4 TDR positif >=5 ans",
                              "B 10.2 TDRs réalisés au SSC Dont positifs <5 ans",
                              "B 10.2 TDRs réalisés au SSC Dont positifs >=5 ans",
                              "D 5.3 Frottis réalisé dont Frottis positif - Examens positifs", tests_done$dataname, commodity_codes$dataname), 
                     id = c("SpmQSLRPMl4.xxMINnPGqUg",
                            "SpmQSLRPMl4.xCV9NGB897u",
                            "SpmQSLRPMl4.yI0WfOFcgSc",
                            "SpmQSLRPMl4.r5lWfJh2t2l",
                            "SpmQSLRPMl4.brxxCYkQqcd",
                            "IPnqGkUUN6U.yI0WfOFcgSc",
                            "IPnqGkUUN6U.brxxCYkQqcd",
                            "G93aSUKfKgi", 
                            tests_done$dataid, 
                            commodity_codes$dataid) 
                     ) %>% 
  flextable::flextable() %>% 
  flextable::autofit()


locations <- cheat_codes %>% 
  select(c(1:3)) %>% 
  distinct(organisationunitid,
           organisationunitname,
           organisationunitcode) %>% 
  mutate(across(everything(), ~str_replace_all(.x, "Ã©", "é")), 
         across(everything(), ~str_replace_all(.x, "Ã´", "ô"))
  )

locations_button <- locations %>% 
 downloadthis::download_this(
    output_name = "dhis2_locations_panzi",
    output_extension = ".xlsx",
    button_label = "Location information",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```

```{r out.width= 700, out.height = 700}

leaflet::leaflet() %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addMapPane("base", zIndex = 410) %>% 
  addMapPane("top", zIndex = 420) %>% 
  addRasterImage(pf_inc22, colors = cb, 
                 opacity = 0.8,
              group = "MAP Incidence 2022") %>% 
  addPolygons(
    data = drc_prov, 
    stroke = TRUE,
    fillColor = ~pal(prev), fillOpacity = 1, smoothFactor = 0.5,
    color = "black", opacity = 1, weight = 0.5, 
    options = pathOptions(pane = "base"),
    group = "Prevalance (RDT) DHS 2023") %>% 
#  addRasterImage(pop_dens, colors = cb,
#              group = "Population density") %>% 
  addPolygons(
    data = diff, 
    stroke = TRUE, fillColor = "azure4", fillOpacity = 0.8, smoothFactor = 0.5,
    color = "black", opacity = 1, weight = 0.8, 
    options = pathOptions(pane = "top"),
    group = "Panzi Health Zone Mask") %>% 
  addPolygons(
    data = drc_sf, 
    stroke = TRUE, fillOpacity = 0, smoothFactor = 0.5,
    color = "black", opacity = 1, weight = 2) %>% 
  addMarkers(data = kin) %>% 
    addLayersControl(baseGroups = c("MAP Incidence 2021",
                                    "Prevalance (RDT) DHS 2023"),
                       overlayGroups = "Panzi Health Zone Mask", 
               options = layersControlOptions(collapsed = F))


```

## **Data cleaning** {.tabset .tabset-pills}

This tab exists to provide transparency and reproducibility of all subsequent
analyses. None of the data provided by the DRC MOH (either the response team
or via DHIS2) are altered without documentation here. Many changes are shown
via downloadable Excel files. (These buttons have been disabled for partners 
outside of the MOH that may be interested in results, but were not granted 
direct data access.)

Many portions of this tab will not be of interest unless a deeper understanding
of how data were handled is needed.


Line list data (file name *`r line_name`*) contains `r nrow(data)`
observations, the most recent of which is dated `r line_last`.

Lab data (file name *`r lab_name`*) contains `r nrow(lab)` observations,
the most recent of which is dated `r lab_last`.

DHIS2 data contains `r nrow(routine_case_a1)` observations, the most distant of
which is from `r routine_first` and the most recent is from `r routine_last`. 

Information on the data elements pulled from DHIS to generate aggregate 
indicators is listed below. Identifying information for reporting 
units/geographies is provided in the downloadable Excel file.

```{r echo = FALSE}

dhis2_data

```


```{r echo=FALSE}

locations_button

```



### Data missingness

The number of missing observations for each variable recorded in the
epidemiological line list are presented in the downloadable Excel file below.

```{r}

b <- map(names(data), 
         function(.x){x = sym(.x)
         data %>% 
           filter(is.na({{x}}))
         }
)

missing_obs <- map(b, ~nrow(.x)) %>% 
  as_vector() %>% 
  as_tibble() %>% 
  add_column(Variable = names(data), 
             .before = 1) %>% 
  rename(`Observations Missing` = value) %>% 
  filter(Variable != "id")

missing_dl <- missing_obs %>% 
 downloadthis::download_this(
    output_name = "missing_obs_number",
    output_extension = ".xlsx",
    button_label = "Missing Observations",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

  
```

```{r echo=FALSE}
missing_dl
```

### Spelling changes

Basic formatting and spelling changes are coded here. Explore code to
review changes made, along with the Excel file below.

```{r}


data_1a <- data %>% 
  mutate(tratement = str_replace_all(tratement, c("vit_c" = "vitc",
                                                  "vitce" = "vitc_vite",
                                                  "vit_ce" = "vitc_vite",
                                                  "vitace" = "vitc_vite",
                                                  "vita_c" = "vitc",
                                                  "vitac" = "vita_vitc", 
                                                  "vit_b12" = "vitb12",
                                                  "vit_b6" = "vitb6",
                                                  "at_60" = "at60", 
                                                  "para_injct" = "para-inject", 
                                                  "paracetamol_injct" = "para-inject",
                                                  "parainject" = "para-inject",
                                                  "para_inject" = "para-inject",
                                                  "para_inj" = "para-inject",
                                                  "acide_folique" = "acide-folique", 
                                                  "para" = "paracetamol", 
                                                  "artesunate_inj" = "artesunate-inj")
                                     )
  )# there will be an issue with entries containing multiple words as 
   # single entry when go to change pull individuals from these lists


data_char <- data_1a %>% 
  select(where(is.character)) %>% 
  select(-c(nom_et_postnom))

entered_values <- map(names(data_char), 
                      function(x){data_char %>% 
                          pull({{x}}) %>% 
                          unique()
                      }) %>% 
  set_names(names(data_char)) %>% 
  map(~as.data.frame(unlist(.x))
      )%>% 
  list_rbind(names_to = "variable") %>% 
  rename(entry = 2) %>% 
  arrange(variable, entry)

# uncomment below if need to update list of entries requiring spelling changes

#rio::export(entered_values, file = "entered_free_text.xlsx")

# spelling changes made and saved to separate file 'entered_free_text_with_spelling_change.xlsx'

spelling_changes <- rio::import("entered_free_text_with_spelling_change.xlsx") %>% 
  filter(!is.na(change_to))

data1b <- data_1a %>% 
  linelist::clean_variable_spelling(wordlists = spelling_changes,
                                    from = 2, 
                                    to = 3, 
                                    spelling_vars = 1) %>% 
  mutate(duration_symp_consult = lubridate::time_length(interval(date_debut_des_signes,
                                                                 date_de_consultation), 
                                                        "days"))

test <- data1b %>% 
  filter(duration_symp_consult < 0 |duration_symp_consult >34 ) %>% 
  select(n, duration_symp_consult, date_de_notification,
         date_debut_des_signes, date_de_consultation) %>% 
  mutate(across(c(3:5), ~as.character(.x)))


rio::export(test, "date_issues.xlsx")

date_change <- rio::import("date_issues1.xlsx")

data1 <- data1b %>% 
  left_join(date_change, by = "n") %>% 
  mutate(debut_change = as.Date(debut_change), 
         consultation_change = as.Date(consultation_change),
         date_debut_des_signes = case_when(!is.na(debut_change)~ debut_change, 
                                             .default = date_debut_des_signes.x), 
         date_de_consultation = case_when(!is.na(consultation_change)~ consultation_change, 
                                            .default = date_de_consultation.x), 
         date_de_notification = date_de_notification.x) %>% 
  select(-c(duration_symp_consult.x, date_debut_des_signes.x, date_de_consultation.x, 
            date_de_notification.x,
            duration_symp_consult.y, date_debut_des_signes.y, date_de_consultation.y, 
            date_de_notification.y)) %>% 
  mutate(duration_symp_consult = lubridate::time_length(interval(date_debut_des_signes,
                                                                 date_de_consultation), 
                                                        "days"))


data2 <- data1 %>%  
  mutate(age_unit = word(age, sep = "_", -1), 
         age1 = str_remove_all(age, paste0("_", age_unit)), 
         age2 = as.numeric(str_replace_all(age1, "_", "\\.")),
         age_years = case_when(age1 == "2ans" ~ 2, 
                               age1 == "4" ~ 4, 
                               age1 == "8_ans" ~ 8, 
                               age1 == "3mois" ~ 3/12,
                               age1 == "1omois" ~ 1/12, 
                               age1 == "18mois" ~ 18/12, 
                               age1 == "7mois" ~ 7/12, 
                               age1 == "1an" ~ 1,
                               age1 == "1ans" ~ 1,
                               age1 == "8ans" ~ 8,
                               age1 == "4_1_2" ~ 4.5, 
                               age1 == "3_ans_11" ~ 3+11/12,
                               age1 == "1_1_2" ~ 1.5,
                               age1 == "2_1_2" ~ 2.5,
                               age1 == "4_1_2" ~ 4.5,
                               age1 == "9mois" ~ 9/12,
                               age1 == "38a" ~ 38,
                               age_unit %in% c("m", "mois", "mos") ~ age2/12, 
                               age_unit %in% c("semaine", "semaines") ~ age2/52,
                               age_unit %in% c("ans", "asns", "an", "nas") ~ age2, 
                               .default = 999), 
         week = tsibble::yearweek(date_de_notification),
         paludisme_1 = case_when(paludisme == "palu" ~ "oui", 
                                 .default = paludisme), 
         tdr1 = case_when(tdr == "non.rensegne" ~ NA, 
                          .default = tdr)
         )

spell1 <- spelling_changes %>% 
 downloadthis::download_this(
    output_name = "panzi_spelling_change1",
    output_extension = ".xlsx",
    button_label = "Spelling Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```

```{r echo=FALSE}

spell1

```

### Duplicates

```{r}

rm(spell1)

####################################  search for duplicates using fuzzy matching
#### NOT complete as of 26 January, 2025. Response leadership to weigh in ######

# ensure Id provided is unique identifier
#  Hmisc::describe(data2$n)

data_dup <- data2 %>% 
  dplyr::select(date_de_notification, 
                name = nom_et_postnom,
                as, 
                sexe,
                age, 
                n) %>% 
  mutate(n = as.numeric(n)) %>% 
  full_join(., ., by = character()) %>% 
  filter(n.x < n.y) %>% 
  mutate(
    name.dist = stringdist(name.x, name.y), 
    as_same = as.x == as.y, 
    duration = lubridate::time_length(interval(date_de_notification.x, 
                                               date_de_notification.y), 
                                      "day")) %>% 
  filter(name.dist < 3) %>% 
  select(
    name.dist, 
    name.x, name.y, 
    sexe.x, sexe.y,
    date_de_notification.x, date_de_notification.y, 
    jours = duration, 
    as_same, as.x, as.y, 
    n.x, n.y) %>% 
  mutate(id_to_discard = NA) %>% 
  arrange(name.dist, jours, as_same)
  



# for manual examination
rio::export(data_dup, "doublants_possibles.xlsx")

doublants_vrai <- rio::import("doublants_possibles_vrai.xlsx")

data3 <- data2 %>% 
  filter(!n %in% doublants_vrai$id_to_discard)

dupes <- filter(doublants_vrai, !is.na(id_to_discard)) %>% 
 downloadthis::download_this(
    output_name = "panzi_dupes",
    output_extension = ".xlsx",
    button_label = "Duplicates",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```

A total of `r nrow(filter(doublants_vrai, !is.na(id_to_discard)))`
duplicates were removed, leaving a total of `r nrow(data3)`
observations.

```{r echo=FALSE}

dupes

```

### Processing complication and treatment data

These data are entered as free text. Here they are standardized and
processed so as to be more useable. New variables for "any artemisinin
received", "any antimalarial received" (artemisinin or quinine), and
"any antibiotic received" are created.

```{r}


datatx <- data3 %>% 
  select(n, tratement) %>% 
  mutate(tx_list = str_split(tratement, "_")) %>% 
  filter(!is.na(tx_list)) %>% 
  unnest_longer(tx_list)

datatx_unique <- datatx %>% 
  select(tx_list) %>% 
  distinct(tx_list) %>% 
  arrange(tx_list)

rio::export(datatx_unique, "linelist/output/tratement_sp.xlsx")

treatment_spelling <- rio::import(here::here("linelist", 
                                             "output", 
                                             "tratement_sp_edit.xlsx")) %>% 
  filter(!is.na(change_to))

datatx_sp <- datatx %>% 
  left_join(treatment_spelling, by = "tx_list") %>% 
  mutate(tx_list_sp = case_when(!is.na(change_to)~ change_to, 
                                .default = tx_list)) %>% 
  select(n, tx_list = tx_list_sp) %>% 
  filter(tx_list != "rm") %>% 
  group_by(n) %>% 
  arrange(tx_list, .by_group = TRUE) %>% 
  ungroup() %>% 
  filter(!str_detect(tx_list, "^\\d")) 

treatment_list <- datatx_sp %>% 
  group_by(n) %>% 
  summarise(tx = list(tx_list)) %>%
  rowwise() %>% 
  mutate(tx1 = paste(unlist(tx), collapse = "_"))



#unique(datatx_sp$tx_list)

data4 <- left_join(data3, treatment_list, by = "n") %>% 
  select(-tratement) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(any_artemisinins_a = list(map(c("act", 
                                          "artesunate",
                                          "aretesunate.rectal", 
                                          "asaq", 
                                          "artemether"),
                                        function(x) str_detect(tx1, fixed(x)))),
         any_artemisinins = any(any_artemisinins_a == TRUE),
         any_antimalarial = case_when(any_artemisinins == TRUE | str_detect(tx1, "quinine") ~ TRUE, 
                                      .default = FALSE),
         any_abx_a = list(map(c("amoxicilline", 
                                "azithromycine", 
                                "ceftriaxone", 
                                "erytromycine",
                                "bactrim",
                                "genta"),
                              function(x) str_detect(tx1, fixed(x)))),
         any_abx_b = any(any_abx_a == TRUE), 
         any_abx = case_when(any_abx_b == TRUE ~ TRUE,
                             .default = FALSE),
         complications = str_replace_all(complications, "broncho_pulmonaire", 
                                         "broncho.pulmonaire"))

#Hmisc::describe(data4$any_artemisinins)

# data4$any_artemisinins 
#        n  missing distinct 
#     3418     1448        2 
#                       
# Value      FALSE  TRUE
# Frequency    582  2836
# Proportion  0.17  0.83

#Hmisc::describe(data4$any_antimalarial)

# data4$any_antimalarial 
#        n  missing distinct 
#     4866        0        2 
#                       
# Value      FALSE  TRUE
# Frequency   2023  2843
# Proportion 0.416 0.584

data_comp <- data4 %>% 
  select(n, complications) %>% 
  mutate(list = str_split(complications, "_")) %>% 
  filter(!is.na(complications)) %>% 
  unnest_longer(list)


data_comp_unique <- data_comp %>% 
  select(list) %>% 
  distinct(list) %>% 
  arrange(list)

rio::export(data_comp_unique, "linelist/output/complications_sp.xlsx")

complications_spelling <- rio::import(here::here("linelist", 
                                             "output", 
                                             "complications_sp_edit.xlsx")) %>% 
  filter(!is.na(change_to))



data_comp_sp <- data_comp %>% 
  left_join(complications_spelling, by = "list") %>% 
  mutate(comp_list_sp = case_when(!is.na(change_to)~ change_to, 
                                .default = list)) %>% 
  select(n, list = comp_list_sp) %>% 
  filter(list != "rm") %>% 
  group_by(n) %>% 
  arrange(list, .by_group = TRUE) %>% 
  ungroup() %>% 
  filter(!str_detect(list, "^\\d")) 

comp_list <- data_comp_sp %>% 
  group_by(n) %>% 
  summarise(comp = list(list)) %>%
  rowwise() %>% 
  mutate(tx1 = paste(unlist(comp), collapse = "_"))

#unique(data_comp_sp$list)

data5 <- left_join(data4, comp_list, by = "n") %>% 
  ungroup() %>% 
  mutate(malnutrition = case_when(str_detect(autres_diagnostics, "malnutrition|mas")|str_detect(autres_signes, "amaigrissement|mas")|str_detect(complications, "malnutrition|mas|amaigrissement") ~ "malnutrition", 
                                  .default = "no"))

#  Hmisc::describe(data5$malnutrition)
#  
#  data5$malnutrition 
#         n  missing distinct 
#      4866        0        2 
#                                      
#  Value      malnutrition           no
#  Frequency            73         4793
#  Proportion        0.015        0.985
#  

comp_spell_dl <- complications_spelling %>% 
 downloadthis::download_this(
    output_name = "complication_spell_changes",
    output_extension = ".xlsx",
    button_label = "Complications Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")


tx_spell_dl <- treatment_spelling %>% 
 downloadthis::download_this(
    output_name = "treatment_spell_changes",
    output_extension = ".xlsx",
    button_label = "Treatment Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```

```{r echo = FALSE}

tx_spell_dl
comp_spell_dl

```

### Processing location data

```{r}
village <- data2 %>% 
  dplyr::distinct(as, village_quartier) %>% 
  arrange(as, village_quartier) %>% 
  split(.$as) %>% 
  map(~.x %>% 
        mutate(id = row_number()) %>% 
        powerjoin::power_left_join(., ., 
                           by = c(~ stringdist::stringdist(.x$village_quartier, 
                                                                     .y$village_quartier) < 3),
                           keep = "both"
                           ) %>% 
        janitor::get_dupes(id.x) %>% 
        mutate(same = village_quartier.x == village_quartier.y) %>% 
        filter(same == FALSE, 
               id.x < id.y) %>% 
        select(-c(same,as.y, as.x, dupe_count, id.x, id.y))
      ) %>% 
  list_rbind(names_to = "as")

rio::export(village, "village_rename.xlsx")

village_sp <- rio::import("village_rename_1.xlsx") %>% 
  select(-change_name_of_x_to) %>% 
  filter(!is.na(change_name_of_y_to)) %>% 
  distinct(as, village_quartier.y, change_name_of_y_to)

data5_b <- data5 %>% 
  mutate(join_id = row_number()) %>% 
  left_join(village_sp, by = c("as", "village_quartier" = "village_quartier.y"), 
            keep = TRUE) %>% 
  mutate(change_name_of_y_to = case_when(is.na(change_name_of_y_to) ~ village_quartier, 
                                        .default = change_name_of_y_to))

village_sp_out <- data5_b %>% 
  group_by(change_name_of_y_to) %>% 
  mutate(pseudonyms = list(village_quartier.y)) %>% 
  unnest_longer(pseudonyms) %>% 
  filter(!is.na(pseudonyms)) %>% 
  distinct(as.x, change_name_of_y_to, pseudonyms) %>% 
  select(`Aire de Sante` = as.x, 
         Nom = change_name_of_y_to, 
         `Autre noms` = pseudonyms)

village_spell_dl <- village_sp_out %>% 
 downloadthis::download_this(
    output_name = "village_spell_changes",
    output_extension = ".xlsx",
    button_label = "Village Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

data5_c <- data5_b %>% 
  mutate(village_quartier = case_when(!is.na(change_name_of_y_to) ~ change_name_of_y_to,
                                      .default = village_quartier)) 


test <- data5_b %>% 
  group_by(as.x) %>% 
  summarise(n_vill_og = map(list(unique(village_quartier, na.rm = TRUE)), length))
 
data5_c %>% 
  group_by(as.x) %>% 
  summarise(n_vill_fix = map(list(unique(village_quartier, na.rm = TRUE)), length)) %>% 
  ungroup() %>% 
  left_join(test, b = "as.x") %>% 
  rename(`Aire de Sante` = as.x, 
         `Nombre de villages` = n_vill_fix, 
         `Nombre de villages\n(avant netoyage)` = n_vill_og) %>% 
  mutate(`Aire de Sante` = str_to_sentence(str_replace_all(`Aire de Sante`, "\\.", 
                                                           " ")), 
         `Nombre de villages` = as.character(`Nombre de villages`), 
         `Nombre de villages\n(avant netoyage)` = as.character(`Nombre de villages\n(avant netoyage)`)) %>% 
  flextable::flextable() %>% 
  flextable::autofit()

```

```{r echo = FALSE}

village_spell_dl

```

## **Presentation and outcomes** {.tabset .tabset-pills}

Additional information on patient presentation is provided in subsequent
sections. This portion serves to ensure that all individuals included in
the data set meet the case definition.

### Counts of individual symptoms

```{r}

data5 <- data5_c
symptoms <- data5 %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", "\n")),
         name = case_when(name == "Douleurs\nAu\nBas\nVentre" ~ "Douleurs\nau bas\nVentre", 
                          .default = name),
         name = fct_reorder(name, -count)) %>% 
  arrange(name)

ggplot(symptoms)+
  geom_col(aes(x = name, y = count))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Symptom", 
       y = "Count")
  

```

### Symptom combinations, clinical diagnoses and case fatality rate

**A** Upset plot of most common symptom combinations. Bar chart at the
top represents case counts of the symptom combinations indicated by
points below (individual symptoms present are indicated by black point).
**B** Heatmap indicating the diagnoses listed for those with the symptom
combinations above. Darker colors indicate a higher proportion of those
with the symptom combination being listed with the respiratory diagnosis
(black = 100%, white = 0%). **C** Malaria RDT test positivity rate among
those with above symptom combinations who were tested for malaria. Those
without RDT results are excluded. **D** Case fatality rates of those
presenting with above symptom combination. The black bar is the overall
case fatality rate; red bars represent the case fatality rate for those
with a positive RDT; green bars represent the case fatality rate for
those with a negative RDT; white bars represent the case fatality rate
for those that do not have RDT information (and presumably were not
tested for malaria).

```{r}

symptom_combo_upset_a <- data5 %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list = list(name)) %>% 
  ungroup() %>% 
  group_by(list) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  group_by(list) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  mutate(list_sx_1 = factor(map_chr(list, paste, collapse = ", ")),
         list_sx_1 = fct_reorder(list_sx_1, -count)) %>% 
  group_by(list) 

  
symptom_combo_upset <- symptom_combo_upset_a %>% 
  filter(id <= 20)



cols <-  c("fievre", "toux", "rhinorrhee", "dyspnee", 
                       "asthenie_physique", "courbatures",
 "cephalee", "frisson", "anorexie", "vomissement", "douleurs_abdominales",
 "diarrhee",  "douleurs_generalisees",   "lombalgie",  "douleurs_au_bas_ventre", 
 "douleurs_costales", "douleurs_testiculaires")

cols2 <- c("grippe", "bronchite", "ira", "syndrome_grippal",
           "pneumonie","broncho_pneumonie")


heatmap_dx_a <- data5 %>% 
  select(n, cols) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  summarise(list_sx = list(name)) %>% 
  ungroup() %>% 
  left_join(data5, by = "n") %>% 
  group_by(list_sx) %>% 
  summarise(across(cols2, 
                ~sum(.x == "oui", na.rm = TRUE)/(sum(.x == "oui", na.rm = TRUE) + 
                                                   sum(.x == "non", na.rm = TRUE)))) %>% 
  ungroup() %>% 
  pivot_longer(-1)

dx_single <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " ")), 
         name = case_when(name == "Ira" ~ "IRA", 
                          .default = name)) %>% 
  arrange(-count)
  
heatmap_dx <- heatmap_dx_a  %>% 
  mutate(list_sx_1 = factor(map_chr(list_sx, paste, collapse = ", "), 
                          levels = unique(symptom_combo_upset_a$list_sx_1)), 
         name = str_to_sentence(str_replace_all(name, "_", " ")), 
         name = case_when(name == "Ira" ~ "IRA", 
                          .default = name),
         name = factor(name, levels = rev(dx_single$name)))

heatmap_dx_graph <- heatmap_dx %>% 
  filter(list_sx_1 %in% symptom_combo_upset$list_sx_1)


symptom_other <- symptom_combo_upset_a %>% 
  left_join(select(data5, n, evolution, tdr), by = "n")

tpr_cfr_by_presentation <- symptom_other %>% 
  group_by(list_sx_1) %>% 
  summarise(tpr = 100*sum(tdr == "positif", na.rm = TRUE)/(sum(tdr == "positif", na.rm = TRUE)+
                                                         sum(tdr == "negatif", na.rm = TRUE)),
            cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  ) %>% 
  ungroup() 

tpr_cfr_by_presentation_strat <- symptom_other %>% 
  group_by(list_sx_1)%>% 
  mutate(tdr = factor(case_when(is.na(tdr) ~ "non.rensegne", 
                         .default = tdr), 
                      levels = c("positif", 
                                 "negatif", 
                                 "non.rensegne"))) %>% 
  group_by(list_sx_1, tdr) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )



tpr_cfr_by_presentation_graph <- tpr_cfr_by_presentation %>% 
  filter(list_sx_1 %in% symptom_combo_upset$list_sx_1) 

tpr_cfr_by_presentation_strat_graph <- tpr_cfr_by_presentation_strat %>% 
    filter(list_sx_1 %in% symptom_combo_upset$list_sx_1) 

top <- ggplot(symptom_combo_upset)+
  geom_bar(aes(x = list))+
  scale_x_upset(n_intersections = 20)+
  labs(x = element_blank(), 
       y = "Count")

heat <- ggplot(heatmap_dx_graph)+
  geom_tile(aes(x = list_sx_1, y = name, fill = value))+
  scale_fill_gradient(low = "white", high = "black")+
  theme(legend.position = "none",
        axis.text.x=element_blank())+
  labs(x = element_blank(), 
       y = "Clinical Diagnosis")

tpr_graph <- tpr_cfr_by_presentation_graph %>% 
  ggplot()+
  geom_col(aes(x = list_sx_1, 
               y = tpr), color = "black")+
  theme(axis.text.x=element_blank())+
  labs(x = element_blank(), 
       y = "RDT Test positivity (%)")

#devtools::install_github("wilkelab/ungeviz")

cfr_graph <-  ggplot()+
  geom_col(data = tpr_cfr_by_presentation_strat_graph, aes(x = list_sx_1, 
               y = cfr, 
               fill = tdr, 
               group = tdr), 
           color = "black", 
           position = position_dodge2(width = 0.9, preserve = "single"))+
  scale_fill_manual(values = c("firebrick4", 
                               "cadetblue4", 
                               "white"))+
  ungeviz::geom_hpline(data = tpr_cfr_by_presentation_graph, aes(x = list_sx_1, 
               y = cfr), 
           color = "black")+
  theme(axis.text.x=element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Case Fatality Rate (%)")

a <- cowplot::plot_grid(top, heat,  NULL, tpr_graph, NULL,
                   cfr_graph, 
                   ncol = 1, 
                   labels = c("A", "B", "", "C", "","D"),
                   rel_heights = c(1,1, -0.5, 1,-0.5, 1),
                   align = "hv", 
                   axis = "tblr")

ggsave(a, filename = here::here("output", "presentation_combo_outcome.png"), 
       dpi = 700, 
       height = 11, 
       width = 6, 
       units = "in")


```

![](output/presentation_combo_outcome.png)

## **Diagnoses and outcomes** {.tabset .tabset-pills}

### Counts of individual clinical diagnoses

```{r}

prop_var <- c("bronchite", "ira", "grippe", "syndrome_grippal",
                 "pneumonie","broncho_pneumonie", "paludisme_1", "tdr")

dx <- data5 %>%
  mutate(autres_diagnostics = na_if(autres_diagnostics, "non")) %>% 
             group_by(across(all_of(prop_var))) %>% 
             summarise(count = n()) 



dx_dl <- dx %>% 
 downloadthis::download_this(
    output_name = "diagnoses",
    output_extension = ".xlsx",
    button_label = "Diagnoses",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")



dx <- data5 %>% 
  select(n, 29:35) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " ")),
         name = case_when(name == "Ira" ~ "IRA", 
                          .default = name),
         name = fct_reorder(name, -count)) %>% 
  arrange(name)

ggplot(dx)+
  geom_col(aes(x = name, y = count))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Diagnosis", 
       y = "Count")
  
```

Click the button below to download a summary file of combinations of
diagnoses and tests.

```{r echo = FALSE}

dx_dl

```

### Focus on Malaria {.tabset .tabset-pills}

Summary: Clinical determination of malaria infection does not appear to
be a reliable variable for analyses. HRP2-based rapid diagnostic tests
may overestimate prevalence of active infections in highly endemic areas
due to persistence of the antigen for 4 to 6 weeks after resolution of
the infection, but remains a more reliable indicator of infection than
clinical presentation alone. Future data collection efforts may benefit
from additional questions of all individuals with a positive RDT
documenting the history of recent malaria infection/treatment.

#### Permformance metrics of clinical classification in data set

```{r}


data5_a <- data5 %>% 
  mutate(decede_non = case_when(is.na(evolution) ~ NA_character_, 
                                evolution == "decede" ~ "decede", 
                                .default = "non_decede"), 
         age_cat1 = cut(age_years, c(0, 2, 5, 15, Inf)),
         age_cat2 = cut(age_years, c(0, 5, Inf)),
         age_cat3 = cut(age_years, c(0,2,5,15,25,35,45,55,65,Inf)),
         duration_symp_consult = lubridate::time_length(interval(date_debut_des_signes,
                                                                 date_de_consultation), 
                                                        "days"), 
         consult_pre_dec01 = case_when(date_de_consultation < "2024-12-01" ~ "pre_12_01", 
                                       date_de_consultation >= "2024-12-01" ~ "post_12_01", 
                                       is.na(date_de_consultation) ~ NA_character_, 
                                       .default = "error"), 
         year_week_factor = factor(paste(week), levels = unique(data2$week)),
         cough_fever = case_when(fievre == "oui" & toux == "oui" ~ "both", 
                                 fievre == "oui" & (toux == "non" | is.na(toux)) ~ "fever", 
                                 (fievre == "non" | is.na(fievre)) & toux == "oui" ~ "cough", 
                                 is.na(fievre) & is.na(toux) ~ "unknown",
                                 (fievre == "non" & is.na(toux)) | (is.na(fievre) & toux == "non") ~ "unknown",
                                 fievre == "non" & toux == "non" ~ "none",
                                 .default = "error"), 
         tdr1 = factor(case_when(is.na(tdr1) ~ "unknown",
                                 .default = tdr1), 
                       levels = c("unknown", 
                                  "negatif", 
                                  "positif"))
  )



metrics_overall <- data5_a %>% 
  group_by(paludisme_1, tdr1) %>% 
  summarise(counts = n()) %>% 
  ungroup()

temp <- metrics_overall %>% 
  filter(tdr1 != "unknown" & !is.na(paludisme_1)) %>% 
  group_by(tdr1) %>% 
  mutate(test_sums = sum(counts)) %>% 
  ungroup() %>% 
  group_by(paludisme_1) %>% 
  mutate(clin_sums = sum(counts)) %>% 
  ungroup() %>% 
  mutate(sens_spec = counts/test_sums, 
         ppv_npv = counts/clin_sums, 
         across(c(sens_spec, ppv_npv), ~round(100*.x, 1)))

sens <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), sens_spec)
sens_num <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), counts)
sens_den <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), test_sums)

spec <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), sens_spec)
spec_num <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), counts)
spec_den <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), test_sums)

ppv <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), ppv_npv)
ppv_num <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), counts)
ppv_den <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), clin_sums)

npv <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), ppv_npv)
npv_num <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), counts)
npv_den <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), clin_sums)

temp <- metrics_overall %>% 
  filter(tdr1 == "unknown" | is.na(paludisme_1)) 




tpr_weekly <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 != "unknown" & !is.na(paludisme_1)) %>% 
  group_by(tdr1, year_week_factor) %>% 
  mutate(test_sums = sum(counts)) %>% 
  ungroup() %>% 
  group_by(paludisme_1, year_week_factor) %>% 
  mutate(clin_sums = sum(counts)) %>% 
  ungroup() %>% 
  mutate(sens = ifelse(paludisme_1=="oui" & tdr1 == "positif", counts/test_sums,
                      NA), 
         spec = ifelse(paludisme_1=="non" & tdr1 == "negatif", counts/test_sums, 
                      NA),
         npv = ifelse(paludisme_1=="non" & tdr1 == "negatif", counts/clin_sums, 
                      NA),
         ppv = ifelse(paludisme_1=="oui" & tdr1 == "positif", counts/clin_sums, 
                      NA),
         across(c(sens,spec, ppv,npv), ~round(100*.x, 1))) %>% 
  filter((paludisme_1=="oui" & tdr1 == "positif") | (paludisme_1=="non" & tdr1 == "negatif")) %>% 
  pivot_wider(names_from = c("paludisme_1", "tdr1"), 
              values_from = c("counts", "test_sums", "clin_sums", 
                              "sens", "spec", 
                              "ppv", "npv")) %>% 
  janitor::remove_constant() %>% 
  arrange(year_week_factor) %>% 
  mutate(Sensitivity = paste0(sens_oui_positif, "% (", counts_oui_positif, "/", 
                              test_sums_oui_positif, ")"), 
         Specificity = paste0(spec_non_negatif, "% (", counts_non_negatif, "/", 
                              test_sums_non_negatif, ")"),
         PPV = paste0(ppv_oui_positif, "% (", counts_oui_positif, "/", 
                              clin_sums_oui_positif, ")"), 
         NPV = paste0(npv_non_negatif, "% (", counts_non_negatif, "/", 
                              clin_sums_non_negatif, ")")
  ) %>% 
  select(Week = year_week_factor, 
         Sensitivity, 
         Specificity, 
         PPV, 
         NPV) 




tpr_weekly_pos <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 == "positif") %>% 
  select(-tdr1) %>% 
  pivot_wider(names_from = "paludisme_1", 
              values_from = "counts") %>% 
  relocate(oui, .after = 1) %>% 
  rename(Week = year_week_factor, 
         `Paludisme clinique +` = oui, 
         `Paludisme clinique -` = non, 
         `Paludisme inconnu` = `NA`)

a <- sum(tpr_weekly_pos$`Paludisme clinique -`, na.rm = TRUE)

tpr_weekly_neg <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 == "negatif") %>% 
  select(-tdr1) %>% 
  pivot_wider(names_from = "paludisme_1", 
              values_from = "counts") %>% 
  relocate(oui, .after = 1) %>% 
  rename(Week = year_week_factor, 
         `Paludisme clinique +` = oui, 
         `Paludisme clinique -` = non)

b <- sum(tpr_weekly_neg$`Paludisme clinique -`, na.rm = TRUE)



tpr_weekly_unk <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 == "unknown") %>% 
  select(-tdr1) %>% 
  pivot_wider(names_from = "paludisme_1", 
              values_from = "counts") %>% 
  relocate(oui, .after = 1) %>% 
  rename(Week = year_week_factor, 
         `Paludisme clinique +` = oui, 
         `Paludisme clinique -` = non, 
         `Paludisme inconnu` = `NA`)

c <- sum(tpr_weekly_unk$`Paludisme clinique +`, na.rm = TRUE)+
  sum(tpr_weekly_unk$`Paludisme clinique -`, na.rm = TRUE)

flext_metrex <- reduce(list(tpr_weekly_pos, tpr_weekly_neg, tpr_weekly_unk), 
                       ~left_join(.x, .y, by = "Week")) %>% 
  arrange(Week) %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(`Paludisme clinique +.x` = "Paludisme clinique +",
                               `Paludisme clinique -.x` = "Paludisme clinique -",
                               `Paludisme clinique +.y` = "Paludisme clinique +",
                               `Paludisme clinique -.y` = "Paludisme clinique -", 
                               `Paludisme inconnu.x` = "Paludisme inconnu", 
                               `Paludisme inconnu.y` = "Paludisme inconnu") %>% 
  flextable::add_header_row(values = c(" ","TDR positif", "TDR negatif", "TDR non-realise"), 
                            colwidths = c(1,3,2,3)
                            ) %>% 
  flextable::vline(j = c(1,4,6))


flext_metrex

```

There were **`r a+b`** individuals incorrectly classified according TDR
testing results, and another **`r c`** individuals given a malaria
status without testing results.

Performance metrics of clinical malaria classification versus RDT as
gold standard:

-   Sensitivity: `r sens`% (`r sens_num`/`r sens_den`)
-   Specificity: `r spec`% (`r spec_num`/`r spec_den`)
-   Positive Predictive Value: `r ppv`% (`r ppv_num`/`r ppv_den`)
-   Negative Predictive Value: `r npv`% (`r npv_num`/`r npv_den`)

Note that `r sum(temp$counts)` observations (of `r nrow(data5_a)`) are
missing RDT data and are not included above.

Weekly performance metrics are provided below.

```{r}

tpr_weekly %>% 
  flextable::flextable() %>% 
  flextable::autofit()

```

#### Clinical presentation of individuals classified as having malaria

```{r }
palu_pos_sym <- data5_a %>% 
  filter(paludisme_1 == "oui") %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  arrange(-counts)

palu_pos_tdr <- data5_a %>% 
  filter(paludisme_1 == "oui") %>% 
  select(n, 11:27, tdr1) %>% 
  pivot_longer(-c(n, tdr1)) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt, tdr1) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  select(-list_sympt)

palu_pos <- data5_a %>% 
  filter(paludisme_1 == "oui") %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  mutate(sympt = fct_reorder(sympt, count, .desc = TRUE))

palu_pos_graph <- palu_pos %>% 
  left_join(palu_pos_tdr, 
            by = "sympt") %>% 
  ungroup() %>% 
  mutate(sympt = fct_reorder(sympt, count.x, .desc = TRUE)) %>% 
  group_by(list_sympt) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  filter(id <= 20)

palu_pos_points <- palu_pos %>% 
  mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  mutate(
    symptoms = factor(symptoms, levels = palu_pos_sym$name),
    sympt = factor(sympt, levels = palu_pos$sympt)
  ) %>%  
  filter(!is.na(symptoms)) %>% 
  filter(list_sympt %in% palu_pos_graph$list_sympt)
  
single_sympt <- palu_pos_graph %>% 
    mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  group_by(symptoms, tdr1) %>% 
  summarise(count = sum(count.y, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(symptoms) %>% 
  mutate(total_count = sum(count)) %>% 
  ungroup() %>% 
  mutate(symptoms = factor(symptoms, levels = palu_pos_sym$name))


horizontal_bars <- ggplot(single_sympt)+
  geom_col(aes(x = -count, y = symptoms, fill = tdr1), color = "grey50")+
    scale_fill_manual(values = rev(color3))+
  scale_y_discrete(limits = rev)+
  scale_x_continuous(labels = function(x) abs(x))+
  theme(legend.position = "none", 
        axis.text.y = element_blank())+
  labs(x = element_blank(), 
       y = element_blank())

points <- palu_pos_points %>%  
  ggplot(aes(x = sympt, y = symptoms)) +
  geom_line(aes(group = sympt), col = 'grey50') +
  geom_point(size = 3, col = 'grey50') +
  scale_x_discrete(drop = TRUE)+
  scale_y_discrete(limits = rev, 
                   labels = rev(str_to_title(str_replace_all(sort(unique(single_sympt$symptoms)),
                                         "_", " "))))+
  theme(axis.text.x = element_blank())+
  labs(x = "Presentation", 
       y = element_blank())



plot_1 <- ggplot(palu_pos_graph)+
  geom_col(aes(x = sympt, y = count.y, fill = tdr1), 
           color = "grey50",
           position = "stack")+
  scale_fill_manual(values = rev(color3))+
  theme(axis.text.x = element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Counts")

legend <- cowplot::get_legend(palu_pos_graph %>% 
                                mutate(tdr1 = factor(case_when(tdr1 == "positif" ~ "Positif", 
                                                        tdr1 == "negatif" ~ "Negatif", 
                                                        tdr1 == "unknown" ~ "Pas d'information", 
                                                        .default = "erreur"), 
                                                     levels = c("Pas d'information", 
                                                                "Negatif", 
                                                                "Positif"))) %>% 
                                ggplot()+
  geom_col(aes(x = sympt, y = count.y, fill = tdr1), 
           color = "grey50",
           position = "stack")+
  scale_fill_manual(values = rev(color3))+
  theme(axis.text.x = element_blank())+
  labs(x = element_blank(), 
       y = "Counts", 
       fill = "TDR")
)

ggsave(cowplot::ggdraw(legend), 
       filename = here::here("output", "tdr_results.png"), 
       dpi = 700, 
       height = 3, 
       width = 2, 
       units = "in")


right <- cowplot::plot_grid(plot_1, points, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

left <- cowplot::plot_grid(NULL, horizontal_bars, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

full <- cowplot::plot_grid(left, right, ncol = 2,
                           rel_widths = c(1,3),
                   align = "hv", axis = "tb")


full
  

```

#### Clinical presentation of individuals classified as *NOT* having malaria

```{r }
palu_pos_sym <- data5_a %>% 
  filter(paludisme_1 == "non") %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  arrange(-counts)

palu_pos_tdr <- data5_a %>% 
  filter(paludisme_1 == "non") %>% 
  select(n, 11:27, tdr1) %>% 
  pivot_longer(-c(n, tdr1)) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt, tdr1) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  select(-list_sympt)

palu_pos <- data5_a %>% 
  filter(paludisme_1 == "non") %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  mutate(sympt = fct_reorder(sympt, count, .desc = TRUE))

palu_pos_graph <- palu_pos %>% 
  left_join(palu_pos_tdr, 
            by = "sympt") %>% 
  ungroup() %>% 
  mutate(sympt = fct_reorder(sympt, count.x, .desc = TRUE)) %>% 
  group_by(list_sympt) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  filter(id <= 20)

palu_pos_points <- palu_pos %>% 
  mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  mutate(
    symptoms = factor(symptoms, levels = palu_pos_sym$name),
    sympt = factor(sympt, levels = palu_pos$sympt)
  ) %>%  
  filter(!is.na(symptoms)) %>% 
  filter(list_sympt %in% palu_pos_graph$list_sympt)
  
single_sympt <- palu_pos_graph %>% 
    mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  group_by(symptoms, tdr1) %>% 
  summarise(count = sum(count.y, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(symptoms) %>% 
  mutate(total_count = sum(count)) %>% 
  ungroup() %>% 
  mutate(symptoms = factor(symptoms, levels = palu_pos_sym$name))


horizontal_bars <- ggplot(single_sympt)+
  geom_col(aes(x = -count, y = symptoms, fill = tdr1), color = "grey50")+
    scale_fill_manual(values = rev(color3))+
  scale_y_discrete(limits = rev)+
  scale_x_continuous(labels = function(x) abs(x))+
  theme(legend.position = "none", 
        axis.text.y = element_blank())+
  labs(x = element_blank(), 
       y = element_blank())

points <- palu_pos_points %>%  
  ggplot(aes(x = sympt, y = symptoms)) +
  geom_line(aes(group = sympt), col = 'grey50') +
  geom_point(size = 3, col = 'grey50') +
  scale_x_discrete(drop = TRUE)+
  scale_y_discrete(limits = rev, 
                   labels = rev(str_to_title(str_replace_all(sort(unique(single_sympt$symptoms)),
                                         "_", " ")))
                   )+
  theme(axis.text.x = element_blank())+
  labs(x = "Presentation", 
       y = element_blank())



plot_1 <- ggplot(palu_pos_graph)+
  geom_col(aes(x = sympt, y = count.y, fill = tdr1), 
           color = "grey50",
           position = "stack")+
  scale_fill_manual(values = rev(color3))+
  theme(axis.text.x = element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Counts")


right <- cowplot::plot_grid(plot_1, points, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

left <- cowplot::plot_grid(NULL, horizontal_bars, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

full <- cowplot::plot_grid(left, right, ncol = 2,
                           rel_widths = c(1,3),
                   align = "hv", axis = "tb")


full
  

```

```{r}
a <- if(npv >=50){"did not have malaria"} else {"actually had malaria"}
```

Consistent with the NPV listed above, most individuals stated to be
malaria negative by clinical means `r a`.

Clinical determination of 'malaria' will be ignored in favor of TDR
results.

### Focus on Respiratory Diagonses

Summary: Clinical determination of different respiratory infections does
not appear to be reliable variable for analyses based on available
information. Several diagnoses appear to have similar symptomatic
profiles and do not correlate with outcomes. Fever and cough appear to
be the most common and important symptoms noted by far; consider
changing categorization of 'influenza' to 'cough and fever' moving
forward. Several individuals do not have documented evidence of these;
consider dropping those observations as they are likely to be unrelated
and may artificially inflate counts.

```{r}
cols <-  c("fievre", "toux", "rhinorrhee", "dyspnee", 
           "asthenie_physique", "courbatures",
           "cephalee", "frisson", "anorexie", "vomissement", 
           "douleurs_abdominales", "diarrhee",  "douleurs_generalisees",
           "lombalgie",  "douleurs_au_bas_ventre", 
           "douleurs_costales", "douleurs_testiculaires")

cols2 <- c("grippe", "bronchite", "ira", "syndrome_grippal",
           "pneumonie","broncho_pneumonie")



dx <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list = list(name)) %>% 
  ungroup() %>% 
  group_by(list) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  group_by(list) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  mutate(list_dx_1 = factor(map_chr(list, paste, collapse = ", ")),
         list_dx_1 = fct_reorder(list_dx_1, -count)) %>% 
  group_by(list) 
  
dx_combo_upset <- dx %>% 
  filter(id <= 20) 
  

  symptoms <- data5 %>% 
    select(n, cols) %>% 
    pivot_longer(-n) %>% 
    filter(value == "oui") %>% 
    group_by(name) %>% 
    summarise(count = n()) %>% 
    ungroup() %>% 
    mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
    arrange(-count)
  
heatmap <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list_dx = list(name)) %>% 
  ungroup() %>% 
  left_join(data5, by = "n") %>% 
  group_by(list_dx) %>% 
  summarise(across(c(fievre:douleurs_testiculaires), 
                ~sum(.x == "oui", na.rm = TRUE)/(sum(.x == "oui", na.rm = TRUE) + 
                                                   sum(.x == "non", na.rm = TRUE)))) %>% 
  ungroup() %>% 
  pivot_longer(-1) %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " ")), 
         list_dx1 = factor(map_chr(list_dx, paste, collapse = ", "), 
                          levels = unique(dx$list_dx_1)), 
         name = factor(name, levels = rev(symptoms$name)))

heatmap_graph <- heatmap %>% 
  filter(list_dx1 %in% dx_combo_upset$list_dx_1)


dx_other <- dx %>% 
  left_join(select(data5, n, evolution, tdr), by = "n")


cfr_by_dx_strat <- dx_other %>% 
  mutate(tdr = factor(case_when(is.na(tdr) ~ "non.rensegne", 
                         .default = tdr), 
                      levels = c("positif", 
                                 "negatif", 
                                 "non.rensegne"))) %>% 
  group_by(list_dx_1, tdr) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )

cfr_by_dx <- dx_other %>% 
  group_by(list_dx_1) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )

cfr_graph_df <- map(list(cfr_by_dx_strat, cfr_by_dx), 
    ~.x %>% 
      filter(list_dx_1 %in% dx_combo_upset$list_dx_1) 
)



top <- ggplot(dx_combo_upset)+
  geom_bar(aes(x = list))+
  scale_x_upset()+
  labs(x = element_blank(), 
       y = "Count")
  
  
mid <- ggplot(heatmap_graph)+
  geom_tile(aes(x = list_dx1, y = name, fill = value))+
  scale_fill_gradient(low = "white", high = "black")+
  theme(legend.position = "none", 
        axis.text.x=element_blank())+
  labs(y = "Symptoms", 
       x = element_blank())


bottom <- ggplot()+
  geom_col(data = cfr_graph_df[[1]], aes(x = list_dx_1, 
               y = cfr, 
               fill = tdr, 
               group = tdr), 
           color = "black", 
           position = position_dodge2(width = 0.9, preserve = "single"))+
  scale_fill_manual(values = c("firebrick4", 
                               "cadetblue4", 
                               "white"))+
  ungeviz::geom_hpline(data = cfr_graph_df[[2]], aes(x = list_dx_1, 
               y = cfr), 
           color = "black")+
  theme(axis.text.x=element_blank(), 
        legend.position = "none")+
  coord_cartesian(ylim = c(0, 25))+
  labs(x = element_blank(), 
       y = "Case Fatality Rate (%)")


a <- cowplot::plot_grid(top, mid,  NULL, bottom,
                   ncol = 1, 
                   labels = c("A", "B", "", "C"),
                   rel_heights = c(1,1, -0.2, 1),
                   align = "hv", 
                   axis = "tblr")

ggsave(a, filename = here::here("output", "diagnosis_combo_outcome.png"), 
       dpi = 700, 
       height = 11, 
       width = 6, 
       units = "in")


```

#### Figure of outcomes

**A** Upset plot of most common clinical diagnosis combinations. Bar
chart at the top represents case counts of the diagnosis combinations
indicated by points below (individual symptoms present are indicated by
black point). **B** Heatmap indicating the symptoms listed for those
with the diagnosis combinations above. Darker colors indicate a higher
proportion of those with the diagnosis combination being listed with the
symptoms exhibited (black = 100%, white = 0%). **C** Case fatality rates
of those presenting with above diagnosis combination. The black bar is
the overall case fatality rate; red bars represent the case fatality
rate for those with a positive RDT; green bars represent the case
fatality rate for those with a negative RDT; white bars represent the
case fatality rate for those that do not have RDT information (and
presumably were not tested for malaria).

![](output/diagnosis_combo_outcome.png)

#### Table of outcomes

```{r}

outcome_by_presentation <- data5 %>% 
  select(n, 11:27) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  left_join(select(data3, n, tdr1, evolution), 
            by = "n") %>% 
  group_by(list_sympt) %>% 
  summarise(count = n(), 
            tpr = round(100*sum(tdr1 == "positif", na.rm = TRUE)/(sum(tdr1 == "negatif", 
                                                                      na.rm = TRUE) + 
                                                                    sum(tdr1 == "positif",
                                                                        na.rm = TRUE)),1),
            taux_mortalite = round(100*sum(evolution == "decede", na.rm = TRUE)/(sum(evolution != "decede", 
                                                                                    na.rm = TRUE)+sum(evolution == "decede", na.rm = TRUE)),1)
  ) %>% 
  arrange(-count, -taux_mortalite, -tpr) %>% 
  mutate(list_sympt1 = str_replace_all(str_to_title(map_chr(list_sympt, paste, 
                                                            collapse = ", ")),
                                       "_", " ")) %>% 
  rename(Presentation = list_sympt1, 
         Count = count, 
         `Test posititivity rate (%)` = tpr,
         `Case fatality rate (%)` = taux_mortalite) %>% 
  relocate(Presentation)


outcome_by_presentation %>% 
  select(-list_sympt) %>% 
  DT::datatable(filter = 'top')



all <- outcome_by_presentation %>% 
  select(-list_sympt) %>% 
  relocate(Presentation)

missing_one <- outcome_by_presentation %>% 
  rowwise() %>% 
  filter(!all(c("fievre", "toux") %in% list_sympt)) %>% 
  select(-list_sympt) %>% 
  relocate(Presentation)
  
missing_both <- outcome_by_presentation %>% 
    rowwise() %>% 
    filter(!any(c("fievre", "toux") %in%  list_sympt)) %>% 
  select(-list_sympt) %>% 
  relocate(Presentation) 
  
symptom_combos <- list(all, missing_one, missing_both)
    
 symptom_combos_flex <- symptom_combos %>% 
   map(~.x %>% 
        # rename("Symptômes" = presentation_clinique, 
        #        "Nombre de Cas" = nombre, 
        #        "Taux de positivité - TDR (%)" = tdr_positivite_pourcent, 
        #        "Taux de mortalité (%)" = taux_mortalite) %>% 
         flextable::flextable() %>% 
         flextable::colformat_num(big.mark = "", digits = 1) %>% 
         flextable::autofit()
       )
 
 
```

```{r echo = FALSE, include = FALSE}

 map2(symptom_combos_flex, 
      list("symptom_outcome_all", "symptom_outcome_missing_fever_and_or_cough", 
           "symptom_outcome_missing_both_fever_and_cough"), 
      function(x, y){flextable::save_as_docx(x, path = paste0(here::here("linelist", 
                                                                         "output"), "/", y, ".docx"))
      })
 
```

There are `r sum(symptom_combos[[3]]$count, na.rm = TRUE)` patients that
were listed without *either* fever or cough. Clinical presentations,
counts, malaria RDT test positivity rate, and case fatality rates are
listed below.

```{r echo = FALSE}

symptom_combos_flex[[3]]

```

### Matching lab data to line list

```{r}

## Merge in laboratory data

normalize_string <- function(text) {
  str_split(text, "_") %>% 
    unlist() %>% 
    sort() %>% 
    paste(collapse = "_")
}

# Normalize the 'text' columns in both data frames
linelist_normalized <- data5 %>%
  mutate(normalized_name = map_chr(nom_et_postnom, normalize_string))

lab_normalized <- lab %>%
  mutate(normalized_text = map_chr(noms, normalize_string))

data5_d <- powerjoin::power_left_join(linelist_normalized, lab_normalized, 
                           by = c(~ stringdist::stringdist(.x$normalized_name, 
                                                                     .y$normalized_text) < 5,
                                  ~ lubridate::time_length(interval(.x$date_de_notification, .y$date_de_prelevement),
                                                           "day") > -3),
                           keep = "both"
                           )%>% 
  ungroup() %>% 
  mutate(lab_age_ans = as.numeric(age_ans), 
         lab_age_mois = as.numeric(age_mois)/12, 
         age_lab = ifelse(!is.na(lab_age_ans), lab_age_ans, lab_age_mois), 
         meme_sex = sexe.x == sexe.y, 
         age_difference = age_years - age_lab, 
         jour_not_prelev = lubridate::time_length(interval(date_de_notification, date_de_prelevement),
                                       "day"))


temp <- data5_d %>% 
  filter(!is.na(id.y)) %>% 
  mutate(name_dist = stringdist::stringdist(normalized_name, normalized_text)) %>% 
  select(c(n, id.y, normalized_name, normalized_text, name_dist, date_de_notification, 
           date_de_prelevement,jour_not_prelev, 
           age_years, age_lab, age_difference, 
           sexe.x, sexe.y, meme_sex))

dupes4 <- data5_d %>% 
  janitor::get_dupes(n) %>% 
  select(c(n, nom_et_postnom, age_years, sexe.x, date_de_notification,
           id.y, noms, age_ans, age_mois, sexe.y, age_lab, date_de_prelevement)) %>% 
  mutate(meme_sex = sexe.x == sexe.y, 
         age_difference = age_years - age_lab, 
         jour_not_prelev = lubridate::time_length(interval(date_de_notification, 
                                                           date_de_prelevement),
                                "day")) %>% 
  group_by(n) %>% 
  arrange(age_difference, meme_sex, .by_group = TRUE) %>% 
  mutate(name_dist = stringdist::stringdist(nom_et_postnom, noms)) %>% 
  relocate(n, id.y, nom_et_postnom, noms, name_dist, 
           age_years, age_lab, age_difference, 
           sexe.x, sexe.y, meme_sex) %>% 
  mutate(remove = NA) # creates blank column to be filled in Excel

temp1 <- temp %>% 
  arrange(name_dist)

rio::export(temp, "lab_linelist_match_dupes_a.xlsx")

matches_a <- rio::import("lab_linelist_match_keep.xlsx")

matches <- matches_a %>% 
  filter(keep == 1)

test <- janitor::get_dupes(matches, normalized_name) %>% 
  distinct(normalized_name, .keep_all = TRUE)

a <- length(setdiff(matches$normalized_name, test$normalized_name)) + length(test$normalized_name)


lab_linelist_dl <- matches_a %>% 
 downloadthis::download_this(
    output_name = "diagnoses",
    output_extension = ".xlsx",
    button_label = "Diagnoses",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")


```

Of the `r nrow(lab)` entires, `r nrow(temp)` were matched to a
restricted line list limited to individuals listed as 'notified' prior
to the last date of sampling in the lab list
(`r max(lab$date_de_prelevement, na.rm = TRUE)`).

`r nrow(matches)` matches were found by fuzzy matching from `r a` unique
individuals.

```{r echo = FALSE}
lab_linelist_dl
```

### Lab results

```{r}

lab1 <- lab %>% 
  mutate(influenza = case_when(influenza == "type.a" ~ "type_a", 
                               .default = influenza))

lab2 <- lab1 %>% 
  summarise(flu_count = sum(influenza == "type_a", na.rm = TRUE), 
            flu_prev = round(100*flu_count/(sum(influenza == "negatif", na.rm = TRUE)+
                                                                   sum(influenza == "type_a", na.rm = TRUE)),1),
            covid_count = sum(sars_cov2 == "positif", na.rm = TRUE),
            covid_prev = round(100*covid_count/(sum(sars_cov2 == "negatif", na.rm = TRUE)+
                                                                   sum(sars_cov2 == "positif", na.rm = TRUE)),1), 
            covid_flu_count = sum(sars_cov2 == "positif" & influenza == "type_a", na.rm = TRUE),
            covid_flu_prev = round(100*covid_flu_count/sum(!is.na(sars_cov2)& !is.na(influenza)), 1),
            mal_count = sum(tdr_palu == "positif", na.rm = TRUE),
            mal_flu_count = sum(tdr_palu == "positif" & influenza == "type_a", na.rm = TRUE),
            mal_prev = round(100*mal_count/(sum(tdr_palu == "negatif", na.rm = TRUE)+
                                                                   sum(tdr_palu == "positif", na.rm = TRUE)), 1),
            mal_flu_prev = round(100*mal_flu_count/sum(!is.na(tdr_palu)& !is.na(influenza)), 1),
            all_neg_count = sum(influenza == "negatif" & 
                          sars_cov2 == "negatif" &
                          tdr_palu == "negatif", na.rm = TRUE),
            all_neg_prev = round(100*all_neg_count/sum(!is.na(influenza) & !is.na(sars_cov2) & !is.na(tdr_palu)), 1)
            ) %>% 
  pivot_longer(everything()) %>% 
  mutate(type = word(name, -1, sep = "_"), 
         name = str_remove_all(name, c("_count|_prev"))) %>% 
  pivot_wider(names_from = "type", values_from = "value") %>% 
  mutate(name = case_match(name,
                    "flu" ~ "Grippe", 
                    "covid" ~ "COVID", 
                    "covid_flu" ~ "Grippe et COVID",
                    "mal" ~ "Paludisme", 
                    "mal_flu" ~ "Grippe et Palu", 
                    "all_neg" ~ "Tous négatifs")) %>% 
  rename(Maladie = name, 
         Nombre = count, 
         `Prevalance (%)` = prev) %>% 
  flextable::flextable() %>% 
  flextable::autofit()


lab2


```

Notez que le dénominateur de la prévalence pour toutes les catégories
n'est pas 120 en raison de certaines données manquantes.

En raison de l'impossibilité de faire correspondre les observations de
laboratoire avec la liste épidémiologique et de la taille relativement
réduite de l'échantillon, il n'est pas certain que ces résultats
reflètent l'ensemble de la population concernée.

## **Epidemiological curves** {.tabset .tabset-pills}

```{r}
data_6 <- data5_a %>% 
  select(n,
         date_de_notification,
         date_debut_des_signes,
         date_de_consultation,
         as = as.x,
         village_quartier,
         etablissement_recu, 
         fievre, 
         toux,
         tdr1, 
         sexe, 
         age_years,
         tx,
         tx1.x,
         any_artemisinins_a,     
         any_artemisinins,
         any_antimalarial,
         any_abx_a, 
         any_abx, 
         comp, 
         tx1.y, 
         decede_non,
         age_cat1, 
         age_cat2,
         age_cat3, 
         duration_symp_consult,  
         consult_pre_dec01,
         year_week_factor,
         cough_fever, 
         malnutrition) %>% 
  mutate(etablissement_recu = case_match(etablissement_recu, 
                                         "communaute" ~ "none", 
                                         NA ~ "none",
                                         .default = etablissement_recu))

rio::export(data_6, "data_6.xlsx")

mal <- filter(data_6, tdr1 == "positif" & cough_fever != "both")
resp <- filter(data_6, cough_fever == "both" & tdr1 == "negatif")
resp_mal <- filter(data_6, tdr1 == "positif" & cough_fever == "both")
unk <- filter(data_6, tdr1 == "unknown")

temp <- filter(data_6, cough_fever == "both" | tdr1 == "positif")
other <- filter(data_6, !n %in% temp$n)


mas <- filter(data_6, str_detect(tx1.y, "malnutrition"))

all_data <- list(data_6, 
                 mal, 
                 resp, 
                 resp_mal, 
                 unk,
                 other)

all_weeks <- tibble(week = unique(data_6$year_week_factor))

all_epicurves <- map(all_data, 
    ~.x %>% 
      group_by(year_week_factor) %>% 
      summarise(count = n(), 
                cfr = 100*sum(decede_non == "decede", na.rm = TRUE)/
                  (sum(decede_non == "decede", na.rm = TRUE)+
                     sum(decede_non == "non_decede", na.rm = TRUE))) %>% 
      ungroup() %>% 
      full_join(all_weeks, by = c("year_week_factor" = "week")) %>% 
      mutate(across(c(count, cfr), ~replace_na(.x, 0)))
)

temp <- all_epicurves[[2]]


epicurves <- pmap(list(all_epicurves, list("grey",
                                     "firebrick4", 
                                     "cadetblue4", 
                                     "blueviolet",
                                     "darkslategrey",
                                     "wheat4"),list("Tous les cas", 
                                                    "Paludisme seulement", 
                                                    "Maladie respiratoire uniquement", 
                                                    "Paludisme et maladie respiratoire", 
                                                    "Statut du paludisme inconnu",
                                                    "Autres")),
                 function(x, y,z){
                   max <- max(all_epicurves[[1]]$count, na.rm = TRUE)
                   
                   x_1 <- x %>% 
                     mutate(deaths = cfr/100*count)
                   
                   cases <- sum(x$count)
                   deaths <- round(sum(x_1$deaths),0)
                   
                   a <-ggplot(x)+
                   geom_col(aes(x = year_week_factor, y = count), 
                            color = "black", 
                            fill = y)+
                     coord_cartesian(ylim = c(0, max+20))+
                     scale_x_discrete(breaks = unique(data_6$year_week_factor), 
                                      labels = unique(data_6$year_week_factor))+
                     labs(x = element_blank(), 
                          y = "Count", 
                          title = z, 
                          subtitle = paste0("Nombre total de cas = ", cases,
                                            "\nNombre de décès = ", deaths, 
                                            " (", round(100*deaths/cases,1), "%)"))+
                     theme(axis.text.x = element_blank())
                    
                   
                   b <- ggplot(x)+
                     geom_col(aes(x = year_week_factor, y = cfr), 
                              fill = "grey35", 
                              color = "black")+
                     labs(x = "Semaine", 
                          y = "Taux de mortalité (%)")+
                      theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                                      hjust = 1))
                   
                   cowplot::plot_grid(a,
                                      NULL,
                                      b,
                                      ncol = 1,
                                      rel_heights = c(1,-0.3,1),
                                      align = "hv", 
                                      axis = "tblr")
                                      
                 }
)

```

### All Cases

```{r}

epicurves[[1]]

```

### TDR Positive

```{r}

epicurves[[2]]

```

### Respiratory (Fever + Cough)

```{r}

epicurves[[3]]

```

### TDR Positive + Respiratory

```{r}

epicurves[[4]]

```

### Malaira status unknown

```{r}
epicurves[[5]]
```

### Other (TDR negative/unknown + not *both* fever and cough)

```{r}

epicurves[[6]]

```

### Malnutrition

Data on malnutrition are only available for `r nrow(mas)` individuals at
the of coding; these are not shown graphically

## **Patient demographics** {.tabset .tabset-pills}

### Tableau des Ages et des Sexes

```{r}

prop_var <- list("age_cat3",
                 "sexe")

map(prop_var, function(x){
           y <- sym(x)
           a <- data5_a %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1)

         return(a)
         }
         ) %>% 
  set_names(prop_var) %>% 
  list_rbind(names_to = "element") %>% 
  mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
  mutate(total = rowSums(select(., decede, non_decede)), 
         cfr = round(100*decede/total, 1), 
         element = case_when(element == "age_cat3" ~ "Age (annees)", 
                             element == "sexe" ~ "Sexe", 
                             .default = "error"), 
         category = case_when(category == "m" ~ "Masculin", 
                              category == "f" ~ "Feminin", 
                              .default = category)) %>% 
  rename(Variable = element, 
         Groupe = category, 
         "Decede\n(nombre)" = decede, 
         "Non decede\n(nombre)" = non_decede, 
         `Total (nombre)` = total, 
         `Taux de mortalite (%)` = cfr) %>% 
  flextable::flextable() %>% 
  flextable::autofit()
           
  
```

### Graphiques des ages et des sexes

#### Pyramide

```{r}

deces_5 <- data5_a %>% 
  filter(evolution == "decede")


prop_var <- list("age_cat1",
                 "age_cat2", 
                 "sexe", 
                 "as.x",
                 "fievre",
                 "toux", 
                 "cough_fever",
                 "consult_pre_dec01")

demo_prop_list <- map(prop_var, function(x){
           y <- sym(x)
           a <- data5_a %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1)

         return(a)
         }
         ) %>% 
  set_names(prop_var) %>% 
  list_rbind(names_to = "element") %>% 
  mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
  mutate(total = rowSums(select(., decede, non_decede)), 
         cfr = round(100*decede/total, 1))
  

age_pyr <- map(list(data5_a, deces_5),
               ~.x %>% 
  filter(!is.na(sexe)) %>% 
  group_by(age_cat3, sexe) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(count = ifelse(sexe == "f", -1*count, count)) %>% 
    ggplot()+
  geom_col(aes(x = age_cat3, y = count, fill = sexe))+
  scale_fill_manual(values = c("coral2", "cadetblue"))+
    theme_minimal()+
  coord_flip()+
    labs(y = "Count", 
         x = "Age category", 
         fill = "Sexe")+
    scale_y_continuous(labels = function(x) abs(x))
    
)

pyr_button <- download_this(age_pyr[[1]], 
                                button_label = "Télécharger le graphique")

age_pyr[[1]]

```

```{r echo = FALSE}

pyr_button

```

#### Point de dispersion de la distribution des cas par rapport à la

distribution de la population

Ce graphique est interactif.

```{r out.width= 700, out.height = 700}

drc_pop <- rio::import("population_structure.xlsx") %>% 
  select(c(3,5,7,9)) %>% 
  mutate(across(everything(), ~as.numeric(str_remove_all(.x, ","))))

drc_pyr <- drc_pop %>% 
  rename(age = GROUP) %>% 
  mutate(age_cat = factor(case_when(age <= 2 ~ "(0,2]", 
                             age <=5 ~ "(2,5]",
                             age <=15 ~ "(5,15]",
                             age <=25 ~ "(15,25]",
                             age <=35 ~ "(25,35]",
                             age <=45 ~ "(35,45]",
                             age <=55 ~ "(45,55]",
                             age <=65 ~ "(55,65]",
                             age > 65 ~ "(65,Inf]", 
                             .default = "error"), 
                          levels = sort(unique(data5_a$age_cat3)))) %>% 
  filter(!is.na(age)) %>% 
  group_by(age_cat) %>% 
  summarise(m = sum(`Male Population`), 
            f = sum(`Female Population`)) %>% 
  ungroup() %>% 
  pivot_longer(-1) %>% 
  mutate(perc_tot_pop = 100*value/sum(.$value))

age_pyr <- data5_a %>% 
  filter(!is.na(sexe)) %>% 
  group_by(age_cat3, sexe) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(perc_tot_cases = 100*count/sum(.$count)) %>% 
  left_join(select(drc_pyr, age_cat, name, perc_tot_pop), 
            by = c("age_cat3" = "age_cat", 
                   "sexe" = "name"))

plot <- ggplot(age_pyr)+
  geom_abline(slope = 1,
              intercept = 0,
              color="grey80")+
  geom_point(aes(x = perc_tot_pop, y = perc_tot_cases, 
                 color = sexe, text = age_cat3))+
  scale_fill_manual(values = c("coral2", "cadetblue"))+
  labs(x = "Pourcentage de la population", 
       y = "Pourcentage des cas")+
  theme(legend.position = "none", 
        aspect.ratio=1)+
  coord_fixed(xlim = c(0,15), 
                  ylim = c(0,15))

plotly::ggplotly(plot, 
                 tooltip = "text")

```

#### Répartition des cas de maladies individuelles par rapport à la répartition de la population.

##### Ages

```{r}

mal <- filter(data_6, tdr1 == "positif" & cough_fever != "both")
resp <- filter(data_6, cough_fever == "both" & tdr1 == "negatif")
resp_mal <- filter(data_6, tdr1 == "positif" & cough_fever == "both")
unk <- filter(data_6, tdr1 == "unknown")

temp <- filter(data_6, cough_fever == "both" | tdr1 == "positif")
other <- filter(data_6, !n %in% temp$n)

pop_sexe_only <- drc_pyr %>% 
  ungroup() %>% 
  group_by(name) %>% 
  summarise(pop = sum(value), 
            perc = sum(perc_tot_pop)) %>% 
  ungroup() %>% 
  mutate(check = 100*pop/sum(.$pop)) %>%   # checks out
  select(Groupe = name, perc) %>% 
  mutate(Groupe = case_when(Groupe == "f" ~ "Feminin", 
                          Groupe == "m" ~ "Masculin"), 
         Variable = "Sexe")

pop_sexe <- drc_pyr %>% 
  ungroup() %>% 
  group_by(age_cat) %>% 
  summarise(pop = sum(value), 
            perc = sum(perc_tot_pop)) %>% 
  ungroup() %>% 
  mutate(check = 100*pop/sum(.$pop)) %>%   # checks out
  select(Groupe = age_cat, perc) %>% 
  mutate(Variable = "Age (annees)") %>% 
  bind_rows(pop_sexe_only)



prop_var <- list("age_cat3",
                 "sexe")

test1 <- map(list(data_6, 
         mal, 
         resp, 
         resp_mal, 
         unk,
         other), 
    function(z){map(prop_var, function(x){
           y <- sym(x)
           a <- z %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1)

         return(a)
           }) %>% 
        set_names(prop_var) %>% 
        list_rbind(names_to = "element") %>% 
        mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
        mutate(total = rowSums(select(., decede, non_decede)),
               cfr = round(100*decede/total, 1), 
               element = case_when(element == "age_cat3" ~ "Age (annees)", 
                             element == "sexe" ~ "Sexe", 
                             .default = "error"), 
               category = case_when(category == "m" ~ "Masculin", 
                              category == "f" ~ "Feminin", 
                              .default = category)) %>% 
        select(Variable = element, 
               Groupe = category, 
               `Total (nombre)` = total, 
               `Taux de mortalite (%)` = cfr)}
         ) %>% 
  reduce(~left_join(.x, .y, by = c("Variable", "Groupe")))


prop_cases <- test1 %>% 
  select(Variable, Groupe, starts_with("Total")) %>% 
  ungroup() %>% 
  group_by(Variable) %>% 
  mutate(across(starts_with("Total"), function(x) paste0(x, "/",sum(x)), 
                .names = "{col}_tot")) %>% 
  ungroup() %>% 
  select(where(is.character)) %>% 
  mutate(across(starts_with("Total"), function(x) 100*as.numeric(word(x, 1, sep = "/"))/as.numeric(word(x, 2, sep = "/")))
  ) %>% 
  left_join(pop_sexe, by = c("Variable", "Groupe")) %>% 
  rename(all = 3, 
         mal_only = 4, 
         resp_only = 5, 
         resp_mal = 6, 
         unk = 7, 
         other = 8, 
         pop = 9) %>% 
  mutate(Groupe = factor(Groupe, levels = c(as.character(sort(unique(drc_pyr$age_cat))), 
                                            "Feminin", "Masculin")))


prop_cases_graph_a <- prop_cases %>% 
  pivot_longer(-c(1,2)) %>% 
  mutate(name = factor(case_match(name,
                                  "pop" ~ "Population", 
                                  "all" ~ "Tous les cas",
                                  "mal_only" ~ "Paludisme", 
                                  "resp_only" ~ "Respiratoire", 
                                  "resp_mal" ~ "Paludisme et Respiratoire", 
                                  "unk" ~ "Palu inconnu",
                                  "other" ~ "Autres"),
                       levels = c("Population", 
                                  "Tous les cas",
                                  "Paludisme", 
                                  "Respiratoire",
                                  "Paludisme et Respiratoire", 
                                  "Palu inconnu",
                                  "Autres"))) %>% 
  split(.$Variable)

prop_cases_graph <- prop_cases_graph_a %>% 
  map2(list("Tranche d'âge", 
            "Sexe"), 
       ~.x %>% 
        ggplot()+
        geom_col(aes(x = Groupe, 
                     y = value, 
                     fill = name),
                 color = "grey35",
                 position = "dodge")+
        scale_fill_manual(values = c("black", 
                                     "grey",
                                     "firebrick4", 
                                     "cadetblue4", 
                                     "blueviolet",
                                     "darkslategrey",
                                     "wheat4"))+
        labs(y = "Pourcentage (%)", 
             x = .y,
             fill = "Maladie",
             title = "Pourcentage de cas par rapport à estimations démographiques nationales")+
         theme(legend.position = "none"))

legend <- cowplot::get_legend(prop_cases_graph_a[[1]] %>% 
        ggplot()+
        geom_col(aes(x = Groupe, 
                     y = value, 
                     fill = name),
                 color = "grey35",
                 position = "dodge")+
        scale_fill_manual(values = c("black", 
                                     "grey",
                                     "firebrick4", 
                                     "cadetblue4", 
                                     "blueviolet",
                                     "darkslategrey",
                                     "wheat4"))+
          labs(fill = element_blank())
)

ggsave(cowplot::ggdraw(legend), 
       filename = here::here("output", "pop_structure_legend.png"), 
       dpi = 700, 
       height = 3, 
       width = 2, 
       units = "in")

  
graph_1 <- cowplot::plot_grid(cowplot::ggdraw(legend),prop_cases_graph[[1]], 
                   ncol = 2, rel_widths = c(0.3, 1))

age_dist_dl <- downloadthis::download_this(graph_1, 
                                    button_label = "Télécharger le graphique")

graph_1
```

```{r echo = FALSE}

age_dist_dl

```

```{r}

graph_2 <- cowplot::plot_grid(cowplot::ggdraw(legend),prop_cases_graph[[2]], 
                   ncol = 2, rel_widths = c(0.3, 1))

sexe_dist_dl <- downloadthis::download_this(graph_2, 
                                    button_label = "Télécharger le graphique")

graph_2
```

```{r echo = FALSE}

sexe_dist_dl

```

## **Location** {.tabset .tabset-pills}

### Cases by village

```{r}

hist <- data_6 %>% 
  group_by(village_quartier) %>% 
  summarise(count = n(), 
            deaths = sum(decede_non == "decede", na.rm = TRUE)) %>% 
  ungroup() %>% 
  arrange(-count, -deaths) %>% 
  ungroup() %>% 
  mutate(cfr = deaths/count)

cases_par_village <- ggplot(hist)+
  geom_histogram(aes(x=count), 
                 color = "black")+
  labs(x = "Nombre de cas", 
       y = "Nombre de villages")

max_town <- hist %>% 
  slice_max(count) %>% 
  pull(village_quartier) %>% 
  str_replace_all(., "_", " ") %>% 
  str_to_title()

under_10 <- nrow(filter(hist, count <10))
under_1 <- nrow(filter(hist, count ==1))


cases_village_dl <- downloadthis::download_this(cases_par_village, 
                                    button_label = "Télécharger le graphique")

cases_par_village  
```

```{r echo = FALSE}
cases_village_dl
```

Des cas ont été signalés dans `r nrow(hist)` villages. Le nombre maximal
de cas (`r max(hist$count, na.rm = TRUE)`) a été signalé par
`r max_town`. Les villages `r under_10` ont signalé moins de 10 cas, et
`r under_1` villages n'ont signalé qu'un seul cas chacun.

#### Over time

```{r}

village_as <- data_6 %>% 
  group_by(as, village_quartier) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  janitor::get_dupes(village_quartier)

village_multi_as <- sum(village_as$count)

village_as <- data_6 %>% 
  group_by(as, village_quartier) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  group_by(village_quartier) %>% 
  slice_max(count, n = 1, with_ties = FALSE) %>% 
  ungroup() %>% 
  select(-count)

heatmap_village_a <- data_6 %>% 
  group_by(as, village_quartier, year_week_factor) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  complete(village_quartier, year_week_factor, fill = list(count = 0)) %>% 
  left_join(village_as, by = "village_quartier")

heatmap_village_b <- heatmap_village_a %>% 
  group_by(as.y) %>% 
  summarise(vill = list(village_quartier)) %>% 
  unnest_longer(vill) %>% 
  distinct(vill, .keep_all = TRUE)

vill_order <- heatmap_village_b$vill


heatmap_village <- heatmap_village_a %>% 
  mutate(village_loc = factor(village_quartier, 
                              levels = vill_order)) %>% 
ggplot()+
  geom_tile(aes(x = year_week_factor, y = village_loc, fill = count), 
            breaks = c(0))+
  scale_fill_viridis_c(option = "B")+
  labs(x = "Semaine", 
       y = element_blank(), 
       fill = "Nombre")+
  theme(axis.text.y = element_blank(), 
        axis.text.x = element_text(angle = 90), vjust = 1, 
        hjust = 1)

heatmap_village
#plotly::ggplotly(heatmap_village)

```

### Cases by health facility

#### Issues

```{r }

dhis_mod <- hf_dhis2 %>% 
  mutate(hf_dhis = str_remove_all(hf, c("kg|Centre de Santé|Poste de Santé|Hôpital Général de Référence|de Référence"))) %>% 
  linelist::clean_data(protect = c(T,T,F)) %>% 
  mutate(type_dhis = case_when(str_detect(hf, "Centre de Santé de Référence") ~ "csr", 
                          str_detect(hf, "Centre de Santé") ~ "cs", 
                          str_detect(hf, "Poste de Santé") ~ "ps", 
                          str_detect(hf, "Hôpital Général de Référence") ~ "hgr", 
                          .default = "error")
         )

hf_cases <- tibble(hf = unique(data_6$etablissement_recu)) %>% 
  mutate(type_cases = word(hf, 1, sep = "_"), 
         hf_cases = str_remove_all(hf, "cs_|ps_|hgr_"), 
         hf_cases = case_when(hf_cases == "makitapanzi" ~ "panzi_makita", 
                              hf_cases == "tshakala_panzi" ~ "tsakala_panzi",
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kiala_nkamba" ~ "kiala_kamba", 
                              .default = hf_cases)) %>% 
  select(-hf)

hf <- full_join(dhis_mod, hf_cases, by = c("hf_dhis" = "hf_cases"), keep = TRUE)

hf_case_not_dhis <- filter(hf, is.na(type_dhis)) %>% 
  filter(!is.na(type_cases) & type_cases != "communaute") %>% 
  mutate(type_cases = str_to_upper(type_cases), 
         hf_cases = str_to_title(hf_cases),
         hf = paste0(type_cases, " ", hf_cases))

orphan_cases <- data5_a %>% 
  rename(hf = etablissement_recu) %>% 
  mutate(type_cases = word(hf, 1, sep = "_"), 
         hf_cases = str_remove_all(hf, "cs_|ps_|hgr_"), 
         hf_cases = case_when(hf_cases == "makitapanzi" ~ "panzi_makita", 
                              hf_cases == "tshakala_panzi" ~ "tsakala_panzi",
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kiala_nkamba" ~ "kiala_kamba", 
                              .default = hf_cases)) %>% 
  filter(hf_cases %in% hf_case_not_dhis$hf_cases)


hf_dhis_no_cases <- filter(hf, is.na(type_cases)) %>% 
  filter(!is.na(hf_dhis)) %>% 
  mutate(type_dhis = str_to_upper(type_dhis), 
         hf_dhis = str_to_title(str_replace_all(hf_dhis, "_", " ")),
         hf = paste0(type_dhis, " ", hf_dhis))

temp <- hf_case_not_dhis$hf %>% 
  as.data.frame() %>% 
  flextable::flextable()

temp1 <- hf_dhis_no_cases$hf %>% 
  as.data.frame() %>% 
  flextable::flextable()
```

There are `r length(hf_case_not_dhis$hf)` health facilities listed in
the epidemiological line list that are not in the list of health
facilities located in the Panzi Health Zone per DHIS2. They are listed
below.

```{r echo = FALSE}

temp

```

There are `r length(hf_dhis_no_cases$hf)` health facilities listed in
the Panzi Health Zone per DHIS2 that do not have any cases listed in the
line list. They are listed below.

```{r echo = FALSE}

temp1

```

#### Map of cases by Week {.tabset .tabset-pills}

```{r out.width= 700, out.height = 700}

fs1 <- fs %>% 
  mutate(type = case_when(str_detect(name, "Centre de Santé de Référence") ~ "csr", 
                          str_detect(name, "Centre de Santé") ~ "cs", 
                          str_detect(name, "Poste de Santé") ~ "ps", 
                          str_detect(name, "Hôpital Général de Référence") ~ "hgr", 
                          .default = NA),
         name_match = str_remove_all(name, "kg | Poste de Santé|Poste de Santé| Centre de Santé| Hôpital Général de Référence| de Référence"), 
         name_match = str_to_lower(str_replace_all(name_match, c(" " = "_", 
                                                                 " / " = "_", 
                                                                 "/" = "_"))),
         name_match = case_when(name_match == "kambandambi" ~ "kamba_ndambi", 
                                name_match == "kiala_kamba" ~ "kiala_nkamba", 
                                name_match == "panzi___makita" ~ "makitapanzi", 
                                name_match == "tsakala_panzi" ~ "tshakala_panzi", 
                                name_match == "kambandambi" ~ "kamba_ndambi", 
                                .default = name_match), 
         name_match = paste0(type, "_", name_match)
  )

map_a <- data_6 %>% 
  group_by(etablissement_recu, year_week_factor) %>% 
  summarise(num = n(), 
            deaths = sum(decede_non == "decede", na.rm = TRUE)) %>% 
  left_join(fs1, by = c("etablissement_recu" = "name_match")) %>% 
  ungroup() %>% 
  group_by(etablissement_recu) %>% 
  mutate(cum_cases = cumsum(num), 
         cum_deaths = cumsum(deaths))


test <- janitor::get_dupes(map_a, etablissement_recu, year_week_factor)

empty_geo_coord <- map_a %>% 
  filter(is.na(level)) %>% 
  filter(!etablissement_recu %in% test$etablissement_recu)

keep <- st_intersection(sf::st_as_sf(map_a), sf::st_as_sf(zds))

test <- janitor::get_dupes(keep, etablissement_recu, year_week_factor)

leaf_pop_1 <- sf::st_drop_geometry(keep) %>% 
  select(etablissement_recu,year_week_factor,num,deaths, cum_cases,cum_deaths) %>% 
  complete(etablissement_recu,year_week_factor,fill = list(num = 0,
                                                                 deaths = 0)) %>% 
  mutate(across(c(cum_cases, cum_deaths), ~case_when(year_week_factor == "2024 W43" & is.na(.x) ~ 0, 
                                                     .default = .x))) %>% 
  group_by(etablissement_recu) %>% 
  fill(cum_cases, .direction = "down") %>% 
  fill(cum_deaths, .direction = "down") %>% 
  ungroup() %>% 
  left_join(select(sf::st_drop_geometry(keep), 
                   etablissement_recu, 
                   name)) %>% 
  mutate(name = str_remove_all(name, "kg "))



leaf_pop_cases <- leaf_pop_1 %>% 
  split(.$name) %>% 
  map2(names(.),
       function(a,b){
         top <- ggplot(a) +
           geom_col(aes(x = year_week_factor, 
                        y = num))+
           theme_minimal()+
           theme(axis.text.x = element_blank())+
           labs(title = b, 
                x = element_blank(), 
                y = "Weekly Cases")
         
         bottom <- ggplot(a) +
           geom_col(aes(x = year_week_factor, 
                        y = cum_cases))+
           theme_minimal()+
           theme(axis.text.x = element_text(angle = 90))+
           labs(x = "Week", 
                y = "Cumulative Cases")
         
         grid <- cowplot::plot_grid(top, bottom, ncol = 1, 
                            align = "hv", 
                            axis = "tblr")
         
         return(grid)
       }
         )



leaf_pop_deaths <- leaf_pop_1 %>% 
  split(.$name) %>% 
  map2(names(.),
       function(a,b){
         top <- ggplot(a) +
           geom_col(aes(x = year_week_factor, 
                        y = deaths))+
           theme_minimal()+
           theme(axis.text.x = element_blank())+
           labs(title = b, 
                x = element_blank(), 
                y = "Weekly Deaths")
         
         bottom <- ggplot(a) +
           geom_col(aes(x = year_week_factor, 
                        y = cum_deaths))+
           theme_minimal()+
           theme(axis.text.x = element_text(angle = 90))+
           labs(x = "Week", 
                y = "Cumulative Deaths")
         
         grid <- cowplot::plot_grid(top, bottom, ncol = 1, 
                            align = "hv", 
                            axis = "tblr")
         
         return(grid)
       }
         )



map <- keep %>%   
  mutate(name = str_remove_all(name, "kg ")) %>% 
  split(.$year_week_factor) %>% 
  map(~.x %>% 
        sf::st_as_sf())


map_names <- map %>% 
  map(~.x %>% 
        pull(name))

map_loop_cases <- list()
for(i in 1:length(map_names)){
  map_loop_cases[[i]] <- keep(leaf_pop_cases,names(leaf_pop_cases) %in% map_names[[i]])
}

map_loop_deaths <- list()
for(i in 1:length(map_names)){
  map_loop_deaths[[i]] <- keep(leaf_pop_deaths,names(leaf_pop_deaths) %in% map_names[[i]])
}

#### make tabs by week to show both cases and deaths
library(leafpop)

weekly_map <- function(x, y, z){

  out <- leaflet::leaflet() %>% 
   addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addMapPane("fill", zIndex = 410) %>% 
  addMapPane("dots", zIndex = 420) %>% 
   addCircleMarkers(data = x, 
                    radius = ~sqrt(num),
                    color = "#1e5597",
                    fill = TRUE,
                    fillOpacity = 0.5, 
                    options = pathOptions(pane = "dots"), 
                    popup = leafpop::popupGraph(y),
                    group = "Weekly Cases") %>% 
   addCircleMarkers(data = x, 
                    radius = ~sqrt(cum_cases),
                    color = "#1e5597",
                    fill = TRUE,
                    fillOpacity = 0.5, 
                    options = pathOptions(pane = "dots"), 
                    popup = leafpop::popupGraph(y),
                    group = "Cumulative Cases") %>% 
   addCircleMarkers(data = x, 
                    radius = ~sqrt(deaths),
                    color = "#972b1e",
                    stroke = FALSE, fillOpacity = 0.5, 
                    options = pathOptions(pane = "dots"), 
                    popup = leafpop::popupGraph(z),
                    group = "Weekly Deaths") %>% 
   addCircleMarkers(data = x, 
                    radius = ~sqrt(cum_deaths),
                    color = "#972b1e",
                    stroke = FALSE, fillOpacity = 0.5, 
                    options = pathOptions(pane = "dots"), 
                    popup = leafpop::popupGraph(z),
                    group = "Cumulative Deaths") %>%   
  addPopupGraphs(list(y), group = "Weekly Cases", width = 400, height = 400) %>% 
   addPolygons(
    data = sf::st_as_sf(zds),  fillOpacity = 0, smoothFactor = 0.5,
    color = "black", opacity = 1, weight = 0.8) %>% 
    addLayersControl(baseGroups = c("Weekly Cases",
                                    "Cumulative Cases",
                                    "Weekly Deaths",
                                    "Cumulative Deaths"),
                     options = layersControlOptions(collapsed = F))
  
  return(out)
}


too_many_maps <- pmap(list(map, map_loop_cases, map_loop_deaths),
                      function(x,y,z){
                        names(y) <- NULL
                        names(z) <- NULL
                        out <- weekly_map(x,y,z)
                        return(out)})



```





##### 2024 W43

```{r out.width= 700, out.height = 700}

too_many_maps[[1]]

```

##### 2024 W44

```{r out.width= 700, out.height = 700}

too_many_maps[[2]]

```

##### 2024 W45

```{r out.width= 700, out.height = 700}

too_many_maps[[3]]

```

##### 2024 W46

```{r out.width= 700, out.height = 700}

too_many_maps[[4]]

```

##### 2024 W47

```{r out.width= 700, out.height = 700}

too_many_maps[[5]]

```

##### 2024 W48

```{r out.width= 700, out.height = 700}

too_many_maps[[6]]

```

##### 2024 W49

```{r out.width= 700, out.height = 700}

too_many_maps[[7]]

```

##### 2024 W50

```{r out.width= 700, out.height = 700}

too_many_maps[[8]]

```

##### 2024 W51

```{r out.width= 700, out.height = 700}

too_many_maps[[9]]

```

##### 2024 W52

```{r out.width= 700, out.height = 700}

too_many_maps[[10]]

```

##### 2025 W01

```{r out.width= 700, out.height = 700}

too_many_maps[[11]]

```

##### 2025 W02

```{r out.width= 700, out.height = 700}

too_many_maps[[12]]

```

##### 2025 W03

```{r out.width= 700, out.height = 700}

too_many_maps[[13]]

```

##### 2025 W04
```{r out.width= 700, out.height = 700}

too_many_maps[[14]]

```

```{r echo = FALSE, include = FALSE}

rm(too_many_maps)

```



#### Cases by HF

##### Table

```{r out.width= 700, out.height = 700}

case_loc_a <- data5_a %>% 
  group_by(decede_non, etablissement_recu) %>% 
  summarise(nombre = n(), 
            reported_cases = list(as.Date(date_de_consultation)),
            first_case = map(reported_cases, ~ min(.x, na.rm = TRUE)), 
            last_case = map(reported_cases, ~ max(.x, na.rm = TRUE)), 
            cases_with_rdt_results = sum(!is.na(tdr1)), 
            cases_with_pos_rdt = sum(tdr1 == "positif", na.rm = TRUE), 
            no_rdt = sum(is.na(tdr1)), 
            any_art = sum(any_artemisinins == TRUE)) %>% 
  ungroup() %>% 
  mutate(any_art = replace_na(any_art, 0), 
         tpr = cases_with_pos_rdt/cases_with_rdt_results) %>% 
  select(-reported_cases) %>% 
  pivot_wider(names_from = decede_non, 
              values_from = c(nombre, 
                              first_case, last_case, 
                              cases_with_rdt_results, 
                              cases_with_pos_rdt,
                              tpr,
                              no_rdt, 
                              any_art), 
              names_glue = "{decede_non}_{.value}")
  
### needs updating below with new variables; as well as adding totals  

case_loc <- case_loc_a %>% 
  relocate(etablissement_recu, 
           non_decede_nombre, non_decede_first_case, 
           non_decede_last_case, 
           decede_nombre, decede_first_case, decede_last_case) %>% 
  mutate(across(contains("nombre"), ~replace_na(.x, 0)), 
         cfr = round(100*decede_nombre/(decede_nombre+non_decede_nombre),1), 
        # as = str_to_title(str_replace_all(as, "\\.", " ")), 
         etablissement_recu = str_to_title(str_replace_all(etablissement_recu,
                                                           "_", " ")), 
         etablissement_recu = str_replace_all(etablissement_recu, 
                                              c("Cs" = "CS", 
                                                "Ps" = "PS", 
                                                "Hgr" = "HGR"))) %>% 
  rowwise() %>% 
  mutate(overall_last = max(as.Date(non_decede_last_case), as.Date(decede_last_case),
                            na.rm = TRUE), 
         overall_first = min(as.Date(non_decede_first_case), as.Date(decede_first_case),
                            na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(across(c(decede_nombre, non_decede_nombre),~replace_na(.x, 0)), 
         cas_total = decede_nombre +non_decede_nombre, 
         overall_first = as.Date (overall_first), 
         overall_last = as.Date(overall_last)) %>% 
  select(Etablissement = etablissement_recu, 
         `Decede (nombre)` = decede_nombre, 
         `Cas Total` = cas_total, 
         `Taux de Mortalite (%)` = cfr, 
         `Primier Cas` = overall_first, 
         `Dernier Cas` = overall_last, 
         `Dernier Dece` = decede_last_case
         ) %>% 
  arrange(-`Decede (nombre)`, -`Cas Total`) 

case_loc %>% 
  DT::datatable(filter = 'top')

```

##### Epidemiological curves {.tabset .tabset-pills}

```{r}

data_6 <- rio::import("data_6.xlsx")

waffle <- data_6 %>% 
  mutate(year_week_factor1 = factor(str_replace_all(year_week_factor, "20", "'")), 
         year_week_factor2 = fct_reorder(year_week_factor1, year_week_factor),
    waffle_cat = case_when(tdr1 == "positif" & cough_fever != "both" ~ "#FFC051",# "Malaria only", 
                                tdr1 == "negatif" & cough_fever == "both" ~ "#004878", #"Respiratory only", 
                                tdr1 == "positif" & cough_fever == "both" ~ "#3B455F", #"Malaria and Respiratory", 
                                tdr1 == "negatif" & cough_fever != "both" ~ "grey50", #"Other", 
                                tdr1 == "unknown" ~ "#A62420", #"Malaria unknown", 
                                .default = NA)) %>% 
 # filter(etablissement_recu == "hgr_panzi") %>% 
  group_by(year_week_factor2, waffle_cat, etablissement_recu) %>% 
  summarise(count = n(), 
            deaths = sum(decede_non == "decede", na.rm = TRUE)) %>% 
  ungroup()

waffle_fill <- data.frame(year_week_factor2 = unique(waffle$year_week_factor2))
  
waffle_counts <- waffle %>% 
  split(.$etablissement_recu) %>% 
  map(~.x %>% 
        full_join(waffle_fill, by = "year_week_factor2") %>% 
        mutate(count = ifelse(is.na(count), 100, count)))

waffle_deaths <- waffle %>% 
  filter(deaths !=0) %>% 
  full_join(data.frame(etablissement_recu = unique(waffle$etablissement_recu))) %>% 
  split(.$etablissement_recu) %>% 
  map(~.x %>% 
        full_join(waffle_fill, by = "year_week_factor2") %>% 
        mutate(deaths = ifelse(is.na(deaths), 100, deaths)
        )
  )


waffle_graphs <- map2(waffle_counts, waffle_deaths,
    function(x,y){
      
      y_breaks_counts_breaks_a <- seq(floor(min(x$count) / 5), ceiling(max(x$count) / 5), by = 1)
      
      y_breaks_counts_breaks <- if(length(y_breaks_counts_breaks_a) > 3){seq(floor(min(x$count) / 5), ceiling(max(x$count) / 5), by = 2)} else {
        y_breaks_counts_breaks_a}
      y_breaks_counts_labs <- if(length(y_breaks_counts_breaks_a) > 3){seq(floor(min(x$count) / 5) * 5, ceiling(max(x$count) / 5) * 5, by = 10)} else {
        seq(floor(min(x$count) / 5) * 5, ceiling(max(x$count) / 5) * 5, by = 5)
      }
      

top <- x %>% 
ggplot(aes(fill = waffle_cat, values = count)) +
  geom_waffle(color = "white", size = .25, n_rows = 5, flip = TRUE) +
  facet_wrap(~year_week_factor2, nrow = 1, strip.position = "top", drop = FALSE) +
  scale_x_discrete(drop = FALSE) + 
  scale_y_continuous(breaks = y_breaks_counts_breaks,
                     labels =  y_breaks_counts_labs,#function(x) floor(x/5) + 5, 
                     expand = c(0,0))+
  scale_fill_identity()+
  coord_fixed()+
  theme_minimal()+
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    strip.text.x = element_text(size=8),
    axis.text.y = element_text(size=8),
    panel.grid.minor.y = element_blank(),

  # Legend
  legend.position = "top",
  legend.title = element_blank(),
  legend.spacing = unit(0.5, 'cm'),
  legend.key.height= unit(0.5, 'cm'),
  legend.key.width= unit(0.7, 'cm'),
  legend.text = element_text(size=8,
                             face = 'plain',
                             color = "grey10"))

if(all(is.na(y$waffle_cat))){bottom <-cowplot::ggdraw()+
  cowplot::draw_text("No deaths reported from this facility")} else{
    
   y_breaks_deaths_breaks_a <- seq(floor(min(x$deaths, na.rm = TRUE)/5),
                                       ceiling(max(x$deaths, na.rm = TRUE)/5),
                                       by = 1)
       
   y_breaks_deaths_breaks <- if(length(y_breaks_deaths_breaks_a) > 3){seq(floor(min(x$deaths, na.rm = TRUE) / 5), ceiling(max(x$deaths, na.rm = TRUE) / 5), by = 2)} else {
         y_breaks_deaths_breaks_a}
       y_breaks_deaths_labs <- if(length(y_breaks_deaths_breaks_a) >  3){seq(floor(min(x$deaths, na.rm = TRUE) / 5) * 5, ceiling(max(x$deaths, na.rm = TRUE) / 5) * 5, by = 10)} else {
         seq(floor(min(x$deaths, na.rm = TRUE) / 5) * 5, ceiling(max(x$deaths, na.rm = TRUE) / 5) * 5, by = 5)
       }
    
                 
                 bottom <- y %>% 
 ggplot(aes(fill = waffle_cat, values = deaths)) +
   geom_waffle(color = "white", size = .25, n_rows = 5, flip = TRUE) +
  facet_wrap(~year_week_factor2, nrow = 1, strip.position = "bottom", drop = FALSE) +
  scale_x_discrete(drop = FALSE) + 
   scale_y_continuous(breaks = y_breaks_deaths_breaks,
                     labels =  y_breaks_deaths_labs,
                     expand = c(0,0))+
   scale_fill_identity()+
   coord_fixed()+
   theme_minimal()+
   theme(
     axis.title = element_blank(),
     strip.text.x = element_text(size = 8),
     panel.grid.minor.y = element_blank(),
     axis.text.y = element_text(size=8),
   )
}
 
cowplot::plot_grid(top, NULL, NULL, bottom, ncol = 1, 
                   rel_heights = c(2, -0.4, -0.4, 2),
                   align = "hv", axis = "tblr", 
                   labels = c("Cases", "Deaths", NULL, NULL))

})



waffle_graphs_new <- waffle_graphs %>% 
  set_names(map(names(waffle_graphs), 
                ~str_replace_all(str_to_title(str_replace_all(.x, "_", " ")), 
                                 c("Csr" = "CSR", 
                                   "Cs" = "CS", 
                                   "Ps" = "PS", 
                                   "Hgr" = "HGR"))
                )
                )

```



```{r results='asis'}


 make_tab <- function(graph, name) {         # function to make the tabs
   cat("::: {.panel}\n")                     # Open tab
   cat("######", name, "{.panel-name}\n")    # Label tab
 
   print(graph)                              # Display plot
   
   cat("\n")                                 # Space
   cat(":::\n")                              # Close tab
 }


 
 walk2(waffle_graphs_new, names(waffle_graphs_new), ~make_tab(.x, .y))
 

   
```



```{r}

rm(waffle_graphs_new, waffle_graphs)

```

## **Deaths** {.tabset .tabset-pills}

```{r}

prop_var <- list("age_cat3",
                 "sexe", 
                 "etablissement_recu", 
                 "any_antimalarial",
                 "any_abx")

death_explore <- map(list(data_6, 
         mal, 
         resp, 
         resp_mal, 
         unk,
         other), 
    function(z){map(prop_var, function(x){
           y <- sym(x)
           a <- z %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1) %>% 
             mutate(across(where(is.logical), ~as.character(.x)))

         return(a)
           }) %>% 
        set_names(prop_var) %>% 
        list_rbind(names_to = "element") %>% 
        mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
        mutate(total = rowSums(select(., decede, non_decede)),
               cfr = round(100*decede/total, 1), 
               element = case_when(element == "age_cat3" ~ "Age (annees)", 
                             element == "sexe" ~ "Sexe",
                             element == "etablissement_recu" ~ "Formation Sanitaire",
                             .default = element), 
               category = case_when(category == "m" ~ "Masculin", 
                              category == "f" ~ "Feminin", 
                              .default = category)) %>% 
        select(Variable = element, 
               Groupe = category, 
               `Total (nombre)` = total, 
               `Taux de mortalite (%)` = cfr)}
         ) %>% 
  reduce(~left_join(.x, .y, by = c("Variable", "Groupe")))



death_explore_chart_a <- death_explore %>% 
  select(Variable, Groupe, starts_with("Taux")) %>% 
  ungroup() %>% 
  mutate(across(c(3:8), ~replace_na(.x, 0)), 
         Groupe = str_to_title(str_replace_all(Groupe, "_", " ")), 
         Groupe = str_replace_all(Groupe, c("Cs" = "CS", 
                                            "Ps" = "PS"))) %>% 
  rename(`Tous les cas` = 3, 
         `Paludisme uniquement` = 4, 
         `Maladie respiratoire` = 5, 
         `Palu ET respiratoire` = 6, 
         `Statut palu inconnu` = 7, 
         `Autres` = 8)
  
death_explore_chart <- death_explore_chart_a %>% 
  flextable::flextable() %>% 
  flextable::add_header_row(values = c("", "Taux de Mortalite (%)"),
                            colwidths = c(2, 6)) %>% 
  flextable::autofit()

death_explore_chart

```

```{r}

hf_with_deaths <- death_explore_chart_a %>% 
  filter(Variable == "Formation Sanitaire" & `Tous les cas` > 0 ) %>% 
  mutate(Groupe = str_to_lower(str_replace_all(Groupe, " ", "_")))

hf_with_deaths_full <- map(list(data_6, 
         mal, 
         resp, 
         resp_mal, 
         unk,
         other),~.x %>% 
           filter(decede_non == "decede") %>% 
           mutate(etablissement_recu = str_to_title(str_replace_all(etablissement_recu, "_", " ")), 
                  etablissement_recu = str_replace_all(etablissement_recu, c("Cs" = "CS", "Ps" = "PS"))) %>% 
           group_by(year_week_factor, etablissement_recu) %>% 
           summarise(count = n()) %>% 
           ungroup() %>% 
           complete(year_week_factor, etablissement_recu, fill = list(count = 0)) %>% 
           split(.$etablissement_recu) %>% 
           compact() %>% 
           map2(names(.), ~ggplot(.x)+
                  geom_col(aes(x = year_week_factor, y = count), 
                           fill = "firebrick4")+
                  labs(title = .y,
                       x = element_blank(), 
                       y = "Deaths")+
                  scale_y_continuous(breaks = c(0,5,10,15))+
                  theme(axis.text.x = element_blank(), 
                        panel.grid.minor.y = element_blank())+
                  coord_cartesian(ylim = c(0, 13))
                ))

combo_plot <- map(hf_with_deaths_full, ~cowplot::plot_grid(plotlist = .x, 
                                                           ncol = 1))


ggsave(combo_plot[[1]], filename = here::here("facility_deaths.png"),
       height = 20, 
       width = 4, 
       units = "in")
```

![](C:/Users/omp2/OneDrive - CDC/drc_panzi/facility_deaths.png)

```{r}

qui_decede_week <- map(list(data_6, 
         mal, 
         resp, 
         resp_mal, 
         unk,
         other),~.x %>% 
           split(.$decede_non) %>% 
           map(~.x %>% 
           mutate(etablissement_recu = str_to_title(str_replace_all(etablissement_recu, "_", " ")), 
                  etablissement_recu = str_replace_all(etablissement_recu, c("Cs" = "CS", "Ps" = "PS"))) %>% 
           group_by(year_week_factor) %>% 
           summarise(med_age = median(age_years, na.rm = TRUE), 
                     med_duration = median(duration_symp_consult, na.rm = TRUE), 
                     prop_antimal = round(100*sum(any_antimalarial == "TRUE", na.rm = TRUE)/
                       sum(!is.na(any_antimalarial)),1),
                     prop_abx = round(100*sum(any_abx == "TRUE", na.rm = TRUE)/
                       sum(!is.na(any_abx)),1)
                     )) %>% 
           reduce(~left_join(.x, .y, "year_week_factor")
                  )
) %>% 
  set_names("Tous Cas", "Palu seulement", 
            "Respiratoire Seulement", "Palu + Resp", 
            "Statut Palu inconnu", "Autres") %>% 
  list_rbind(names_to = "Diagnostiques") %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(year_week_factor = "Semaine", 
                               med_age.x = "Age médian\n(ans)",
                               med_duration.x = "Durée avant soins\n(jours)", 
                               prop_antimal.x = "Reçu antipaludéens\n(%)", 
                               prop_abx.x = "Reçu des antibiotiques\n", 
                               med_age.y = "Age médian\n(ans)",
                               med_duration.y = "Durée avant soins\n(jours)", 
                               prop_antimal.y = "Reçu antipaludéens\n(%)", 
                               prop_abx.y = "Reçu des antibiotiques\n") %>% 
  flextable::add_header_row(values = c("", "Décédés", "Non décédés"), 
                            colwidths = c(2,4,4)) %>% 
  flextable::vline(j = c(2,6))

qui_decede_week                               
                               
```

```{r}

qui_decede_hf <- map(list(data_6, 
         mal, 
         resp, 
         resp_mal, 
         unk,
         other),~.x %>% 
           split(.$decede_non) %>% 
           map(~.x %>% 
           mutate(etablissement_recu = str_to_title(str_replace_all(etablissement_recu, "_", " ")), 
                  etablissement_recu = str_replace_all(etablissement_recu, c("Cs" = "CS", "Ps" = "PS"))) %>% 
           group_by(etablissement_recu) %>% 
           summarise(med_age = round(median(age_years, na.rm = TRUE),1), 
                     med_duration = median(duration_symp_consult, na.rm = TRUE), 
                     prop_antimal = round(100*sum(any_antimalarial == "TRUE", na.rm = TRUE)/
                       sum(!is.na(any_antimalarial)),1),
                     prop_abx = round(100*sum(any_abx == "TRUE", na.rm = TRUE)/
                       sum(!is.na(any_abx)),1)
                     )) %>% 
           reduce(~left_join(.x, .y, "etablissement_recu")
                  )
) %>% 
  set_names("Tous Cas", "Palu seulement", 
            "Respiratoire Seulement", "Palu + Resp", 
            "Statut Palu inconnu", "Autres") %>% 
  list_rbind(names_to = "Diagnostiques") %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(etablissement_recu = "Formation Sanitaire", 
                               med_age.x = "Age médian\n(ans)",
                               med_duration.x = "Durée avant soins\n(jours)", 
                               prop_antimal.x = "Reçu antipaludéens\n(%)", 
                               prop_abx.x = "Reçu des antibiotiques\n", 
                               med_age.y = "Age médian\n(ans)",
                               med_duration.y = "Durée avant soins\n(jours)", 
                               prop_antimal.y = "Reçu antipaludéens\n(%)", 
                               prop_abx.y = "Reçu des antibiotiques\n") %>% 
  flextable::add_header_row(values = c("", "Décédés", "Non décédés"), 
                            colwidths = c(2,4,4)) %>% 
  flextable::vline(j = c(2,6))

qui_decede_hf

```

### By diagnosis and age {.tabset .tabset-pills}

#### Table

```{r}



test1 %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(`Total (nombre).x` = "Total (nombre)",
                               `Total (nombre).y` = "Total (nombre)", 
                               `Total (nombre).x.x` = "Total (nombre)", 
                               `Total (nombre).y.y` = "Total (nombre)", 
                               `Total (nombre).x.x.x` = "Total (nombre)", 
                               `Total (nombre).y.y.y` = "Total (nombre)", 
                               `Taux de mortalite (%).x` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).y` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).x.x` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).y.y` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).x.x.x` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).y.y.y` =  "Taux de mortalite (%)") %>% 
  flextable::add_header_row(values = c("", "All data", "Malaria only", 
                                       "Respiratory only", 
                                       "Respiratory and Malaria", 
                                       "TDR Unknown", 
                                       "Other"), 
                            colwidths = c(2, 2, 2, 2, 2, 2, 2)) %>% 
  flextable::vline(j = c(4,6,8,10,12)) %>% 
  flextable::autofit()



```

#### Malaria and Respiratory

```{r}
#data_6a <- data_6 %>% 
#  left_join(date_change, by = "n") %>% 
#  mutate(debut_change = as.Date(debut_change), 
#         consultation_change = as.Date(consultation_change),
#         date_debut_des_signes.x = case_when(!is.na(debut_change)~ debut_change, 
#                                             .default = date_debut_des_signes.x), 
#         date_de_consultation.x = case_when(!is.na(consultation_change)~ #consultation_change, 
#                                            .default = date_de_consultation.x)) %>% 
#  select(-c(duration_symp_consult.x)) %>% 
#  mutate(duration_symp_consult = lubridate::time_length(interval(date_debut_des_signes.x,
#                                                                 date_de_consultation.x), 
#                                                        "days"))
#
#test1 <- data_6 %>% 
#  filter(duration_symp_consult < 0 |duration_symp_consult >34 ) 
#

plots <- data_6 %>% 
  mutate(dz = case_when(tdr1 == "positif" & cough_fever != "both" ~ "Malaria only", 
                        cough_fever == "both" & tdr1 == "negatif" ~ "Respiratory only",
                        tdr1 == "positif" & cough_fever == "both" ~ "Malaria and Respiratory",
                        tdr1 == "unknown" ~ "Malaria Unknown", 
                        .default = "other")) %>% 
  split(.$dz) 

age_graphs <- plots %>% 
  map2(names(.),
       function(x,y){
         
         cases <- sum(x$decede_non == "non_decede")
         deaths <- sum(x$decede_non == "decede")
         
        a <-  x %>% 
        ggplot(aes(x = age_years, colour = decede_non))+
        stat_ecdf(linewidth = 1.5)+
        scale_color_manual(values = c("firebrick4", "cadetblue4"))+
        scale_x_continuous(breaks = c(0,5,15,25,50,75, Inf))+  
        theme_minimal()+
         labs(title = y,
              x = "Age (years)",
              y = "Empirical Cumulative Distribution",
              subtitle = paste0("Number surviving = ", cases,"\nNumber died = ", deaths))+
          theme(legend.position = "none", 
                panel.grid.minor.x = element_blank())
          
        
        return(a)
       }
  )
# if saving all

#  filenames <- map(names(plots), 
#                   ~paste0(here::here("mb_presentation", .x),"_age_distribution.png"))
#  
#  
#  walk2(age_graphs, filenames, ~ggsave(filename = .y, plot = .x,
#                                      dpi = 700, 
#                                      width = 13.2, 
#                                      height = 6.4, 
#                                      units = "in")
#  )

age_graphs[["Malaria and Respiratory"]]

```

#### Malaria only
```{r}

age_graphs[["Malaria only"]]

```


#### Respiratory only
```{r}

age_graphs[["Respiratory only"]]

```

#### Malaria Unknown
```{r}

age_graphs[["Malaria Unknown"]]

```


### By diagnosis and duration of symptoms {.tabset .tabset-pills}

#### Table

#### Malaria and Respiratory

```{r}

duration_graphs <- plots %>% 
  map(~.x %>% 
        filter(duration_symp_consult > 0 & duration_symp_consult < 100)) %>% 
  map2(names(.),
       function(x,y){
         
         cases <- sum(x$decede_non == "non_decede")
         deaths <- sum(x$decede_non == "decede")
         
         a <-  x %>% 
           ggplot(aes(x = duration_symp_consult, colour = decede_non))+
           stat_ecdf(linewidth = 1.5)+
           scale_color_manual(values = c("firebrick4", "cadetblue4"))+
           scale_x_continuous(breaks = c(0,1,2,3,4,5,10,15, 30,Inf))+  
           theme_minimal()+
           coord_cartesian(xlim = c(0, 35))+
           labs(title = y,
                x = "Duration illness onset to care (days)",
                y = "Empirical Cumulative Distribution",
                subtitle = paste0("Number surviving = ", cases,"\nNumber died = ", deaths))+
           theme(legend.position = "none", 
                 panel.grid.minor.x = element_blank())
         
         
         return(a)
       }
  )
  

# if saving
#   
#   filenames <- map(names(plots), 
#                    ~paste0(here::here("mb_presentation", .x),"_careseeking_distribution.png"))
#   
#   
#   walk2(duration_graphs, filenames, ~ggsave(filename = .y, plot = .x,
#                                        dpi = 700, 
#                                        width = 13.2, 
#                                        height = 6.4, 
#                                        units = "in"))
#         

duration_graphs[["Malaria and Respiratory"]]

```

#### Malaria only
```{r}

duration_graphs[["Malaria only"]]

```


#### Respiratory only
```{r}

duration_graphs[["Respiratory only"]]

```

#### Malaria Unknown
```{r}

duration_graphs[["Malaria Unknown"]]

```

### By diagnosis and documented treatments/complications {.tabset .tabset-pills}

#### Table

#### Malaria and Respiratory
```{r}      

antimal_graphs <- plots %>% 
        map(~.x %>% 
              mutate(any_artemisinins = case_when(is.na(any_artemisinins) ~ FALSE, 
                                                  .default = any_artemisinins)) %>% 
             # filter(!is.na(any_artemisinins)) %>% 
              group_by(decede_non) %>% 
              summarise(`Any antimalarial` = 100*sum(any_antimalarial == TRUE)/(sum(any_antimalarial == TRUE)+
                                                                    sum(any_antimalarial == FALSE)), 
                        `Any artemisinin` = 100*sum(any_artemisinins == TRUE, 
                                      na.rm = TRUE)/(sum(any_artemisinins == TRUE, 
                                                         na.rm = TRUE)+
                                                       sum(any_artemisinins == FALSE, 
                                                           na.rm = TRUE)),
                        `Any antibiotic` = 100*sum(any_abx == TRUE)/(sum(any_abx == TRUE)+
                                                        sum(any_abx == FALSE)),
                        Malnutrition = 100*sum(malnutrition == "malnutrition")/(sum(malnutrition == "malnutrition")+
                                                        sum(malnutrition == "no"))) %>% 
              ungroup() %>% 
              pivot_longer(-decede_non) %>% 
              mutate(name = factor(name, levels = c("Any antimalarial", 
                                                    "Any artemisinin", 
                                                    "Any antibiotic", 
                                                    "Malnutrition")))
            )%>% 
        map2(names(.),
             function(x,y){
               
               
               a <-  x %>% 
                 ggplot(aes(x = name, y = value, 
                            group = decede_non, fill = decede_non))+
                 geom_col(color = "grey35", 
                          position = "dodge")+
                 scale_fill_manual(values = c("firebrick4", "cadetblue4"))+
                 theme_minimal()+
                 coord_cartesian(ylim = c(0,100))+
                 labs(title = y,
                      x = element_blank(),
                      y = "Percentage")+
                 theme(legend.position = "none")
               
               
               return(a)
             }
        )

#filenames <- map(names(plots), 
#                       ~paste0(here::here("mb_presentation", .x),"_antimal_drug.png"))
#      
#      
#walk2(antimal_graphs, filenames, ~ggsave(filename = .y, plot = .x,
#                                                dpi = 700, 
#                                                width = 13.2, 
#                                                height = 6.4, 
#                                                units = "in")      
#)
#
#



antimal_graphs[[1]]

```

#### Malaria only
```{r}

antimal_graphs[["Malaria only"]]

```


#### Respiratory only
```{r}

antimal_graphs[["Respiratory only"]]

```

#### Malaria Unknown
```{r}

antimal_graphs[["Malaria Unknown"]]

```

## **Routine data** {.tabset}

### Routine data anomalies {.tabset .tabset-pills}
Monthly confirmed malaria cases and number of tests performed are graphed for 
each facility. Due to a high degree of data missingness

```{r}

routine_case <- routine_case_a %>% 
  pivot_longer(-c(1,2)) %>% 
  rename(hf = organisationunitname) %>% 
  mutate(month = word(name, 1, sep = " "), 
         month = factor(case_when(month == "Janvier" ~ "1", 
                           month == "Février" ~ "2",
                           month == "Mars"  ~ "3", 
                           month == "Avril"  ~ "4",
                           month == "Mai"  ~ "5", 
                           month == "Juin"  ~ "6",
                           month == "Juillet"  ~ "7", 
                           month == "Août"  ~ "8",
                           month == "Septembre"  ~ "9", 
                           month == "Octobre"  ~ "10",
                           month == "Novembre"  ~ "11", 
                           month == "Décembre" ~ "12"), 
                        levels = map(seq(1,12,1), ~as.character(.x))), 
         year = as.numeric(word(name, 2, sep = " "))) %>% 
  arrange(year, month) 


tdr_over5_a <- routine_case %>% 
  filter(dataname == "A 1.4 TDR positif >=5 ans") %>% 
  mutate(dataname = "num") %>% 
  group_by(hf, name) %>% 
  mutate(n = row_number()) %>% 
  ungroup() %>% 
  mutate(dataname = paste0(dataname, "_", n)) %>% 
  filter(dataname %in% c("num_1", "num_2")) %>%   ## no entries in 3 and 4; only one facility seems to have this
  select(-n) %>% 
  pivot_wider(names_from = "dataname", 
              values_from = "value") %>% 
  mutate(check = case_when(!is.na(num_1) & !is.na(num_2) ~ "error", 
                           .default = "okay"))

test <- tdr_over5_a %>% 
  filter(check == "error")

tdr_over5 <- tdr_over5_a %>% 
  mutate(hf_rdt_5plus = case_when(!is.na(num_1) ~ num_1, 
                           !is.na(num_2) ~ num_2,
                           is.na(num_1) & is.na(num_2) ~ NA_real_)
         )

tdr_under_5_a <-  routine_case %>% 
  filter(dataname %in% c("A 1.4 TDR positif 2 - < 5 ans", 
                         "A 1.4 TDR positif < 2 ans",
                         "A 1.4 TDR positif <5 ans")) %>% 
  mutate(scheme = case_when(dataname %in% c("A 1.4 TDR positif 2 - < 5 ans",
                                            "A 1.4 TDR positif < 2 ans") ~ "scheme_1", 
                            dataname == "A 1.4 TDR positif <5 ans" ~ "scheme_2")) %>% 
  group_by(hf, name, scheme) %>% 
  mutate(list = list(value)) %>% 
  ungroup() %>% 
  mutate(all_na = map_lgl(list, ~all(is.na(.x)))) %>% 
  group_by(hf, name) %>% 
  mutate(issue = map_lgl(list(all_na), ~all(.x == FALSE)))
    

tdr_under_5 <- tdr_under_5_a %>% 
  ungroup() %>% 
  group_by(hf, name) %>% 
  mutate(hf_rdt_cu5 = case_when(map_lgl(list(value), ~all(is.na(.x))) == TRUE ~ NA_real_, 
                           .default = sum(value, na.rm = TRUE))
         )%>% 
  distinct(hf, name, hf_rdt_cu5)


tdr_a <- left_join(tdr_over5, tdr_under_5, by =c("hf", "name")) %>% 
  select(-c(num_1, num_2))


#    Hmisc::describe(tdr$check) # all okay

tdr <- tdr_a %>% 
  select(-check)
  
########################### Community health ##################################

b_comm_data_a <- rio::import(here::here("routine_data", "b_tdr_cases.csv"))%>% 
    select(-c(1,3:5, 7:9)) %>% 
  pivot_longer(-c(1,2)) %>% 
  rename(hf = organisationunitname) %>% 
  mutate(month = word(name, 1, sep = " "), 
         month = factor(case_when(month == "Janvier" ~ "1", 
                           month == "Février" ~ "2",
                           month == "Mars"  ~ "3", 
                           month == "Avril"  ~ "4",
                           month == "Mai"  ~ "5", 
                           month == "Juin"  ~ "6",
                           month == "Juillet"  ~ "7", 
                           month == "Août"  ~ "8",
                           month == "Septembre"  ~ "9", 
                           month == "Octobre"  ~ "10",
                           month == "Novembre"  ~ "11", 
                           month == "Décembre" ~ "12"), 
                        levels = map(seq(1,12,1), ~as.character(.x))), 
         year = as.numeric(word(name, 2, sep = " "))) %>% 
  arrange(year, month) %>% 
  mutate(dataname = case_when(dataname == "B 10.2 TDRs réalisés  au SSC Dont positifs <5 ans" ~ "comm_cu_5_tdr", 
                              dataname == "B 10.2 TDRs réalisés  au SSC Dont positifs >=5 ans" ~ "comm_5_plus_tdr", 
                              .default = "error")) 
  


test <- b_comm_data_a |>
  dplyr::summarise(n = dplyr::n(), .by = c(hf, name, month, year, dataname)) |>
  dplyr::filter(n > 1L)

test_1 <- b_comm_data_a %>% 
  filter(hf %in%test$hf)

#  Hmisc::describe(test_1$value) # empty

b_comm_data <- b_comm_data_a %>% 
  filter(!hf %in%test$hf) %>% 
  pivot_wider(names_from = "dataname", 
              values_from = "value")

#   unique(b_comm_data$dataname)

##### microscopy #############################################################

d_micro_data_a <- rio::import(here::here("routine_data", "d_ge_cases.csv"))%>% 
    select(-c(1,3:5, 7,8)) %>% 
  pivot_longer(-c(1,2)) %>% 
  rename(hf = organisationunitname) %>% 
  mutate(month = word(name, 1, sep = " "), 
         month = factor(case_when(month == "Janvier" ~ "1", 
                           month == "Février" ~ "2",
                           month == "Mars"  ~ "3", 
                           month == "Avril"  ~ "4",
                           month == "Mai"  ~ "5", 
                           month == "Juin"  ~ "6",
                           month == "Juillet"  ~ "7", 
                           month == "Août"  ~ "8",
                           month == "Septembre"  ~ "9", 
                           month == "Octobre"  ~ "10",
                           month == "Novembre"  ~ "11", 
                           month == "Décembre" ~ "12"), 
                        levels = map(seq(1,12,1), ~as.character(.x))), 
         year = as.numeric(word(name, 2, sep = " "))) %>% 
  arrange(year, month) %>% 
  mutate(dataname = case_when(dataname == "D 5.3 Frottis réalisé dont Frottis positif - Examens positifs" ~ "ge_pos", 
                   dataname == "D 5.3 Malades testés GE et TDR - Examens positifs" ~ "ge_et_tdr_pos", 
                   .default = "error"))

test <- d_micro_data_a |>
  dplyr::summarise(n = dplyr::n(), .by = c(hf, name, month, year, dataname)) |>
  dplyr::filter(n > 1L)

test_1 <- d_micro_data_a %>% 
  filter(hf %in%test$hf)

#Hmisc::describe(test_1$value)   # is empty
d_micro_data <- d_micro_data_a %>% 
  filter(!hf %in%test$hf) %>% 
  pivot_wider(names_from = "dataname", 
              values_from = "value")



routine_data_panzi <- reduce(list(tdr, b_comm_data, d_micro_data), 
       ~full_join(.x,.y, by = c("hf", "name", "month", "year"))
) %>% 
  ungroup() 

################################ tests done ###################################

smear <- rio::import(here("routine_data", "ge_done.xlsx")) %>% 
  select(-c(1,3:5, 7,8)) %>% 
  mutate(across(where(is.character), ~str_replace_all(.x, "Ã©", "e"))) %>% 
  pivot_longer(-c(1,2)) %>% 
  rename(hf = organisationunitname) %>% 
  mutate(name = str_replace_all(name, c("Ã©" = "e", 
                                        "Ã»" = "u")), 
         month = word(name, 1, sep = " "), 
         month = factor(case_when(month == "Janvier" ~ "1", 
                           month == "Fevrier" ~ "2",
                           month == "Mars"  ~ "3", 
                           month == "Avril"  ~ "4",
                           month == "Mai"  ~ "5", 
                           month == "Juin"  ~ "6",
                           month == "Juillet"  ~ "7", 
                           month == "Aout"  ~ "8",
                           month == "Septembre"  ~ "9", 
                           month == "Octobre"  ~ "10",
                           month == "Novembre"  ~ "11", 
                           month == "Decembre" ~ "12"), 
                        levels = map(seq(1,12,1), ~as.character(.x))), 
         year = as.numeric(word(name, 2, sep = " "))) %>% 
  arrange(year, month) 

tests <- rio::import(here("routine_data", "tests_done.xlsx")) %>% 
  select(-c(1,3:5, 7,8)) %>% 
  mutate(across(where(is.character), ~str_replace_all(.x, "Ã©", "e"))) %>% 
  pivot_longer(-c(1,2)) %>% 
  rename(hf = organisationunitname) %>% 
  mutate(name = str_replace_all(name, c("Ã©" = "e", 
                                        "Ã»" = "u")),
         month = word(name, 1, sep = " "), 
         month = factor(case_when(month == "Janvier" ~ "1", 
                           month == "Fevrier" ~ "2",
                           month == "Mars"  ~ "3", 
                           month == "Avril"  ~ "4",
                           month == "Mai"  ~ "5", 
                           month == "Juin"  ~ "6",
                           month == "Juillet"  ~ "7", 
                           month == "Aout"  ~ "8",
                           month == "Septembre"  ~ "9", 
                           month == "Octobre"  ~ "10",
                           month == "Novembre"  ~ "11", 
                           month == "Decembre" ~ "12"), 
                        levels = map(seq(1,12,1), ~as.character(.x))), 
         year = as.numeric(word(name, 2, sep = " "))) %>% 
  bind_rows(smear) %>% 
  arrange(year, month, hf, dataname) 

rm(smear)

#### RDTs ##################

tdr_performed_over5_a <- tests %>% 
  filter(dataname == "A 1.4 TDR realise >=5 ans") %>% 
  mutate(dataname = "num") %>% 
  group_by(hf, name) %>% 
  mutate(n = row_number()) %>% 
  ungroup() %>% 
  mutate(dataname = paste0(dataname, "_", n)) %>% 
  filter(dataname %in% c("num_1", "num_2")) %>%   ## no entries in 3 and 4; only one facility seems to have this
  select(-n) %>% 
  pivot_wider(names_from = "dataname", 
              values_from = "value") %>% 
  mutate(check = case_when(!is.na(num_1) & !is.na(num_2) ~ "error", 
                           .default = "okay"))

issues <- tdr_performed_over5_a %>% 
  filter(check == "error")  # no issues

tdr_over5 <- tdr_performed_over5_a %>% 
  mutate(hf_rdt_5plus = case_when(!is.na(num_1) ~ num_1, 
                           !is.na(num_2) ~ num_2,
                           is.na(num_1) & is.na(num_2) ~ NA_real_)
         )

tdr_performed_under_5_a <-  tests %>% 
  filter(dataname %in% c("A 1.4 TDR realise 2 - < 5 ans", 
                         "A 1.4 TDR realise < 2 ans",
                         "A 1.4 TDR realise <5 ans")) %>% 
  mutate(scheme = case_when(dataname %in% c("A 1.4 TDR realise 2 - < 5 ans", 
                                            "A 1.4 TDR realise < 2 ans") ~ "scheme_1", 
                            dataname == "A 1.4 TDR realise <5 ans" ~ "scheme_2")) %>% 
  group_by(hf, name, scheme) %>% 
  mutate(list = list(value)) %>% 
  ungroup() %>% 
  mutate(all_na = map_lgl(list, ~all(is.na(.x)))) %>% 
  group_by(hf, name) %>% 
  mutate(issue = map_lgl(list(all_na), ~all(.x == FALSE)))
    
issue <- tdr_performed_under_5_a %>% 
  filter(issue == TRUE) # no issues in terms of more than one scheme used for 
#                                                     same facility and period


tdr_under_5 <- tdr_performed_under_5_a %>% 
  ungroup() %>% 
  group_by(hf, name) %>% 
  mutate(hf_rdt_cu5 = case_when(map_lgl(list(value), ~all(is.na(.x))) == TRUE ~ NA_real_, 
                           .default = sum(value, na.rm = TRUE))
         )%>% 
  distinct(hf, name, hf_rdt_cu5)


tdr_a <- left_join(tdr_over5, tdr_under_5, by =c("hf", "name")) %>% 
  select(-c(num_1, num_2))


#    Hmisc::describe(tdr$check) # all okay

tdr_performed <- tdr_a %>% 
  select(-check)

#### community testing #######################################################

community_testing_a <- tests %>% 
  filter(dataname %in% c("B 10.2 TDRs realises au SSC <5 ans", 
                        "B 10.2 TDRs realises au SSC >=5 ans")) %>% 
  mutate(dataname = case_when(dataname == "B 10.2 TDRs realises au SSC <5 ans"~ "comm_cu_5_tdr", 
                              dataname == "B 10.2 TDRs realises au SSC >=5 ans" ~ "comm_5_plus_tdr", 
                              .default = "error"))

community_testing <- community_testing_a %>% 
  filter(hf =="kg Mulemba Poste de Sante")
#Hmisc::describe(community_testing$value)  # empty

community_testing <- community_testing_a %>% 
  filter(hf !="kg Mulemba Poste de Sante") %>% 
  pivot_wider(names_from = "dataname", 
              values_from = "value")
  
################ smears #####################################################

smear_a <- tests %>% 
  filter(dataname %in% c("A 1.4 GE realise 2 - < 5 ans",
                         "A 1.4 GE realise < 2 ans",
                         "A 1.4 GE realise >=5 ans") & !is.na(value)) %>% 
  group_by(hf, name) %>% 
  mutate(total = sum(value, na.rma = TRUE)) %>% 
  ungroup() %>% 
  distinct(hf, name, total)



# there are only 10 observations from 4 facilities; all from January 2025


smear_b <- tests %>% 
  filter(dataname == "A 1.4 GE realise") %>% 
  left_join(smear_a, by = c("hf", 
                            "name"))

smear_check <- filter(smear_b, !is.na(total))  # all hf submitting components 
                                               # failed to submit the total, will sub in

smear_a <- smear_b %>% 
  mutate(value = case_when(!is.na(total) ~ total, 
                           .default = value)) %>% 
  select(-total) 

smear <- smear_a %>% 
  filter(hf =="kg Mulemba Poste de Sante")
# Hmisc::describe(smear$value)  # empty

smear <- smear_a %>% 
  filter(hf !="kg Mulemba Poste de Sante") %>% 
  pivot_wider(names_from = "dataname", 
              values_from = "value")



routine_tests_performed_panzi <- reduce(list(tdr_performed, community_testing, smear), 
       ~full_join(.x,.y, by = c("hf", "name", "month", "year"))
) %>% 
  ungroup()  %>% 
  mutate(across(c(5:9), ~case_when(is.na(.x) ~ 0, 
                           .default = .x)), 
         tot = rowSums(select(.,c(5:9)), na.rm = TRUE))

routine_tests_performed_panzi_a <- routine_tests_performed_panzi %>% 
  mutate(across(c(5:9), ~case_when(.x == 0 ~ NA_real_, 
                           .default = .x))
  )

rio::export(routine_tests_performed_panzi_a, "routine_data/routine_tests_panzi.xlsx")

###############################


routine_data_panzi_out <- reduce(list(tdr, b_comm_data, d_micro_data), 
       ~full_join(.x,.y, by = c("hf", "name", "month", "year"))
) %>% 
  ungroup() %>% 
  mutate(across(c(5:10), ~case_when(is.na(.x) ~ 0, 
                           .default = .x)), 
         tot = hf_rdt_5plus + hf_rdt_cu5 + comm_cu_5_tdr + comm_5_plus_tdr + ge_pos, 
         equal = tot == ge_et_tdr_pos)

rio::export(routine_data_panzi_out, "routine_eval_panzi.xlsx")


missing_counts <- routine_data_panzi %>% 
  group_by(hf) %>% 
  summarise(rows = n(), 
            hf_rdt_5plus = sum(is.na(hf_rdt_5plus)), 
            hf_rdt_cu5 = sum(is.na(hf_rdt_cu5)), 
            comm_cu_5_tdr = sum(is.na(comm_cu_5_tdr)), 
            comm_5_plus_tdr = sum(is.na(comm_5_plus_tdr)),
            ge_pos = sum(is.na(ge_pos)),
            ge_et_tdr_pos = sum(is.na(ge_et_tdr_pos))
            ) %>% 
  ungroup() %>% 
  mutate(hf_rdt_equal = hf_rdt_5plus == hf_rdt_cu5, 
         comm_rdt_equal = comm_cu_5_tdr == comm_5_plus_tdr, 
         ge_equal = ge_pos == ge_et_tdr_pos, 
         sous_titre = paste0("Months data missing: \nHF RDT <5: ", 
                             hf_rdt_cu5, "; HF RDT >=5: ", 
                             hf_rdt_5plus, "\nComm RDT <5: ", comm_cu_5_tdr, 
                             "; Comm RDT >=5: ", comm_5_plus_tdr, 
                             "\nSmear: ", ge_pos))
  
missing_counts_list <- missing_counts %>% 
  select(hf, sous_titre) %>% 
  split(.$hf) %>% 
  map(~.x %>% 
        pull(sous_titre))


comm_rm <- missing_counts %>% 
  filter(comm_cu_5_tdr == rows & comm_5_plus_tdr == rows) %>% 
  pull(hf)

ge_rm <- missing_counts %>% 
  filter(ge_pos == rows & ge_et_tdr_pos == rows) %>% 
  pull(hf)

```


```{r eval = FALSE, echo = FALSE}

# Determination of outliers/anomalous values without imputation

ts <- routine_data_panzi_out %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_data_panzi_out$name))) %>% 
  select(hf, month_year, tot) %>% 
  pivot_wider(names_from = "hf", values_from = "tot")

ts_sts <- surveillance::sts(ts[,-1], 
                            start = c(2019, 1), 
                            frequency = 12)

farr <- surveillance::farringtonFlexible(ts_sts, 
                                         control = list(noPeriods=10,
                                              b=3, w=3, weightsThreshold=2.58,
                                              pThresholdTrend=1,
                                              alpha=0.05))


start_month <- as.numeric(word(glue::glue_collapse(as.character(farr@start),
                                                   sep = "_"), 2, 
                    sep = "_"))
start_year <- as.numeric(word(glue::glue_collapse(as.character(farr@start), 
                                                  sep = "_"), 1, 
                    sep = "_"))

lev <-  unlist(unlist(map(list(2022, 2023, 2024, 2025), 
    function(x)map(seq(1,12,1), function(a)paste0(x, "_", a))
)
))

a <- as.data.frame(farr@upperbound) %>% 
  pivot_longer(cols = everything()) %>% 
  group_by(name) %>% 
  mutate(month = row_number()) %>% 
  ungroup() %>% 
  mutate(month_trans_a = month-1+start_month+
           12, 
         month_trans = month_trans_a %% 12, 
         year_trans_a = month_trans_a %/% 12, 
         year_trans = year_trans_a-1+start_year,
         year_trans = case_when(month_trans == 0 ~ year_trans - 1, 
                                .default = year_trans), 
         month_trans = factor(as.character(case_when(month_trans == 0 ~ 12, 
                                        .default = month_trans)))) %>% 
  select(-c(month, month_trans_a, year_trans_a)) %>% 
  
  left_join(select(routine_data_panzi_out, hf, month, year, tot), 
            by = c("name" = "hf", 
                   "month_trans" = "month", 
                   "year_trans" = "year")) %>% 
  rename(threshold = value) %>% 
  mutate(outbreak = case_when(tot > threshold ~ "outbreak", 
                              tot <= threshold ~ "routine", 
                              is.na(threshold) ~ NA_character_, 
                              .default = "error"), 
         year_month = factor(paste0(year_trans, "_", month_trans), 
                             levels = lev), 
         labels = case_when(month_trans == 7 ~ paste0("July\n", year_trans), 
                            month_trans == 1 ~ paste0("January\n", year_trans), 
                            .default = ""), 
         name = str_replace_all(name, c("Hôpital" = "hopital", 
                                        "é" = "e"))
  )

x_axis <- a %>% 
  distinct(month_trans,year_trans, .keep_all = TRUE) %>% 
  pull(labels)

a_list <- a %>% 
  split(.$name) 


#  assessing tests performed #######


tests_farr <- routine_tests_performed_panzi %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_tests_performed_panzi$name))) %>% 
  select(hf, month_year, tot) %>% 
  pivot_wider(names_from = "hf", 
              values_from = "tot")


tests_sts <- surveillance::sts(tests_farr[,-1], 
                            start = c(2019, 1), 
                            frequency = 12)

farr_assay <- surveillance::farringtonFlexible(tests_sts, 
                                         control = list(noPeriods=10,
                                              b=3, w=3, weightsThreshold=2.58,
                                              pThresholdTrend=1,
                                              alpha=0.05))


start_month <- as.numeric(word(glue::glue_collapse(as.character(farr_assay@start), sep = "_"), 2, 
                    sep = "_"))
start_year <- as.numeric(word(glue::glue_collapse(as.character(farr_assay@start), sep = "_"), 1, 
                    sep = "_"))



b <- as.data.frame(farr_assay@upperbound) %>% 
  pivot_longer(cols = everything()) %>% 
  group_by(name) %>% 
  mutate(month = row_number()) %>% 
  ungroup() %>% 
  mutate(month_trans_a = month-1+start_month+
           12, 
         month_trans = month_trans_a %% 12, 
         year_trans_a = month_trans_a %/% 12, 
         year_trans = year_trans_a-1+start_year,
         year_trans = case_when(month_trans == 0 ~ year_trans - 1, 
                                .default = year_trans), 
         month_trans = factor(as.character(case_when(month_trans == 0 ~ 12, 
                                        .default = month_trans)))) %>% 
  select(-c(month, month_trans_a, year_trans_a)) %>% 
  
  left_join(select(routine_tests_performed_panzi, hf, month, year, tot), 
            by = c("name" = "hf", 
                   "month_trans" = "month", 
                   "year_trans" = "year")) %>% 
  rename(threshold = value) %>% 
  mutate(outbreak = case_when(tot > threshold ~ "outbreak", 
                              tot <= threshold ~ "routine", 
                              is.na(threshold) ~ NA_character_, 
                              .default = "error"), 
         year_month = factor(paste0(year_trans, "_", month_trans), 
                             levels = lev), 
         labels = case_when(month_trans == 7 ~ paste0("July\n", year_trans), 
                            month_trans == 1 ~ paste0("January\n", year_trans), 
                            .default = ""), 
         name = str_replace_all(name, "HÃ´pital", "hopital")
  )

b_list <- b %>% 
  split(.$name) 


hf_names <- map(names(a_list),~str_remove_all(.x, "kg "))

graphs <- pmap(list(a_list, hf_names, missing_counts_list, b_list),
       function(x,y,z,A){ top <- x %>% 
        ggplot()+
        geom_col(aes(x = year_month, y = tot, fill = outbreak), 
                 color = "black")+
        scale_fill_manual(values = c("firebrick4", "cadetblue4"))+
        scale_x_discrete(labels = x_axis)+
        geom_line(aes(x = year_month, y = threshold, group = 1), 
                  color = "grey35", 
                  linetype = "dotdash", 
                  linewidth = 1.5)+
        theme_minimal()+
        theme(legend.position = "none")+
        labs(y = "Reported Cases", 
             x = element_blank(), 
             title = y, 
             subtitle = z)
       
       bottom <- A %>% 
         ggplot()+
        geom_col(aes(x = year_month, y = tot, fill = outbreak), 
                 color = "black")+
        scale_fill_manual(values = c("#540b0e", "#fff3b0"))+
        scale_x_discrete(labels = x_axis)+
        geom_line(aes(x = year_month, y = threshold, group = 1), 
                  color = "grey35", 
                  linetype = "dotdash", 
                  linewidth = 1.5)+
        theme_minimal()+
        theme(legend.position = "none")+
        labs(y = "Tests Performed", 
             x = "Month", 
             subtitle = z)
       cowplot::plot_grid(top, bottom, ncol = 1, align = "hv", 
                          axis = "tblr")
       }
  )

a_b <- a %>% 
  mutate(name = str_replace_all(name, "é", "e")) %>% 
  select(name, year_month, cases = tot) %>% 
  left_join(select(b, name, year_month, tests = tot), 
            by = c("name", "year_month")) %>% 
  mutate(tpr = round(100*cases/tests,1), 
         year = word(year_month, 1, sep = "_"), 
         month = as.numeric(word(year_month, 2, sep = "_")))

tpr <- a_b %>% 
  split(.$name) %>% 
  map(~.x %>% 
ggplot()+
  geom_line(aes(x = month, y = tpr, group = year, color = year))
)


```

```{r}
#####       with imputation  ######################################

lev <-  unlist(unlist(map(list(2022, 2023, 2024, 2025), 
    function(x)map(seq(1,12,1), function(a)paste0(x, "_", a))
)
))
# cases

ts <- routine_data_panzi_out %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_data_panzi_out$name)), 
         across(c(5:10), ~case_when(.x == 0 ~ NA_real_, 
                                    .default = .x)
         )) %>% 
  select(-c(name, month, year, ge_et_tdr_pos, tot, equal)) %>% 
  pivot_longer(cols = c(2:6))

#test <- filter(ts, hf == "kg Panzi Hôpital Général de Référence", name == "ge_pos")

ts_list <- map(list("hf_rdt_5plus","hf_rdt_cu5",
                    "comm_cu_5_tdr", "comm_5_plus_tdr"), 
               ~ts %>% 
                 filter(name == .x) %>% 
                 split(.$hf) %>% 
                 map(~.x %>% 
                       imputeTS::na_seadec()) %>% 
                 list_rbind() %>% 
                 pivot_wider(names_from = "name", 
                             values_from = "value"))

ts_list_1 <- ts %>% 
  filter(name == "ge_pos") %>% 
  pivot_wider(names_from = "name", 
                             values_from = "value")

ts_list <- append(ts_list, list(ts_list_1)) %>% 
  set_names(unique(ts$name)) %>% 
  reduce(~left_join(.x,.y, by = c("hf", "month_year"))) %>% 
  mutate(across(c(3:7), ~replace_na(.x, 0)), 
         total = rowSums(select(., c(3:7)), na.rm = TRUE))

ts_imput_farr <- ts_list %>% 
  select(hf, month_year, total) %>% 
  pivot_wider(names_from = "hf", 
              values_from = "total")


cases_imput_sts <- surveillance::sts(ts_imput_farr[,-1], 
                            start = c(2019, 1), 
                            frequency = 12)

farr_imput_cases <- surveillance::farringtonFlexible(cases_imput_sts, 
                                         control = list(noPeriods=10,
                                              b=3, w=3, weightsThreshold=2.58,
                                              pThresholdTrend=1,
                                              alpha=0.05))


start_month <- as.numeric(word(glue::glue_collapse(as.character(farr_imput_cases@start),
                                                   sep = "_"), 2, 
                    sep = "_"))
start_year <- as.numeric(word(glue::glue_collapse(as.character(farr_imput_cases@start),
                                                  sep = "_"), 1, 
                    sep = "_"))

#unique(word(unique(ts_list$month_year), 1, sep = " "))

ts_list_join <- select(ts_list, hf, month_year, total) %>% 
  mutate(month = factor(as.character(case_when(word(month_year, 1, sep = " ") == "Janvier" ~ 1, 
                           word(month_year, 1, sep = " ") == "Février" ~ 2,
                           word(month_year, 1, sep = " ") == "Mars" ~ 3, 
                           word(month_year, 1, sep = " ") == "Avril" ~ 4,
                           word(month_year, 1, sep = " ") == "Mai" ~ 5, 
                           word(month_year, 1, sep = " ") == "Juin" ~ 6,
                           word(month_year, 1, sep = " ") == "Juillet" ~ 7, 
                           word(month_year, 1, sep = " ") == "Août" ~ 8,
                           word(month_year, 1, sep = " ") == "Septembre" ~ 9, 
                           word(month_year, 1, sep = " ") == "Octobre" ~ 10,
                           word(month_year, 1, sep = " ") == "Novembre" ~ 11, 
                           word(month_year, 1, sep = " ") == "Décembre" ~ 12))), 
         year = as.numeric(word(month_year, 2, sep = " "))
  )


a_new_a <- as.data.frame(farr_imput_cases@upperbound) %>% 
  pivot_longer(cols = everything()) %>% 
  group_by(name) %>% 
  mutate(month = row_number()) %>% 
  ungroup() %>% 
  mutate(month_trans_a = month-1+start_month+
           12, 
         month_trans = month_trans_a %% 12, 
         year_trans_a = month_trans_a %/% 12, 
         year_trans = year_trans_a-1+start_year,
         year_trans = case_when(month_trans == 0 ~ year_trans - 1, 
                                .default = year_trans), 
         month_trans = factor(as.character(case_when(month_trans == 0 ~ 12, 
                                        .default = month_trans)))) %>% 
  select(-c(month, month_trans_a, year_trans_a)) %>% 
  left_join(select(ts_list_join, hf, month, year, total), 
            by = c("name" = "hf", 
                   "month_trans" = "month", 
                   "year_trans" = "year")) %>% 
  rename(threshold = value) %>% 
  mutate(outbreak = case_when(total > threshold ~ "firebrick4", 
                              total <= threshold ~ "cadetblue4", 
                              is.na(threshold) ~ NA_character_, 
                              .default = "error"), 
         year_month = factor(paste0(year_trans, "_", month_trans), 
                             levels = lev), 
         labels = case_when(month_trans == 7 ~ paste0("July\n", year_trans), 
                            month_trans == 1 ~ paste0("January\n", year_trans), 
                            .default = ""), 
         name = str_replace_all(name, "HÃ´pital", "hopital"), 
         name_match = str_remove_all(name, "kg | Poste de Santé|Poste de Santé| Centre de Santé| Hôpital Général de Référence| de Référence"), 
         name_match = str_to_lower(str_replace_all(name_match, c(" " = "_", 
                                                                 " / " = "_", 
                                                                 "/" = "_"))),
         name_match = case_when(name_match == "kambandambi" ~ "kamba_ndambi", 
                                name_match == "kiala_kamba" ~ "kiala_nkamba", 
                                name_match == "panzi___makita" ~ "makitapanzi", 
                                name_match == "tsakala_panzi" ~ "tshakala_panzi", 
                                name_match == "kambandambi" ~ "kamba_ndambi", 
                                .default = name_match)
  )

ll_monthly_summary <- data_6 %>% 
  ungroup() %>% 
  mutate(month = as.numeric(word(date_de_notification, 2, sep = "-")), 
         year = word(date_de_notification, 1, sep = "-")) %>% 
  group_by(etablissement_recu, month, year) %>% 
  summarise(total_cases = n(), 
            malaria = sum(tdr1 == "positif", na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(name_match = str_remove_all(etablissement_recu, c("hgr_|cs_|ps_")))



a_new <- a_new_a %>% 
  mutate(month_trans = as.numeric(as.character(month_trans)), 
         year_trans = as.character(year_trans)) %>% 
  left_join(ll_monthly_summary, by = c("name_match", 
                                       "month_trans" = "month", 
                                       "year_trans" = "year"))

x_axis <- a_new %>% 
  distinct(month_trans,year_trans, .keep_all = TRUE) %>% 
  pull(labels)


dx_method <- ts_list %>% 
  group_by(hf) %>% 
  summarise(hf_under5 = sum(hf_rdt_cu5), 
            hf_5plus = sum(hf_rdt_5plus), 
            community_under5 = sum(comm_cu_5_tdr), 
            community_5plus = sum(comm_5_plus_tdr), 
            smear = sum(ge_pos)) %>% 
  ungroup() %>% 
  mutate(method = case_when(community_under5 == 0 & community_5plus == 0 & smear == 0 ~ "RDT only", 
                             community_under5 == 0 & community_5plus == 0 ~ "RDT and smear", 
                             smear == 0 ~ "RDT and community", 
                             community_under5 != 0 & community_5plus != 0 & smear != 0 ~ "RDT, smear, and community", 
                             .default = "error"))

impute_label <- routine_data_panzi_out %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_data_panzi_out$name)), 
         across(c(5:10), ~case_when(.x == 0 ~ NA_real_, 
                                    .default = .x)
         )) %>% 
  select(hf, c(3:9)) %>% 
  left_join(select(dx_method, hf, method), by = "hf") %>% 
  mutate(hf_rdt_5plus = case_when(is.na(hf_rdt_5plus) ~ "†", 
                                  .default = NA_character_), 
         hf_rdt_cu5 = case_when(is.na(hf_rdt_cu5) ~ "*", 
                                  .default = NA_character_),
         comm_cu_5_tdr = case_when(is.na(comm_cu_5_tdr) & str_detect(method, "community") ~ "§", 
                                  .default = NA_character_),
         comm_5_plus_tdr = case_when(is.na(comm_5_plus_tdr) & str_detect(method, "community") ~ "¶", 
                                  .default = NA_character_)
      #   ge_pos = case_when(is.na(ge_pos) & str_detect(method, "smear")  ~ "#", 
      #                            .default = NA_character_)
      ) %>% 
  rowwise() %>% 
  mutate(impute = paste(na.omit(unlist(list(list(hf_rdt_cu5, hf_rdt_5plus, comm_cu_5_tdr, comm_5_plus_tdr#, ge_pos
                                                 )))),
                       collapse = ", ")
                     ) %>% 
  select(hf, month, year, impute)

a_new_1 <- a_new %>% 
  mutate(month_trans = factor(month_trans), 
         year_trans = as.numeric(year_trans)) %>% 
  left_join(impute_label, by = c("name" = "hf", 
                              "month_trans" = "month",
                              "year_trans" = "year"))
  


a_new_2 <- a_new_1 %>% 
  select(hf = name, threshold, year_month, total, outbreak, malaria, impute) %>% 
  pivot_longer(cols = c(4,6)) %>% 
  filter(!is.na(value)) %>% 
  mutate(outbreak = factor(case_when(name == "malaria" ~ "grey", 
                              .default = outbreak), 
                           levels = c("grey",
                                      "firebrick4", 
                                      "cadetblue4")
                           )
         )

a_new_list <- a_new_2 %>% 
  split(.$hf) 



################### tests  #############


ts <- routine_data_panzi_out %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_data_panzi_out$name)), 
         across(c(5:10), ~case_when(.x == 0 ~ NA_real_, 
                                    .default = .x)
         )) %>% 
  select(-c(name, month, year, ge_et_tdr_pos, tot, equal)) %>% 
  pivot_longer(cols = c(2:6))




tests_farr <- routine_tests_performed_panzi %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_tests_performed_panzi$name)), 
         across(c(5:9), ~case_when(.x == 0 ~ NA_real_, 
                                    .default = .x)
         )) %>% 
  rename(smear = `A 1.4 GE realise`) %>% 
  select(-c(name, month, year, tot)) %>% 
  pivot_longer(cols = c(2:6))



tests_list <- map(list("hf_rdt_5plus","hf_rdt_cu5",
                    "comm_cu_5_tdr", "comm_5_plus_tdr"), 
               ~tests_farr %>% 
                 filter(name == .x) %>% 
                 split(.$hf) %>% 
                 map(~.x %>% 
                       imputeTS::na_seadec()) %>% 
                 list_rbind() %>% 
                 pivot_wider(names_from = "name", 
                             values_from = "value")) 


tests_list_1 <- tests_farr %>% 
  filter(name == "smear") %>% 
  pivot_wider(names_from = "name", 
                             values_from = "value")

tests_list <- append(tests_list, list(tests_list_1)) %>% 
#  reduce(~left_join(.x,.y, by = c("hf", "month_year"))) %>% 
##  mutate(across(c(3:7), ~replace_na(.x, 0)), 
#         total = rowSums(select(., c(3:7)), na.rm = TRUE))%>% 
  set_names(list("hf_rdt_5plus","hf_rdt_cu5",
                    "comm_cu_5_tdr", "comm_5_plus_tdr", "smear")) %>% 
  reduce(~left_join(.x,.y, by = c("hf", "month_year"))) %>% 
  mutate(across(c(3:7), ~replace_na(.x, 0)), 
         total = rowSums(select(., c(3:7)), na.rm = TRUE))




dx_method_test <- tests_list %>% 
  group_by(hf) %>% 
  summarise(hf_under5 = sum(hf_rdt_cu5), 
            hf_5plus = sum(hf_rdt_5plus), 
            community_under5 = sum(comm_cu_5_tdr), 
            community_5plus = sum(comm_5_plus_tdr), 
            smear = sum(smear)) %>% 
  ungroup() %>% 
  mutate(method = case_when(community_under5 == 0 & community_5plus == 0 & smear == 0 ~ "RDT only", 
                             community_under5 == 0 & community_5plus == 0 ~ "RDT and smear", 
                             smear == 0 ~ "RDT and community", 
                             community_under5 != 0 & community_5plus != 0 & smear != 0 ~ "RDT, smear, and community", 
                             .default = "error"))

impute_label_test <- routine_tests_performed_panzi %>% 
  mutate(month_year = factor(name, 
                             levels = unique(routine_tests_performed_panzi$name)), 
         across(c(5:9), ~case_when(.x == 0 ~ NA_real_, 
                                    .default = .x)
         )) %>% 
  select(hf, c(3:9)) %>% 
  rename(smear = `A 1.4 GE realise`) %>% 
  left_join(select(dx_method_test, hf, method), by = "hf") %>% 
  mutate(hf_rdt_5plus = case_when(is.na(hf_rdt_5plus) ~ "†", 
                                  .default = NA_character_), 
         hf_rdt_cu5 = case_when(is.na(hf_rdt_cu5) ~ "*", 
                                  .default = NA_character_),
         comm_cu_5_tdr = case_when(is.na(comm_cu_5_tdr) & str_detect(method, "community") ~ "§", 
                                  .default = NA_character_),
         comm_5_plus_tdr = case_when(is.na(comm_5_plus_tdr) & str_detect(method, "community") ~ "¶", 
                                  .default = NA_character_)#,
         #smear = case_when(is.na(smear) & str_detect(method, "smear")  ~ "#", 
        #                          .default = NA_character_)
         ) %>% 
  rowwise() %>% 
  mutate(impute = paste(na.omit(unlist(list(list(hf_rdt_cu5, hf_rdt_5plus, comm_cu_5_tdr, comm_5_plus_tdr#, smear
                                                 )))),
                       collapse = ", ")
                     ) %>% 
  select(hf, month, year, impute)


ts_imput_tests_farr <- tests_list %>% 
  select(hf, month_year, total) %>% 
  pivot_wider(names_from = "hf", 
              values_from = "total")


tests_sts <- surveillance::sts(ts_imput_tests_farr[,-1], 
                            start = c(2019, 1), 
                            frequency = 12)

farr_impute_assay <- surveillance::farringtonFlexible(tests_sts, 
                                         control = list(noPeriods=10,
                                              b=3, w=3, weightsThreshold=2.58,
                                              pThresholdTrend=1,
                                              alpha=0.05))


start_month <- as.numeric(word(glue::glue_collapse(as.character(farr_impute_assay@start), sep = "_"), 2, 
                    sep = "_"))
start_year <- as.numeric(word(glue::glue_collapse(as.character(farr_impute_assay@start), sep = "_"), 1, 
                    sep = "_"))


ts_list_join <- select(tests_list, hf, month_year, total) %>% 
  mutate(month = factor(as.character(case_when(word(month_year, 1, sep = " ") == "Janvier" ~ 1, 
                           word(month_year, 1, sep = " ") == "Fevrier" ~ 2,
                           word(month_year, 1, sep = " ") == "Mars" ~ 3, 
                           word(month_year, 1, sep = " ") == "Avril" ~ 4,
                           word(month_year, 1, sep = " ") == "Mai" ~ 5, 
                           word(month_year, 1, sep = " ") == "Juin" ~ 6,
                           word(month_year, 1, sep = " ") == "Juillet" ~ 7, 
                           word(month_year, 1, sep = " ") == "Aout" ~ 8,
                           word(month_year, 1, sep = " ") == "Septembre" ~ 9, 
                           word(month_year, 1, sep = " ") == "Octobre" ~ 10,
                           word(month_year, 1, sep = " ") == "Novembre" ~ 11, 
                           word(month_year, 1, sep = " ") == "Decembre" ~ 12))), 
         year = as.numeric(word(month_year, 2, sep = " "))
  )

b <- as.data.frame(farr_impute_assay@upperbound) %>% 
  pivot_longer(cols = everything()) %>% 
  group_by(name) %>% 
  mutate(month = row_number()) %>% 
  ungroup() %>% 
  mutate(month_trans_a = month-1+start_month+
           12, 
         month_trans = month_trans_a %% 12, 
         year_trans_a = month_trans_a %/% 12, 
         year_trans = year_trans_a-1+start_year,
         year_trans = case_when(month_trans == 0 ~ year_trans - 1, 
                                .default = year_trans), 
         month_trans = factor(as.character(case_when(month_trans == 0 ~ 12, 
                                        .default = month_trans)))) %>% 
  select(-c(month, month_trans_a, year_trans_a)) %>% 
  left_join(select(ts_list_join, hf, month, year, total), 
            by = c("name" = "hf", 
                   "month_trans" = "month", 
                   "year_trans" = "year")) %>% 
  rename(threshold = value) %>% 
  mutate(outbreak = case_when(total > threshold ~ "#540b0e", 
                              total <= threshold ~ "#fff3b0", 
                              is.na(threshold) ~ NA_character_, 
                              .default = "error"), 
         year_month = factor(paste0(year_trans, "_", month_trans), 
                             levels = lev), 
         labels = case_when(month_trans == 7 ~ paste0("July\n", year_trans), 
                            month_trans == 1 ~ paste0("January\n", year_trans), 
                            .default = ""), 
         name = str_replace_all(name, "HÃ´pital", "hopital")
  ) %>% 
  left_join(impute_label_test, by = c("name" = "hf", 
                              "month_trans" = "month",
                              "year_trans" = "year"))

b_list_new <- b %>% 
  split(.$name) 


hf_names <- map(names(a_new_list),~str_remove_all(.x, "kg "))




graphs <- pmap(list(a_new_list, hf_names),
       function(x,y){ top <- x %>% 
        ggplot()+
        geom_col(aes(x = year_month, y = value, fill = outbreak, group = name), 
                 color = "black", 
                 position = position_dodge2(reverse = TRUE))+
        scale_fill_identity()+
        scale_x_discrete(labels = x_axis)+
        geom_line(aes(x = year_month, y = threshold, group = 1), 
                  color = "grey35", 
                  linetype = "dotdash", 
                  linewidth = 1.5)+
        geom_text(aes(x = year_month, y = 0, label = impute), 
                  angle = 90, 
                  hjust = 0)+
        theme_minimal()+
        theme(legend.position = "none")+
        labs(y = "Reported Cases", 
             x = "Month", 
             title = y) 
            # subtitle = z)
       return(top)
       }
  )

filename <- map(hf_names, 
                ~.x %>% 
                  str_remove_all(" Poste de Santé|Poste de Santé| Hôpital Général de Référence| Centre de Santé| de Référence") %>% 
                  str_replace_all(" ", "_") %>% 
                  str_to_lower()
) %>% 
  map(~paste0(here::here("mb_presentation", "facility_output"), "/", .x, ".png"))

walk2(filename, graphs, 
      ~ggsave(filename = .x, 
              plot = .y, 
              dpi = 700, 
              width = 13.2, 
              height = 6.4, 
              units = "in") ) 







graphs <- pmap(list(a_new_list, hf_names, b_list_new),
       function(x,y,z){ top <- x %>% 
        ggplot()+
        geom_col(aes(x = year_month, y = value, fill = outbreak, group = name), 
                 color = "black", 
                 position = position_dodge2(reverse = TRUE))+
        scale_fill_identity()+
        scale_x_discrete(labels = x_axis)+
        geom_line(aes(x = year_month, y = threshold, group = 1), 
                  color = "grey35", 
                  linetype = "dotdash", 
                  linewidth = 1.5)+
        geom_text(aes(x = year_month, y = 0, label = impute), 
                  angle = 90, 
                  hjust = 0)+
        theme_minimal()+
        theme(legend.position = "none")+
        labs(y = "Reported Cases", 
             x = element_blank(), 
             title = y) 
            # subtitle = z)
       
        bottom <- z %>% 
          ggplot()+
         geom_col(aes(x = year_month, y = total, fill = outbreak), 
                  color = "black")+
         scale_fill_identity()+
         scale_x_discrete(labels = x_axis)+
         geom_line(aes(x = year_month, y = threshold, group = 1), 
                   color = "grey35", 
                   linetype = "dotdash", 
                   linewidth = 1.5)+
         geom_text(aes(x = year_month, y = 0, label = impute), 
                  angle = 90, 
                  hjust = 0)+
         theme_minimal()+
         theme(legend.position = "none")+
         labs(y = "Tests Performed", 
              x = "Month")
       
       cowplot::plot_grid(top, bottom, ncol = 1, align = "hv", 
                          axis = "tblr")
       }
  )

filename <- map(hf_names, 
                ~.x %>% 
                  str_remove_all(" Poste de Santé|Poste de Santé| Hôpital Général de Référence| Centre de Santé| de Référence") %>% 
                  str_replace_all(" ", "_") %>% 
                  str_to_lower()
) %>% 
  map(~paste0(here::here("facility_output"), "/", .x, ".png"))

walk2(filename, graphs, 
      ~ggsave(filename = .x, 
              plot = .y, 
              dpi = 700, 
              width = 11, 
              height = 8, 
              units = "in"))

```

```{r results='asis'}

 make_tab <- function(graph, name) {         # function to make the tabs
   cat("::: {.panel}\n")                     # Open tab
   cat("####", name, "{.panel-name}\n")    # Label tab
 
   print(graph)                              # Display plot
   
   cat("\n")                                 # Space
   cat(":::\n")                              # Close tab
 }


 
 walk2(graphs, hf_names, ~make_tab(.x, .y))
 

```

### Routine test positivity rates {.tabset .tabset-pills}

```{r}

tpr_impute <- a_new_2 %>% 
  filter(outbreak != "grey") %>% 
  mutate(hf = str_replace_all(hf, c("é" = "e", 
                                    "ô" = "o", 
                                    "Hopital" = "hopital"))) %>% 
  select(hf, year_month, value) %>% 
  left_join(select(b, name, year_month, total), 
            by = c("hf" = "name", 
                   "year_month")) %>% 
  ungroup() %>% 
  mutate(tpr = 100*value/total)


levels <- map(list("2022", "2023", "2024"), 
              function(x)map(list("Jan", "Feb", "Mar", 
                                  "Apr", "May", "June", 
                                  "July", "Aug", "Sept", 
                                  "Oct", "Nov", "Dec"), 
                             function(y)paste0(x, " ", y))) %>% 
  unlist()

tpr_change_overall <- tpr_impute %>% 
  split(.$hf) %>%
  map(~.x %>% 
  arrange(year_month) %>% 
  mutate(lag_tpr = lag(tpr), 
         delta = tpr - lag_tpr)) %>% 
  list_rbind() %>% 
  group_by(year_month) %>% 
  mutate(mean = mean(delta, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(!is.na(lag_tpr)) %>% 
  select(-c(value, total, tpr, lag_tpr)) %>% 
  pivot_longer(-c(1,2)) %>% 
  mutate(year_month = factor(year_month), 
         hf = case_when(name == "mean" ~ "Mean", 
                        .default = hf),
         hf = str_remove_all(hf, "kg "),
         value = round(value, 1), 
         `Year Month` = str_replace_all(year_month, c("_12" = " Dec", 
                                                             "_11" = " Nov", 
                                                             "_10" = " Oct")), 
         `Year Month` = str_replace_all(`Year Month`, c("_1" = " Jan", 
                                                        "_2" = " Feb", 
                                                        "_3" = " Mar", 
                                                        "_4" = " Apr", 
                                                        "_5" = " May", 
                                                        "_6" = " June", 
                                                        "_7" = " July", 
                                                        "_8" = " Aug", 
                                                        "_9" = " Sept")), 
         `Year Month` = factor(`Year Month`, 
                               levels = levels)) %>% 
  distinct(hf, year_month, .keep_all = TRUE)


  

a <- ggplot(tpr_change_overall)+
  geom_line(aes(x = `Year Month`, 
                y = value, 
                group = hf, 
                color = name, 
                linewidth = name, 
                alpha = name))+
  scale_color_manual(values = c("grey35", 
                                  "cadetblue4"))+
  scale_linewidth_manual(values = c(0.3, 2))+
  theme_minimal()+
  labs(x = "Month", 
       y = "Absolute monthly change in TPR (Δ%)")+
  theme(legend.position = 'none', 
        axis.text.x = element_text(angle = 90))

plotly::ggplotly(a, tooltip = c("x", "y", "group"))

```

```{r}

library(wesanderson)

tpr_impute_graph <- tpr_impute %>% 
  split(.$hf) %>% 
  map2(map(names(.), ~str_remove_all(.x, "kg ")), 
       function(x,y){
        a <- x %>% 
        mutate(month = as.numeric(word(year_month, 2, sep = "_")), 
               year = word(year_month, 1, sep = "_"), 
               outbreak = case_when((month %in% c(10, 11, 12) & year == "2024") | (month ==1 & year == "2025") ~ "yes",
                                    .default = "no"))
         
        graph <- ggplot()+
          geom_line(data = a, aes(x = month, y = tpr, group = year, color = year), 
                    linewidth = 1.5)+
          scale_color_manual(values= wes_palette("Moonrise3", n = 5))+
          geom_point(data = filter(a, outbreak == "yes"), aes(x = month, y = tpr), 
                     colour = "firebrick4", 
                     size = 3)+
          scale_x_continuous(breaks = seq(1,12,1))+
          coord_cartesian(ylim = c(0,100))+
          theme_minimal()+
          labs(x = "Month", 
             y = "Test Positivity Rate (%)", 
             color = "Year",
             title = y)
        
        return(graph)
       }
      )

tpr_impute_graph[[1]]

```


```{r results='asis'}

 make_tab <- function(graph, name) {         # function to make the tabs
   cat("::: {.panel}\n")                     # Open tab
   cat("####", name, "{.panel-name}\n")    # Label tab
 
   print(graph)                              # Display plot
   
   cat("\n")                                 # Space
   cat(":::\n")                              # Close tab
 }


 
 walk2(tpr_impute_graph , map(names(tpr_impute_graph), ~str_remove_all(.x, "kg ")),
       ~make_tab(.x, .y))
 

```



##### Commodities

```{r}

com_24 <- rio::import("intrants.xlsx") %>% 
  linelist::clean_data() %>% 
  select(c(periodname,orgunitlevel5,organisationunitname,
           contains("jours_de_rupture_de_stock"))) %>% 
  rename(asaq_1 = 4, 
         asaq_2 = 5, 
         asaq_3 = 6, 
         asaq_4 = 7, 
         al_1 = 8,
         al_2 = 9, 
         al_3 = 10, 
         al_4 = 11, 
         at_inj = 12, 
         at_supp = 13, 
         tdr = 14, 
         sp = 15, 
         net = 16) %>% 
  mutate(across(c(asaq_1:net), ~as.numeric(as.character(.x))), 
         type = case_when(str_detect(orgunitlevel5, "centre_de_santa_C") ~ "cs", 
                          str_detect(orgunitlevel5, "poste_de_santa_C") ~ "ps",
                          str_detect(orgunitlevel5, "centre_de_santa_C_de_ra_C_fa_C_rence") ~ "csr",
                          str_detect(orgunitlevel5, "ha´pital_ga_C_na_C_ral_de_ra_C_fa_C_rence") ~ "hgr",
                          .default = NA_character_), 
         orgunitlevel5 = str_remove_all(orgunitlevel5, "kg_|                                          _poste_de_santa_C|_centre_de_santa_C_de_ra_C_fa_C_rence|_ha´pital_ga_C_na_C_ral_de_ra_C_fa_C_rence")) %>%  
         mutate(orgunitlevel5 = str_remove_all(orgunitlevel5, "poste_de_santa_C|_centre_de_santa_C"),
                name = paste0(type, "_", orgunitlevel5)) %>% 
  filter(!is.na(orgunitlevel5)) %>% 
  split(.$orgunitlevel5)
  
test <- com_24[["kidima_"]] %>% 
  summarise(across(c(asaq_1:net), function(x){all(is.na(x))})
  ) %>% 
  mutate(keep = any(c(asaq_1:net) == TRUE))

clifs_notes <- com_24 %>% 
  map(~.x %>% 
        summarise(across(c(asaq_1:net), function(x){all(is.na(x))})
  ) %>% 
  mutate(toss = all(c(asaq_1:net) == TRUE))) %>% 
  discard(~.x$toss == TRUE)

# only 4 facilities list stock outs of any kind during 2024


```



```{r eval=FALSE}

dhis_mod <- hf_dhis2 %>% 
  mutate(hf_dhis = str_remove_all(hf, c("kg|Centre de Santé|Poste de Santé|Hôpital Général de Référence|de Référence"))) %>% 
  linelist::clean_data(protect = c(T,T,F)) %>% 
  mutate(type_dhis = case_when(str_detect(hf, "Centre de Santé de Référence") ~ "csr", 
                          str_detect(hf, "Centre de Santé") ~ "cs", 
                          str_detect(hf, "Poste de Santé") ~ "ps", 
                          str_detect(hf, "Hôpital Général de Référence") ~ "hgr", 
                          .default = "error")
         )

hf_cases <- tibble(hf = unique(data_6$etablissement_recu)) %>% 
  mutate(type_cases = word(hf, 1, sep = "_"), 
         hf_cases = str_remove_all(hf, "cs_|ps_|hgr_"), 
         hf_cases = case_when(hf_cases == "makitapanzi" ~ "panzi_makita", 
                              hf_cases == "tshakala_panzi" ~ "tsakala_panzi",
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kiala_nkamba" ~ "kiala_kamba", 
                              .default = hf_cases)) %>% 
  select(-hf)

hf <- full_join(dhis_mod, hf_cases, by = c("hf_dhis" = "hf_cases"), keep = TRUE)

hf_case_not_dhis <- filter(hf, is.na(type_dhis))

orphan_cases <- data5_a %>% 
  rename(hf = etablissement_recu) %>% 
  mutate(type_cases = word(hf, 1, sep = "_"), 
         hf_cases = str_remove_all(hf, "cs_|ps_|hgr_"), 
         hf_cases = case_when(hf_cases == "makitapanzi" ~ "panzi_makita", 
                              hf_cases == "tshakala_panzi" ~ "tsakala_panzi",
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kamba_ndambi" ~ "kambandambi", 
                              hf_cases == "kiala_nkamba" ~ "kiala_kamba", 
                              .default = hf_cases)) %>% 
  filter(hf_cases %in% hf_case_not_dhis$hf_cases)


hf_dhis_no_cases <- filter(hf, is.na(type_cases))

```

```{r eval = FALSE}

## Focus on deaths by time and cause

mal <- filter(data_6, tdr1 == "positif" & cough_fever != "both")
resp <- filter(data_6, cough_fever == "both" & tdr1 == "negatif")
resp_mal <- filter(data_6, tdr1 == "positif" & cough_fever == "both")
unk <- filter(data_6, tdr1 == "unknown")



temp <- filter(data_6, cough_fever == "both" | tdr1 == "positif")
other <- filter(data_6, !n %in% temp$n)


all_deaths <- map(list(mal, resp, resp_mal, unk), 
    ~.x %>% 
      filter(decede_non == "decede") %>% 
      group_by(year_week_factor) %>% 
      summarise(count = n())
) %>% 
  set_names(c("malaria_only", "respiratory_only", 
              "malaria_and_respiratory", "unknown")) %>% 
  list_rbind(names_to = "presentation") %>% 
  complete(year_week_factor, presentation, fill = list(count = 0))

ggplot(all_deaths)+
  geom_col(aes(x = year_week_factor, y = count, 
               fill = presentation, group = presentation),
           position = "dodge")

```

```{r eval = FALSE}


sympt_specific_out <- function(x, db){
  y <- sym(x)
  a <- db %>% 
    ungroup() %>% 
    filter({{y}} == "oui") %>% 
    summarise(nombre = n(), 
              tpr = round(100*sum(tdr1 == "positif", na.rm = TRUE)/(sum(tdr1 == "negatif", 
                                                                        na.rm = TRUE) + 
                                                                      sum(tdr1 == "positif",
                                                                          na.rm = TRUE)),1),
              taux_mortalite = round(100*sum(evolution == "decede", na.rm = TRUE)/(sum(evolution != "decede", 
                                                                                       na.rm = TRUE)+sum(evolution == "decede", na.rm = TRUE)),2)
              )
  
  return(a)
  }


a <- map(names(data5[14:30]), ~sympt_specific_out(.x, data5)) %>% 
  set_names(names(data5[14:30])) %>% 
  list_rbind(names_to = "presentation")

rio::export(a, "outcome_par_symptom.xlsx")

a_flex <- a %>% 
  mutate(presentation = str_to_title(str_replace_all(presentation, "_", " "))) %>% 
  arrange(-nombre) %>% 
  rename("Symptômes" = presentation, 
         "Nombre de Cas" = nombre, 
         "Taux de positivité - TDR (%)" = tpr, 
         "Taux de mortalité (%)" = taux_mortalite) %>% 
  flextable::flextable() %>% 
  flextable::colformat_num(big.mark = "", digits = 1) %>% 
  flextable::autofit()

flextable::save_as_docx(a, path = paste0(here::here("linelist", 
                                                    "output", 
                                                    "symptom_outcome_all.docx")))




################################################################################
#############################################  complications ###################




```
