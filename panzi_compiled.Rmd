---
title: "Outbreak of Febrile illness with cough and increased mortality -- Panzi Health Zone, DRC"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
#runtime: shiny
output:
  html_document:
    code_folding: hide
    code_download: true
    highlight: zenburn
    number_sections: no
    theme: spacelab
    toc: no
    includes:
      in_header: header.html

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
#  {.tabset .tabset-fade}

## **Data cleaning** {.tabset .tabset-pills}


```{r}

if (!require("pacman")) install.packages("pacman")

pacman::p_load(rio, 
               Hmisc,
               downloadthis,
               flextable,
               viridisLite,
               stringdist,
               tidyverse)

pacman::p_install_gh("deansayre/Rtesunate")
pacman::p_install_gh("const-ae/ggupset")
pacman::p_install_gh("moodymudskipper/powerjoin")

library(ggupset)
library(Rtesunate)
library(powerjoin)


data_loc <- here::here("linelist", "LL_GPM_PANZI_23_01_2025_AS_RAJ.xlsx")

data <- rio::import(data_loc) %>% 
  Rtesunate::act_clean() %>% 
  rename(n = 1) %>% 
  mutate(id = row_number())

lab_loc <- here::here("linelist", "lab_linelist.xlsx")

lab_1 <- rio::import(lab_loc) %>% 
  Rtesunate::act_clean() %>% 
  select(-1) %>% 
  filter(!is.na(id)) %>% 
  filter(!is.na(noms))

lab_2 <- rio::import(here::here("linelist", "lab_linelist.xlsx"), which = 2) %>% 
  Rtesunate::act_clean() %>% 
  rename(id = labid) %>% 
  mutate(dte_de_reception = as.character(dte_de_reception)) %>% 
  filter(!is.na(id))


lab <- bind_rows(lab_1, lab_2) %>% 
  filter(!is.na(noms))

hf_dhis2 <- rio::import("dhis2_hf_names.xlsx") %>% 
  mutate(hf = case_when(str_detect(`kg Panzi Zone de Santé`, "Aire") ~ NA_character_, 
                                   .default = `kg Panzi Zone de Santé`),
         `kg Panzi Zone de Santé` = case_when(!is.na(hf) ~ NA_character_, 
                                              .default = `kg Panzi Zone de Santé`)
  ) %>% 
  fill(`kg Panzi Zone de Santé`, .direction = "down") %>% 
  filter(!is.na(hf))

hf_dhis2 %>% 
  Rtesunate::act_clean() %>% 
  rio::export(file = "hf_dhis2_usable.xlsx")


line_name <- word(data_loc, -1, sep = "/")  
line_last <- max(data$date_de_notification)

lab_name <- word(lab_loc, -1, sep = "/") 
lab_last <- max(lab$date_de_prelevement, na.rm = TRUE)

theme <- ggplot2::theme_minimal()
ggplot2::theme_set(theme)

color3 <- c( "firebrick4", "cadetblue4", "white")

```

Line list data (file name _`r line_name`_) contains `r nrow(data)` observations, 
the most recent of which is dated `r line_last`.

Lab data (file name _`r lab_name`_) contains `r nrow(lab)` observations, 
the most recent of which is dated `r lab_last`.

### Data missingness
The number of missing observations for each variable are noted below. 
Note variables are listed in snakecase.
```{r}

b <- map(names(data), 
         function(.x){x = sym(.x)
         data %>% 
           filter(is.na({{x}}))
         }
)

missing_obs <- map(b, ~nrow(.x)) %>% 
  as_vector() %>% 
  as_tibble() %>% 
  add_column(Variable = names(data), 
             .before = 1) %>% 
  rename(`Observations Missing` = value) %>% 
  filter(Variable != "id")


rm(b)

flextable::flextable(missing_obs) %>% 
  flextable::autofit()
  
```

### Spelling changes
Basic formatting and spelling changes are coded here. Explore code to review 
changes made, along with the Excel file below. 

```{r}


data_1a <- data %>% 
  mutate(tratement = str_replace_all(tratement, c("vit_c" = "vitc",
                                                  "vitce" = "vitc_vite",
                                                  "vit_ce" = "vitc_vite",
                                                  "vitace" = "vitc_vite",
                                                  "vita_c" = "vitc",
                                                  "vitac" = "vita_vitc", 
                                                  "vit_b12" = "vitb12",
                                                  "vit_b6" = "vitb6",
                                                  "at_60" = "at60", 
                                                  "para_injct" = "para-inject", 
                                                  "paracetamol_injct" = "para-inject",
                                                  "parainject" = "para-inject",
                                                  "para_inject" = "para-inject",
                                                  "para_inj" = "para-inject",
                                                  "acide_folique" = "acide-folique", 
                                                  "para" = "paracetamol", 
                                                  "artesunate_inj" = "artesunate-inj")
                                     )
  )# there will be an issue with entries containing multiple words as 
   # single entry when go to change pull individuals from these lists


data_char <- data_1a %>% 
  select(where(is.character)) %>% 
  select(-c(nom_et_postnom))

entered_values <- map(names(data_char), 
                      function(x){data_char %>% 
                          pull({{x}}) %>% 
                          unique()
                      }) %>% 
  set_names(names(data_char)) %>% 
  map(~as.data.frame(unlist(.x))
      )%>% 
  list_rbind(names_to = "variable") %>% 
  rename(entry = 2) %>% 
  arrange(variable, entry)

# uncomment below if need to update list of entries requiring spelling changes

#rio::export(entered_values, file = "entered_free_text.xlsx")

# spelling changes made and saved to separate file 'entered_free_text_with_spelling_change.xlsx'

spelling_changes <- rio::import("entered_free_text_with_spelling_change.xlsx") %>% 
  filter(!is.na(change_to))

data1 <- data_1a %>% 
  linelist::clean_variable_spelling(wordlists = spelling_changes,
                                    from = 2, 
                                    to = 3, 
                                    spelling_vars = 1)

data2 <- data1 %>%  
  mutate(age_unit = word(age, sep = "_", -1), 
         age1 = str_remove_all(age, paste0("_", age_unit)), 
         age2 = as.numeric(str_replace_all(age1, "_", "\\.")),
         age_years = case_when(age1 == "2ans" ~ 2, 
                               age1 == "4" ~ 4, 
                               age1 == "8_ans" ~ 8, 
                               age1 == "3mois" ~ 3/12,
                               age1 == "1omois" ~ 1/12, 
                               age1 == "18mois" ~ 18/12, 
                               age1 == "7mois" ~ 7/12, 
                               age1 == "1an" ~ 1,
                               age1 == "1ans" ~ 1,
                               age1 == "8ans" ~ 8,
                               age1 == "4_1_2" ~ 4.5, 
                               age1 == "3_ans_11" ~ 3+11/12,
                               age1 == "1_1_2" ~ 1.5,
                               age1 == "2_1_2" ~ 2.5,
                               age1 == "4_1_2" ~ 4.5,
                               age1 == "9mois" ~ 9/12,
                               age1 == "38a" ~ 38,
                               age_unit %in% c("m", "mois", "mos") ~ age2/12, 
                               age_unit %in% c("semaine", "semaines") ~ age2/52,
                               age_unit %in% c("ans", "asns", "an", "nas") ~ age2, 
                               .default = 999), 
         week = tsibble::yearweek(date_de_notification),
         paludisme_1 = case_when(paludisme == "palu" ~ "oui", 
                                 .default = paludisme), 
         tdr1 = case_when(tdr == "non.rensegne" ~ NA, 
                          .default = tdr)
         )

spell1 <- spelling_changes %>% 
 downloadthis::download_this(
    output_name = "panzi_spelling_change1",
    output_extension = ".xlsx",
    button_label = "Spelling Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```

```{r echo=FALSE}

spell1

```



### Duplicates


```{r}

rm(spell1)

####################################  search for duplicates using fuzzy matching
#### NOT complete as of 26 January, 2025. Response leadership to weigh in ######

# ensure Id provided is unique identifier
#  Hmisc::describe(data2$n)

data_dup <- data2 %>% 
  dplyr::select(date_de_notification, 
                name = nom_et_postnom,
                as, 
                sexe,
                age, 
                n) %>% 
  mutate(n = as.numeric(n)) %>% 
  full_join(., ., by = character()) %>% 
  filter(n.x < n.y) %>% 
  mutate(
    name.dist = stringdist(name.x, name.y), 
    as_same = as.x == as.y, 
    duration = lubridate::time_length(interval(date_de_notification.x, 
                                               date_de_notification.y), 
                                      "day")) %>% 
  filter(name.dist < 3) %>% 
  select(
    name.dist, 
    name.x, name.y, 
    sexe.x, sexe.y,
    date_de_notification.x, date_de_notification.y, 
    jours = duration, 
    as_same, as.x, as.y, 
    n.x, n.y) %>% 
  mutate(id_to_discard = NA) %>% 
  arrange(name.dist, jours, as_same)
  



# for manual examination
rio::export(data_dup, "doublants_possibles.xlsx")

doublants_vrai <- rio::import("doublants_possibles_vrai.xlsx")

data3 <- data2 %>% 
  filter(!n %in% doublants_vrai$id_to_discard)

dupes <- filter(doublants_vrai, !is.na(id_to_discard)) %>% 
 downloadthis::download_this(
    output_name = "panzi_dupes",
    output_extension = ".xlsx",
    button_label = "Duplicates",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```

A total of `r nrow(filter(doublants_vrai, !is.na(id_to_discard)))` duplicates
were removed, leaving a total of `r nrow(data3)` observations.


```{r echo=FALSE}

dupes

```

### Processing complication and treatment data
These data are entered as free text. Here they are standardized and processed
so as to be more useable. New variables for "any artemisinin received", "any 
antimalarial received" (artemisinin or quinine), and "any antibiotic received"
are created.

```{r}


datatx <- data3 %>% 
  select(n, tratement) %>% 
  mutate(tx_list = str_split(tratement, "_")) %>% 
  filter(!is.na(tx_list)) %>% 
  unnest_longer(tx_list)

datatx_unique <- datatx %>% 
  select(tx_list) %>% 
  distinct(tx_list) %>% 
  arrange(tx_list)

rio::export(datatx_unique, "linelist/output/tratement_sp.xlsx")

treatment_spelling <- rio::import(here::here("linelist", 
                                             "output", 
                                             "tratement_sp_edit.xlsx")) %>% 
  filter(!is.na(change_to))

datatx_sp <- datatx %>% 
  left_join(treatment_spelling, by = "tx_list") %>% 
  mutate(tx_list_sp = case_when(!is.na(change_to)~ change_to, 
                                .default = tx_list)) %>% 
  select(n, tx_list = tx_list_sp) %>% 
  filter(tx_list != "rm") %>% 
  group_by(n) %>% 
  arrange(tx_list, .by_group = TRUE) %>% 
  ungroup() %>% 
  filter(!str_detect(tx_list, "^\\d")) 

treatment_list <- datatx_sp %>% 
  group_by(n) %>% 
  summarise(tx = list(tx_list)) %>%
  rowwise() %>% 
  mutate(tx1 = paste(unlist(tx), collapse = "_"))



#unique(datatx_sp$tx_list)

data4 <- left_join(data3, treatment_list, by = "n") %>% 
  select(-tratement) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(any_artemisinins_a = list(map(c("act", 
                                          "artesunate",
                                          "aretesunate.rectal", 
                                          "asaq", 
                                          "artemether"),
                                        function(x) str_detect(tx1, fixed(x)))),
         any_artemisinins = any(any_artemisinins_a == TRUE),
         any_antimalarial = case_when(any_artemisinins == TRUE | str_detect(tx1, "quinine") ~ TRUE, 
                                      .default = FALSE),
         any_abx_a = list(map(c("amoxicilline", 
                                "azithromycine", 
                                "ceftriaxone", 
                                "erytromycine",
                                "bactrim",
                                "genta"),
                              function(x) str_detect(tx1, fixed(x)))),
         any_abx = any(any_abx_a == TRUE), 
         complications = str_replace_all(complications, "broncho_pulmonaire", 
                                         "broncho.pulmonaire"))



data_comp <- data4 %>% 
  select(n, complications) %>% 
  mutate(list = str_split(complications, "_")) %>% 
  filter(!is.na(complications)) %>% 
  unnest_longer(list)


data_comp_unique <- data_comp %>% 
  select(list) %>% 
  distinct(list) %>% 
  arrange(list)

rio::export(data_comp_unique, "linelist/output/complications_sp.xlsx")

complications_spelling <- rio::import(here::here("linelist", 
                                             "output", 
                                             "complications_sp_edit.xlsx")) %>% 
  filter(!is.na(change_to))



data_comp_sp <- data_comp %>% 
  left_join(complications_spelling, by = "list") %>% 
  mutate(comp_list_sp = case_when(!is.na(change_to)~ change_to, 
                                .default = list)) %>% 
  select(n, list = comp_list_sp) %>% 
  filter(list != "rm") %>% 
  group_by(n) %>% 
  arrange(list, .by_group = TRUE) %>% 
  ungroup() %>% 
  filter(!str_detect(list, "^\\d")) 

comp_list <- data_comp_sp %>% 
  group_by(n) %>% 
  summarise(comp = list(list)) %>%
  rowwise() %>% 
  mutate(tx1 = paste(unlist(comp), collapse = "_"))

#unique(data_comp_sp$list)

data5 <- left_join(data4, comp_list, by = "n") %>% 
  ungroup()


comp_spell_dl <- complications_spelling %>% 
 downloadthis::download_this(
    output_name = "complication_spell_changes",
    output_extension = ".xlsx",
    button_label = "Complications Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")


tx_spell_dl <- treatment_spelling %>% 
 downloadthis::download_this(
    output_name = "treatment_spell_changes",
    output_extension = ".xlsx",
    button_label = "Treatment Changes",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")

```


```{r echo = FALSE}

tx_spell_dl
comp_spell_dl

```


## **Presentation and outcomes** {.tabset .tabset-pills}
Additional information on patient presentation is provided in subsequent 
sections. This portion serves to ensure that all individuals included in the
data set meet the case definition. 

### Counts of individual symptoms
```{r}

symptoms <- data5 %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", "\n")),
         name = case_when(name == "Douleurs\nAu\nBas\nVentre" ~ "Douleurs\nau bas\nVentre", 
                          .default = name),
         name = fct_reorder(name, -count)) %>% 
  arrange(name)

ggplot(symptoms)+
  geom_col(aes(x = name, y = count))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Symptom", 
       y = "Count")
  

```

### Symptom combinations, clinical diagnoses and case fatality rate

**A** Upset plot of most common symptom combinations. Bar chart at the top 
represents case counts of the symptom combinations indicated by points below 
(individual symptoms present are indicated by black point). **B** Heatmap 
indicating the diagnoses listed for those with the symptom combinations above. 
Darker colors indicate a higher proportion of those with the symptom combination
being listed with the respiratory diagnosis (black = 100%, white = 0%). **C** 
Malaria RDT test positivity rate among those with above symptom combinations who
were tested for malaria. Those without RDT results are excluded. **D** Case fatality
rates of those presenting with above symptom combination. The black bar is the 
overall case fatality rate; red bars represent the case fatality rate for those 
with a positive RDT; green bars represent the case fatality rate for those 
with a negative RDT; white bars represent the case fatality rate for those that
do not have RDT information (and presumably were not tested for malaria).


```{r}

symptom_combo_upset_a <- data5 %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list = list(name)) %>% 
  ungroup() %>% 
  group_by(list) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  group_by(list) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  mutate(list_sx_1 = factor(map_chr(list, paste, collapse = ", ")),
         list_sx_1 = fct_reorder(list_sx_1, -count)) %>% 
  group_by(list) 

  
symptom_combo_upset <- symptom_combo_upset_a %>% 
  filter(id <= 20)



cols <-  c("fievre", "toux", "rhinorrhee", "dyspnee", 
                       "asthenie_physique", "courbatures",
 "cephalee", "frisson", "anorexie", "vomissement", "douleurs_abdominales",
 "diarrhee",  "douleurs_generalisees",   "lombalgie",  "douleurs_au_bas_ventre", 
 "douleurs_costales", "douleurs_testiculaires")

cols2 <- c("grippe", "bronchite", "ira", "syndrome_grippal",
           "pneumonie","broncho_pneumonie")


heatmap_dx_a <- data5 %>% 
  select(n, cols) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  summarise(list_sx = list(name)) %>% 
  ungroup() %>% 
  left_join(data5, by = "n") %>% 
  group_by(list_sx) %>% 
  summarise(across(cols2, 
                ~sum(.x == "oui", na.rm = TRUE)/(sum(.x == "oui", na.rm = TRUE) + 
                                                   sum(.x == "non", na.rm = TRUE)))) %>% 
  ungroup() %>% 
  pivot_longer(-1)

dx_single <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " ")), 
         name = case_when(name == "Ira" ~ "IRA", 
                          .default = name)) %>% 
  arrange(-count)
  
heatmap_dx <- heatmap_dx_a  %>% 
  mutate(list_sx_1 = factor(map_chr(list_sx, paste, collapse = ", "), 
                          levels = unique(symptom_combo_upset_a$list_sx_1)), 
         name = str_to_sentence(str_replace_all(name, "_", " ")), 
         name = case_when(name == "Ira" ~ "IRA", 
                          .default = name),
         name = factor(name, levels = rev(dx_single$name)))

heatmap_dx_graph <- heatmap_dx %>% 
  filter(list_sx_1 %in% symptom_combo_upset$list_sx_1)


symptom_other <- symptom_combo_upset_a %>% 
  left_join(select(data5, n, evolution, tdr), by = "n")

tpr_cfr_by_presentation <- symptom_other %>% 
  group_by(list_sx_1) %>% 
  summarise(tpr = 100*sum(tdr == "positif", na.rm = TRUE)/(sum(tdr == "positif", na.rm = TRUE)+
                                                         sum(tdr == "negatif", na.rm = TRUE)),
            cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  ) %>% 
  ungroup() 

tpr_cfr_by_presentation_strat <- symptom_other %>% 
  group_by(list_sx_1)%>% 
  mutate(tdr = factor(case_when(is.na(tdr) ~ "non.rensegne", 
                         .default = tdr), 
                      levels = c("positif", 
                                 "negatif", 
                                 "non.rensegne"))) %>% 
  group_by(list_sx_1, tdr) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )



tpr_cfr_by_presentation_graph <- tpr_cfr_by_presentation %>% 
  filter(list_sx_1 %in% symptom_combo_upset$list_sx_1) 

tpr_cfr_by_presentation_strat_graph <- tpr_cfr_by_presentation_strat %>% 
    filter(list_sx_1 %in% symptom_combo_upset$list_sx_1) 

top <- ggplot(symptom_combo_upset)+
  geom_bar(aes(x = list))+
  scale_x_upset(n_intersections = 20)+
  labs(x = element_blank(), 
       y = "Count")

heat <- ggplot(heatmap_dx_graph)+
  geom_tile(aes(x = list_sx_1, y = name, fill = value))+
  scale_fill_gradient(low = "white", high = "black")+
  theme(legend.position = "none",
        axis.text.x=element_blank())+
  labs(x = element_blank(), 
       y = "Clinical Diagnosis")

tpr_graph <- tpr_cfr_by_presentation_graph %>% 
  ggplot()+
  geom_col(aes(x = list_sx_1, 
               y = tpr), color = "black")+
  theme(axis.text.x=element_blank())+
  labs(x = element_blank(), 
       y = "RDT Test positivity (%)")

#devtools::install_github("wilkelab/ungeviz")

cfr_graph <-  ggplot()+
  geom_col(data = tpr_cfr_by_presentation_strat_graph, aes(x = list_sx_1, 
               y = cfr, 
               fill = tdr, 
               group = tdr), 
           color = "black", 
           position = position_dodge2(width = 0.9, preserve = "single"))+
  scale_fill_manual(values = c("firebrick4", 
                               "cadetblue4", 
                               "white"))+
  ungeviz::geom_hpline(data = tpr_cfr_by_presentation_graph, aes(x = list_sx_1, 
               y = cfr), 
           color = "black")+
  theme(axis.text.x=element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Case Fatality Rate (%)")

a <- cowplot::plot_grid(top, heat,  NULL, tpr_graph, NULL,
                   cfr_graph, 
                   ncol = 1, 
                   labels = c("A", "B", "", "C", "","D"),
                   rel_heights = c(1,1, -0.5, 1,-0.5, 1),
                   align = "hv", 
                   axis = "tblr")

ggsave(a, filename = here::here("output", "presentation_combo_outcome.png"), 
       dpi = 700, 
       height = 11, 
       width = 6, 
       units = "in")


```

![](output/presentation_combo_outcome.png)

## **Diagnoses and outcomes** {.tabset .tabset-pills}

### Counts of individual clinical diagnoses

```{r}

prop_var <- c("bronchite", "ira", "grippe", "syndrome_grippal",
                 "pneumonie","broncho_pneumonie", "paludisme_1", "tdr")

dx <- data5 %>%
  mutate(autres_diagnostics = na_if(autres_diagnostics, "non")) %>% 
             group_by(across(all_of(prop_var))) %>% 
             summarise(count = n()) 



dx_dl <- dx %>% 
 downloadthis::download_this(
    output_name = "diagnoses",
    output_extension = ".xlsx",
    button_label = "Diagnoses",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa-regular fa-arrow-down-to-line")



dx <- data5 %>% 
  select(n, 32:38) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " ")),
         name = case_when(name == "Ira" ~ "IRA", 
                          .default = name),
         name = fct_reorder(name, -count)) %>% 
  arrange(name)

ggplot(dx)+
  geom_col(aes(x = name, y = count))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Diagnosis", 
       y = "Count")
  
```

Click the button below to download a summary file of combinations of diagnoses
and tests.

```{r echo = FALSE}

dx_dl

```


### Focus on Malaria {.tabset .tabset-pills}

Summary: Clinical determination of malaria infection does not appear to be a 
reliable variable for analyses. HRP2-based rapid diagnostic tests may 
overestimate prevalence of active infections in highly endemic areas due to 
persistence of the antigen for 4 to 6 weeks after resolution of the infection, 
but remains a more reliable indicator of infection than clinical presentation 
alone. Future data collection efforts may benefit from additional questions of 
all individuals with a positive RDT documenting the history of recent malaria 
infection/treatment.

#### Permformance metrics of clinical classification in data set

```{r}


data5_a <- data5 %>% 
  mutate(decede_non = case_when(is.na(evolution) ~ NA_character_, 
                                evolution == "decede" ~ "decede", 
                                .default = "non_decede"), 
         age_cat1 = cut(age_years, c(0, 2, 5, 15, Inf)),
         age_cat2 = cut(age_years, c(0, 5, Inf)),
         age_cat3 = cut(age_years, c(0,2,5,15,25,35,45,55,65,Inf)),
         duration_symp_consult = lubridate::time_length(interval(date_debut_des_signes,
                                                                 date_de_consultation), 
                                                        "days"), 
         consult_pre_dec01 = case_when(date_de_consultation < "2024-12-01" ~ "pre_12_01", 
                                       date_de_consultation >= "2024-12-01" ~ "post_12_01", 
                                       is.na(date_de_consultation) ~ NA_character_, 
                                       .default = "error"), 
         year_week_factor = factor(paste(week), levels = unique(data2$week)),
         cough_fever = case_when(fievre == "oui" & toux == "oui" ~ "both", 
                                 fievre == "oui" & (toux == "non" | is.na(toux)) ~ "fever", 
                                 (fievre == "non" | is.na(fievre)) & toux == "oui" ~ "cough", 
                                 is.na(fievre) & is.na(toux) ~ "unknown",
                                 (fievre == "non" & is.na(toux)) | (is.na(fievre) & toux == "non") ~ "unknown",
                                 fievre == "non" & toux == "non" ~ "none",
                                 .default = "error"), 
         tdr1 = factor(case_when(is.na(tdr1) ~ "unknown",
                                 .default = tdr1), 
                       levels = c("unknown", 
                                  "negatif", 
                                  "positif"))
  )



metrics_overall <- data5_a %>% 
  group_by(paludisme_1, tdr1) %>% 
  summarise(counts = n()) %>% 
  ungroup()

temp <- metrics_overall %>% 
  filter(tdr1 != "unknown" & !is.na(paludisme_1)) %>% 
  group_by(tdr1) %>% 
  mutate(test_sums = sum(counts)) %>% 
  ungroup() %>% 
  group_by(paludisme_1) %>% 
  mutate(clin_sums = sum(counts)) %>% 
  ungroup() %>% 
  mutate(sens_spec = counts/test_sums, 
         ppv_npv = counts/clin_sums, 
         across(c(sens_spec, ppv_npv), ~round(100*.x, 1)))

sens <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), sens_spec)
sens_num <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), counts)
sens_den <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), test_sums)

spec <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), sens_spec)
spec_num <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), counts)
spec_den <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), test_sums)

ppv <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), ppv_npv)
ppv_num <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), counts)
ppv_den <- pull(filter(temp, paludisme_1=="oui" & tdr1 == "positif"), clin_sums)

npv <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), ppv_npv)
npv_num <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), counts)
npv_den <- pull(filter(temp, paludisme_1=="non" & tdr1 == "negatif"), clin_sums)

temp <- metrics_overall %>% 
  filter(tdr1 == "unknown" | is.na(paludisme_1)) 




tpr_weekly <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 != "unknown" & !is.na(paludisme_1)) %>% 
  group_by(tdr1, year_week_factor) %>% 
  mutate(test_sums = sum(counts)) %>% 
  ungroup() %>% 
  group_by(paludisme_1, year_week_factor) %>% 
  mutate(clin_sums = sum(counts)) %>% 
  ungroup() %>% 
  mutate(sens = ifelse(paludisme_1=="oui" & tdr1 == "positif", counts/test_sums,
                      NA), 
         spec = ifelse(paludisme_1=="non" & tdr1 == "negatif", counts/test_sums, 
                      NA),
         npv = ifelse(paludisme_1=="non" & tdr1 == "negatif", counts/clin_sums, 
                      NA),
         ppv = ifelse(paludisme_1=="oui" & tdr1 == "positif", counts/clin_sums, 
                      NA),
         across(c(sens,spec, ppv,npv), ~round(100*.x, 1))) %>% 
  filter((paludisme_1=="oui" & tdr1 == "positif") | (paludisme_1=="non" & tdr1 == "negatif")) %>% 
  pivot_wider(names_from = c("paludisme_1", "tdr1"), 
              values_from = c("counts", "test_sums", "clin_sums", 
                              "sens", "spec", 
                              "ppv", "npv")) %>% 
  janitor::remove_constant() %>% 
  arrange(year_week_factor) %>% 
  mutate(Sensitivity = paste0(sens_oui_positif, "% (", counts_oui_positif, "/", 
                              test_sums_oui_positif, ")"), 
         Specificity = paste0(spec_non_negatif, "% (", counts_non_negatif, "/", 
                              test_sums_non_negatif, ")"),
         PPV = paste0(ppv_oui_positif, "% (", counts_oui_positif, "/", 
                              clin_sums_oui_positif, ")"), 
         NPV = paste0(npv_non_negatif, "% (", counts_non_negatif, "/", 
                              clin_sums_non_negatif, ")")
  ) %>% 
  select(Week = year_week_factor, 
         Sensitivity, 
         Specificity, 
         PPV, 
         NPV) 




tpr_weekly_pos <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 == "positif") %>% 
  select(-tdr1) %>% 
  pivot_wider(names_from = "paludisme_1", 
              values_from = "counts") %>% 
  relocate(oui, .after = 1) %>% 
  rename(Week = year_week_factor, 
         `Paludisme clinique +` = oui, 
         `Paludisme clinique -` = non, 
         `Paludisme inconnu` = `NA`)

a <- sum(tpr_weekly_pos$`Paludisme clinique -`, na.rm = TRUE)

tpr_weekly_neg <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 == "negatif") %>% 
  select(-tdr1) %>% 
  pivot_wider(names_from = "paludisme_1", 
              values_from = "counts") %>% 
  relocate(oui, .after = 1) %>% 
  rename(Week = year_week_factor, 
         `Paludisme clinique +` = oui, 
         `Paludisme clinique -` = non)

b <- sum(tpr_weekly_neg$`Paludisme clinique -`, na.rm = TRUE)



tpr_weekly_unk <- data5_a %>% 
  group_by(paludisme_1, tdr1, year_week_factor) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  filter(tdr1 == "unknown") %>% 
  select(-tdr1) %>% 
  pivot_wider(names_from = "paludisme_1", 
              values_from = "counts") %>% 
  relocate(oui, .after = 1) %>% 
  rename(Week = year_week_factor, 
         `Paludisme clinique +` = oui, 
         `Paludisme clinique -` = non, 
         `Paludisme inconnu` = `NA`)

c <- sum(tpr_weekly_unk$`Paludisme clinique +`, na.rm = TRUE)+
  sum(tpr_weekly_unk$`Paludisme clinique -`, na.rm = TRUE)

flext_metrex <- reduce(list(tpr_weekly_pos, tpr_weekly_neg, tpr_weekly_unk), 
                       ~left_join(.x, .y, by = "Week")) %>% 
  arrange(Week) %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(`Paludisme clinique +.x` = "Paludisme clinique +",
                               `Paludisme clinique -.x` = "Paludisme clinique -",
                               `Paludisme clinique +.y` = "Paludisme clinique +",
                               `Paludisme clinique -.y` = "Paludisme clinique -", 
                               `Paludisme inconnu.x` = "Paludisme inconnu", 
                               `Paludisme inconnu.y` = "Paludisme inconnu") %>% 
  flextable::add_header_row(values = c(" ","TDR positif", "TDR negatif", "TDR non-realise"), 
                            colwidths = c(1,3,2,3)
                            ) %>% 
  flextable::vline(j = c(1,4,6))


flext_metrex

```


There were **`r a+b`** individuals incorrectly classified according TDR testing 
results, and another **`r c`** individuals given a malaria status without testing
results.

Performance metrics of clinical malaria classification versus RDT as gold 
standard: 

* Sensitivity: `r sens`% (`r sens_num`/`r sens_den`)
* Specificity: `r spec`% (`r spec_num`/`r spec_den`)
* Positive Predictive Value: `r ppv`% (`r ppv_num`/`r ppv_den`)
* Negative Predictive Value: `r npv`% (`r npv_num`/`r npv_den`)

Note that `r sum(temp$counts)` observations (of `r nrow(data5_a)`) are missing
RDT data and are not included above.

Weekly performance metrics are provided below.

```{r}

tpr_weekly %>% 
  flextable::flextable() %>% 
  flextable::autofit()

```

#### Clinical presentation of individuals classified as having malaria

```{r }
palu_pos_sym <- data5_a %>% 
  filter(paludisme_1 == "oui") %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  arrange(-counts)

palu_pos_tdr <- data5_a %>% 
  filter(paludisme_1 == "oui") %>% 
  select(n, 14:30, tdr1) %>% 
  pivot_longer(-c(n, tdr1)) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt, tdr1) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  select(-list_sympt)

palu_pos <- data5_a %>% 
  filter(paludisme_1 == "oui") %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  mutate(sympt = fct_reorder(sympt, count, .desc = TRUE))

palu_pos_graph <- palu_pos %>% 
  left_join(palu_pos_tdr, 
            by = "sympt") %>% 
  ungroup() %>% 
  mutate(sympt = fct_reorder(sympt, count.x, .desc = TRUE)) %>% 
  group_by(list_sympt) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  filter(id <= 20)

palu_pos_points <- palu_pos %>% 
  mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  mutate(
    symptoms = factor(symptoms, levels = palu_pos_sym$name),
    sympt = factor(sympt, levels = palu_pos$sympt)
  ) %>%  
  filter(!is.na(symptoms)) %>% 
  filter(list_sympt %in% palu_pos_graph$list_sympt)
  
single_sympt <- palu_pos_graph %>% 
    mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  group_by(symptoms, tdr1) %>% 
  summarise(count = sum(count.y, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(symptoms) %>% 
  mutate(total_count = sum(count)) %>% 
  ungroup() %>% 
  mutate(symptoms = factor(symptoms, levels = palu_pos_sym$name))


horizontal_bars <- ggplot(single_sympt)+
  geom_col(aes(x = -count, y = symptoms, fill = tdr1), color = "grey50")+
    scale_fill_manual(values = rev(color3))+
  scale_y_discrete(limits = rev)+
  scale_x_continuous(labels = function(x) abs(x))+
  theme(legend.position = "none", 
        axis.text.y = element_blank())+
  labs(x = element_blank(), 
       y = element_blank())

points <- palu_pos_points %>%  
  ggplot(aes(x = sympt, y = symptoms)) +
  geom_line(aes(group = sympt), col = 'grey50') +
  geom_point(size = 3, col = 'grey50') +
  scale_x_discrete(drop = TRUE)+
  scale_y_discrete(limits = rev, 
                   labels = rev(str_to_title(str_replace_all(sort(unique(single_sympt$symptoms)),
                                         "_", " "))))+
  theme(axis.text.x = element_blank())+
  labs(x = "Presentation", 
       y = element_blank())



plot_1 <- ggplot(palu_pos_graph)+
  geom_col(aes(x = sympt, y = count.y, fill = tdr1), 
           color = "grey50",
           position = "stack")+
  scale_fill_manual(values = rev(color3))+
  theme(axis.text.x = element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Counts")

legend <- cowplot::get_legend(palu_pos_graph %>% 
                                mutate(tdr1 = factor(case_when(tdr1 == "positif" ~ "Positif", 
                                                        tdr1 == "negatif" ~ "Negatif", 
                                                        tdr1 == "unknown" ~ "Pas d'information", 
                                                        .default = "erreur"), 
                                                     levels = c("Pas d'information", 
                                                                "Negatif", 
                                                                "Positif"))) %>% 
                                ggplot()+
  geom_col(aes(x = sympt, y = count.y, fill = tdr1), 
           color = "grey50",
           position = "stack")+
  scale_fill_manual(values = rev(color3))+
  theme(axis.text.x = element_blank())+
  labs(x = element_blank(), 
       y = "Counts", 
       fill = "TDR")
)

ggsave(cowplot::ggdraw(legend), 
       filename = here::here("output", "tdr_results.png"), 
       dpi = 700, 
       height = 3, 
       width = 2, 
       units = "in")


right <- cowplot::plot_grid(plot_1, points, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

left <- cowplot::plot_grid(NULL, horizontal_bars, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

full <- cowplot::plot_grid(left, right, ncol = 2,
                           rel_widths = c(1,3),
                   align = "hv", axis = "tb")


full
  

```


#### Clinical presentation of individuals classified as *NOT* having malaria

```{r }
palu_pos_sym <- data5_a %>% 
  filter(paludisme_1 == "non") %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(counts = n()) %>% 
  ungroup() %>% 
  arrange(-counts)

palu_pos_tdr <- data5_a %>% 
  filter(paludisme_1 == "non") %>% 
  select(n, 14:30, tdr1) %>% 
  pivot_longer(-c(n, tdr1)) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt, tdr1) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  select(-list_sympt)

palu_pos <- data5_a %>% 
  filter(paludisme_1 == "non") %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  distinct(n, .keep_all = TRUE) %>% 
  group_by(list_sympt) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(sympt = paste0(list_sympt, collapse = ", ")) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  mutate(sympt = fct_reorder(sympt, count, .desc = TRUE))

palu_pos_graph <- palu_pos %>% 
  left_join(palu_pos_tdr, 
            by = "sympt") %>% 
  ungroup() %>% 
  mutate(sympt = fct_reorder(sympt, count.x, .desc = TRUE)) %>% 
  group_by(list_sympt) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  filter(id <= 20)

palu_pos_points <- palu_pos %>% 
  mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  mutate(
    symptoms = factor(symptoms, levels = palu_pos_sym$name),
    sympt = factor(sympt, levels = palu_pos$sympt)
  ) %>%  
  filter(!is.na(symptoms)) %>% 
  filter(list_sympt %in% palu_pos_graph$list_sympt)
  
single_sympt <- palu_pos_graph %>% 
    mutate(symptoms = map(sympt, ~str_split_1(as.character(.), ", "))
         ) %>% 
  unnest(symptoms) %>% 
  ungroup() %>% 
  group_by(symptoms, tdr1) %>% 
  summarise(count = sum(count.y, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(symptoms) %>% 
  mutate(total_count = sum(count)) %>% 
  ungroup() %>% 
  mutate(symptoms = factor(symptoms, levels = palu_pos_sym$name))


horizontal_bars <- ggplot(single_sympt)+
  geom_col(aes(x = -count, y = symptoms, fill = tdr1), color = "grey50")+
    scale_fill_manual(values = rev(color3))+
  scale_y_discrete(limits = rev)+
  scale_x_continuous(labels = function(x) abs(x))+
  theme(legend.position = "none", 
        axis.text.y = element_blank())+
  labs(x = element_blank(), 
       y = element_blank())

points <- palu_pos_points %>%  
  ggplot(aes(x = sympt, y = symptoms)) +
  geom_line(aes(group = sympt), col = 'grey50') +
  geom_point(size = 3, col = 'grey50') +
  scale_x_discrete(drop = TRUE)+
  scale_y_discrete(limits = rev, 
                   labels = rev(str_to_title(str_replace_all(sort(unique(single_sympt$symptoms)),
                                         "_", " ")))
                   )+
  theme(axis.text.x = element_blank())+
  labs(x = "Presentation", 
       y = element_blank())



plot_1 <- ggplot(palu_pos_graph)+
  geom_col(aes(x = sympt, y = count.y, fill = tdr1), 
           color = "grey50",
           position = "stack")+
  scale_fill_manual(values = rev(color3))+
  theme(axis.text.x = element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Counts")


right <- cowplot::plot_grid(plot_1, points, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

left <- cowplot::plot_grid(NULL, horizontal_bars, ncol = 1,
                            rel_heights = c(5,2),
                            align = "hv", axis = "tblr")

full <- cowplot::plot_grid(left, right, ncol = 2,
                           rel_widths = c(1,3),
                   align = "hv", axis = "tb")


full
  

```

```{r}
a <- if(npv >=50){"did not have malaria"} else {"actually had malaria"}
```


Consistent with the NPV listed above, most individuals stated to be malaria 
negative by clinical means `r a`.

Clinical determination of 'malaria' will be ignored in favor of TDR results.

### Focus on Respiratory Diagonses 

Summary: Clinical determination of different respiratory infections does not 
appear to be reliable variable for analyses based on available information. 
Several diagnoses appear to have similar symptomatic profiles and do not 
correlate with outcomes. Fever and cough appear to be the most common and 
important symptoms noted by far; consider changing categorization of 'influenza'
to 'cough and fever' moving forward. Several individuals do not have documented 
evidence of these; consider dropping those observations as they are likely to be
unrelated and may artificially inflate counts. 



```{r}
cols <-  c("fievre", "toux", "rhinorrhee", "dyspnee", 
           "asthenie_physique", "courbatures",
           "cephalee", "frisson", "anorexie", "vomissement", 
           "douleurs_abdominales", "diarrhee",  "douleurs_generalisees",
           "lombalgie",  "douleurs_au_bas_ventre", 
           "douleurs_costales", "douleurs_testiculaires")

cols2 <- c("grippe", "bronchite", "ira", "syndrome_grippal",
           "pneumonie","broncho_pneumonie")



dx <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list = list(name)) %>% 
  ungroup() %>% 
  group_by(list) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  group_by(list) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  mutate(list_dx_1 = factor(map_chr(list, paste, collapse = ", ")),
         list_dx_1 = fct_reorder(list_dx_1, -count)) %>% 
  group_by(list) 
  
dx_combo_upset <- dx %>% 
  filter(id <= 20) 
  

  symptoms <- data5 %>% 
    select(n, cols) %>% 
    pivot_longer(-n) %>% 
    filter(value == "oui") %>% 
    group_by(name) %>% 
    summarise(count = n()) %>% 
    ungroup() %>% 
    mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
    arrange(-count)
  
#  symptom_combo_upset_a <- data5 %>% 
#    select(n, cols) %>% 
#    pivot_longer(-n) %>% 
#    filter(value == "oui") %>% 
#    mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
#    group_by(n) %>% 
#    summarise(list = list(name)) %>% 
#    ungroup() %>% 
#    group_by(list) %>% 
#    mutate(count = n()) %>% 
#    ungroup() %>% 
#    arrange(-count) %>% 
#    group_by(list) %>% 
#    mutate(id = cur_group_id()) %>% 
#    ungroup() %>% 
#    mutate(list_sx_1 = factor(map_chr(list, paste, collapse = ", ")),
#           list_sx_1 = fct_reorder(list_sx_1, -count)) %>% 
#    group_by(list) 
#  
#    
#  symptom_combo_upset <- symptom_combo_upset_a %>% 
#    filter(id <= 20)
#  

heatmap <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list_dx = list(name)) %>% 
  ungroup() %>% 
  left_join(data5, by = "n") %>% 
  group_by(list_dx) %>% 
  summarise(across(c(fievre:douleurs_testiculaires), 
                ~sum(.x == "oui", na.rm = TRUE)/(sum(.x == "oui", na.rm = TRUE) + 
                                                   sum(.x == "non", na.rm = TRUE)))) %>% 
  ungroup() %>% 
  pivot_longer(-1) %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " ")), 
         list_dx1 = factor(map_chr(list_dx, paste, collapse = ", "), 
                          levels = unique(dx$list_dx_1)), 
         name = factor(name, levels = rev(symptoms$name)))

heatmap_graph <- heatmap %>% 
  filter(list_dx1 %in% dx_combo_upset$list_dx_1)


dx_other <- dx %>% 
  left_join(select(data5, n, evolution, tdr), by = "n")


cfr_by_dx_strat <- dx_other %>% 
  mutate(tdr = factor(case_when(is.na(tdr) ~ "non.rensegne", 
                         .default = tdr), 
                      levels = c("positif", 
                                 "negatif", 
                                 "non.rensegne"))) %>% 
  group_by(list_dx_1, tdr) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )

cfr_by_dx <- dx_other %>% 
  group_by(list_dx_1) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )

cfr_graph_df <- map(list(cfr_by_dx_strat, cfr_by_dx), 
    ~.x %>% 
      filter(list_dx_1 %in% dx_combo_upset$list_dx_1) 
)



top <- ggplot(dx_combo_upset)+
  geom_bar(aes(x = list))+
  scale_x_upset()+
  labs(x = element_blank(), 
       y = "Count")
  
  
mid <- ggplot(heatmap_graph)+
  geom_tile(aes(x = list_dx1, y = name, fill = value))+
  scale_fill_gradient(low = "white", high = "black")+
  theme(legend.position = "none", 
        axis.text.x=element_blank())+
  labs(y = "Symptoms", 
       x = element_blank())


bottom <- ggplot()+
  geom_col(data = cfr_graph_df[[1]], aes(x = list_dx_1, 
               y = cfr, 
               fill = tdr, 
               group = tdr), 
           color = "black", 
           position = position_dodge2(width = 0.9, preserve = "single"))+
  scale_fill_manual(values = c("firebrick4", 
                               "cadetblue4", 
                               "white"))+
  ungeviz::geom_hpline(data = cfr_graph_df[[2]], aes(x = list_dx_1, 
               y = cfr), 
           color = "black")+
  theme(axis.text.x=element_blank(), 
        legend.position = "none")+
  coord_cartesian(ylim = c(0, 25))+
  labs(x = element_blank(), 
       y = "Case Fatality Rate (%)")


a <- cowplot::plot_grid(top, mid,  NULL, bottom,
                   ncol = 1, 
                   labels = c("A", "B", "", "C"),
                   rel_heights = c(1,1, -0.2, 1),
                   align = "hv", 
                   axis = "tblr")

ggsave(a, filename = here::here("output", "diagnosis_combo_outcome.png"), 
       dpi = 700, 
       height = 11, 
       width = 6, 
       units = "in")


```


#### Figure of outcomes

**A** Upset plot of most common clinical diagnosis combinations. Bar chart at the top 
represents case counts of the diagnosis combinations indicated by points below 
(individual symptoms present are indicated by black point). **B** Heatmap 
indicating the symptoms listed for those with the diagnosis combinations above. 
Darker colors indicate a higher proportion of those with the diagnosis combination
being listed with the symptoms exhibited (black = 100%, white = 0%). **C** Case 
fatality rates of those presenting with above diagnosis combination. The black bar is the 
overall case fatality rate; red bars represent the case fatality rate for those 
with a positive RDT; green bars represent the case fatality rate for those 
with a negative RDT; white bars represent the case fatality rate for those that
do not have RDT information (and presumably were not tested for malaria).


![](output/diagnosis_combo_outcome.png)

```{r eval = FALSE}

# to delete... superfluous

dx_combo_upset_a <- data5 %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  group_by(n) %>% 
  summarise(list = list(name)) %>% 
  ungroup() %>% 
  group_by(list) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  arrange(-count) %>% 
  group_by(list) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup() %>% 
  mutate(list_sx_1 = factor(map_chr(list, paste, collapse = ", ")),
         list_sx_1 = fct_reorder(list_sx_1, -count)) %>% 
  group_by(list) 

  
symptom_combo_upset <- symptom_combo_upset_a %>% 
  filter(id <= 20)



cols <-  c("fievre", "toux", "rhinorrhee", "dyspnee", 
                       "asthenie_physique", "courbatures",
 "cephalee", "frisson", "anorexie", "vomissement", "douleurs_abdominales",
 "diarrhee",  "douleurs_generalisees",   "lombalgie",  "douleurs_au_bas_ventre", 
 "douleurs_costales", "douleurs_testiculaires")

cols2 <- c("grippe", "bronchite", "ira", "syndrome_grippal",
           "pneumonie","broncho_pneumonie")


heatmap_dx_a <- data5 %>% 
  select(n, cols) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>% 
  summarise(list_sx = list(name)) %>% 
  ungroup() %>% 
  left_join(data5, by = "n") %>% 
  group_by(list_sx) %>% 
  summarise(across(cols2, 
                ~sum(.x == "oui", na.rm = TRUE)/(sum(.x == "oui", na.rm = TRUE) + 
                                                   sum(.x == "non", na.rm = TRUE)))) %>% 
  ungroup() %>% 
  pivot_longer(-1)

dx_single <- data5 %>% 
  select(n, cols2) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(name) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  arrange(-count)
  
heatmap_dx <- heatmap_dx_a  %>% 
  mutate(list_sx_1 = factor(map_chr(list_sx, paste, collapse = ", "), 
                          levels = unique(symptom_combo_upset_a$list_sx_1))
         , 
         name = factor(name, levels = rev(dx_single$name)))

heatmap_dx_graph <- heatmap_dx %>% 
  filter(list_sx_1 %in% symptom_combo_upset$list_sx_1)


symptom_other <- symptom_combo_upset_a %>% 
  left_join(select(data5, n, evolution, tdr), by = "n")

tpr_cfr_by_presentation <- symptom_other %>% 
  group_by(list_sx_1) %>% 
  summarise(tpr = 100*sum(tdr == "positif", na.rm = TRUE)/(sum(tdr == "positif", na.rm = TRUE)+
                                                         sum(tdr == "negatif", na.rm = TRUE)),
            cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  ) %>% 
  ungroup() 

tpr_cfr_by_presentation_strat <- symptom_other %>% 
  group_by(list_sx_1)%>% 
  mutate(tdr = factor(case_when(is.na(tdr) ~ "non.rensegne", 
                         .default = tdr), 
                      levels = c("positif", 
                                 "negatif", 
                                 "non.rensegne"))) %>% 
  group_by(list_sx_1, tdr) %>% 
  summarise(cfr = 100*sum(evolution == "decede", na.rm = TRUE)/sum(!is.na(evolution))
  )



tpr_cfr_by_presentation_graph <- tpr_cfr_by_presentation %>% 
  filter(list_sx_1 %in% symptom_combo_upset$list_sx_1) 

tpr_cfr_by_presentation_strat_graph <- tpr_cfr_by_presentation_strat %>% 
    filter(list_sx_1 %in% symptom_combo_upset$list_sx_1) 

top <- ggplot(symptom_combo_upset)+
  geom_bar(aes(x = list))+
  scale_x_upset(n_intersections = 20)+
  labs(x = element_blank(), 
       y = "Count")

heat <- ggplot(heatmap_dx_graph)+
  geom_tile(aes(x = list_sx_1, y = name, fill = value))+
  theme(legend.position = "none",
        axis.text.x=element_blank())+
  labs(x = element_blank(), 
       y = "Clinical Diagnosis")

tpr_graph <- tpr_cfr_by_presentation_graph %>% 
  ggplot()+
  geom_col(aes(x = list_sx_1, 
               y = tpr), color = "black")+
  theme(axis.text.x=element_blank())+
  labs(x = element_blank(), 
       y = "RDT Test positivity (%)")

#devtools::install_github("wilkelab/ungeviz")

cfr_graph <-  ggplot()+
  geom_col(data = tpr_cfr_by_presentation_strat_graph, aes(x = list_sx_1, 
               y = cfr, 
               fill = tdr, 
               group = tdr), 
           color = "black", 
           position = position_dodge2(width = 0.9, preserve = "single"))+
  scale_fill_manual(values = c("firebrick4", 
                               "cadetblue4", 
                               "white"))+
  ungeviz::geom_hpline(data = tpr_cfr_by_presentation_graph, aes(x = list_sx_1, 
               y = cfr), 
           color = "black")+
  theme(axis.text.x=element_blank(), 
        legend.position = "none")+
  labs(x = element_blank(), 
       y = "Case Fatality Rate (%)")

a <- cowplot::plot_grid(top, heat,  NULL, tpr_graph, NULL,
                   cfr_graph, 
                   ncol = 1, 
                   rel_heights = c(1,1, -0.4, 1,-0.4, 1),
                   align = "hv", 
                   axis = "tblr")

ggsave(a, filename = here::here("output", "presentation_combo_outcome.png"), 
       dpi = 700, 
       height = 11, 
       width = 6, 
       units = "in")


```


```{r eval = FALSE}

## Correlation of RDT positivity and mortality by clinical presentation

tpr_cfr_by_presentation_graph %>% 
  ggplot()+
  geom_point(aes(x = tpr, y = cfr))

```

#### Table of outcomes

```{r}

outcome_by_presentation <- data5 %>% 
  select(n, 14:30) %>% 
  pivot_longer(-n) %>% 
  filter(value == "oui") %>% 
  group_by(n) %>% 
  mutate(list_sympt = list(name)) %>% 
  ungroup() %>% 
  left_join(select(data3, n, tdr1, evolution), 
            by = "n") %>% 
  group_by(list_sympt) %>% 
  summarise(count = n(), 
            tpr = round(100*sum(tdr1 == "positif", na.rm = TRUE)/(sum(tdr1 == "negatif", 
                                                                      na.rm = TRUE) + 
                                                                    sum(tdr1 == "positif",
                                                                        na.rm = TRUE)),1),
            taux_mortalite = round(100*sum(evolution == "decede", na.rm = TRUE)/(sum(evolution != "decede", 
                                                                                    na.rm = TRUE)+sum(evolution == "decede", na.rm = TRUE)),1)
  ) %>% 
  arrange(-count, -taux_mortalite, -tpr) %>% 
  mutate(list_sympt1 = str_replace_all(str_to_title(map_chr(list_sympt, paste, 
                                                            collapse = ", ")),
                                       "_", " ")) %>% 
  rename(Presentation = list_sympt1, 
         Count = count, 
         `Test posititivity rate (%)` = tpr,
         `Case fatality rate (%)` = taux_mortalite) %>% 
  relocate(Presentation)


outcome_by_presentation %>% 
  select(-list_sympt) %>% 
  DT::datatable(filter = 'top')



all <- outcome_by_presentation %>% 
  select(-list_sympt) %>% 
  relocate(Presentation)

missing_one <- outcome_by_presentation %>% 
  rowwise() %>% 
  filter(!all(c("fievre", "toux") %in% list_sympt)) %>% 
  select(-list_sympt) %>% 
  relocate(Presentation)
  
missing_both <- outcome_by_presentation %>% 
    rowwise() %>% 
    filter(!any(c("fievre", "toux") %in%  list_sympt)) %>% 
  select(-list_sympt) %>% 
  relocate(Presentation) 
  
symptom_combos <- list(all, missing_one, missing_both)
    
 symptom_combos_flex <- symptom_combos %>% 
   map(~.x %>% 
        # rename("Symptômes" = presentation_clinique, 
        #        "Nombre de Cas" = nombre, 
        #        "Taux de positivité - TDR (%)" = tdr_positivite_pourcent, 
        #        "Taux de mortalité (%)" = taux_mortalite) %>% 
         flextable::flextable() %>% 
         flextable::colformat_num(big.mark = "", digits = 1) %>% 
         flextable::autofit()
       )
 
 
 
```
 


```{r echo = FALSE, include = FALSE}

 map2(symptom_combos_flex, 
      list("symptom_outcome_all", "symptom_outcome_missing_fever_and_or_cough", 
           "symptom_outcome_missing_both_fever_and_cough"), 
      function(x, y){flextable::save_as_docx(x, path = paste0(here::here("linelist", 
                                                                         "output"), "/", y, ".docx"))
      })
 
 
 
```


There are `r sum(symptom_combos[[3]]$Count, na.rm = TRUE)` patients that were 
listed without _either_ fever or cough. Clinical presentations, counts, malaria
RDT test positivity rate, and case fatality rates are listed below. 


```{r echo = FALSE}

symptom_combos_flex[[3]]

```



## **Epidemiological curves** {.tabset .tabset-pills}

```{r}
data_6 <- data5_a %>% 
  select(n,
         date_de_notification,
         date_debut_des_signes,
         date_de_consultation,
         etablissement_recu, 
         fievre, 
         toux,
         tdr1, 
         sexe, 
         age_years,
         tx,
         tx1.x,
         any_artemisinins_a,     
         any_artemisinins,
         any_antimalarial,
         any_abx_a, 
         any_abx, 
         comp, 
         tx1.y, 
         decede_non,
         age_cat1, 
         age_cat2,
         age_cat3, 
         duration_symp_consult,  
         consult_pre_dec01,
         year_week_factor,
         cough_fever) 

mal <- filter(data_6, tdr1 == "positif")
resp <- filter(data_6, cough_fever == "both")
resp_mal <- filter(data_6, tdr1 == "positif" & cough_fever == "both")

temp <- filter(data_6, cough_fever == "both" | tdr1 == "positif")
other <- filter(data_6, !n %in% temp$n)

mas <- filter(data_6, str_detect(tx1.y, "malnutrition"))

all_data <- list(data_6, 
                 mal, 
                 resp, 
                 resp_mal, 
                 other)

all_weeks <- tibble(week = unique(data_6$year_week_factor))

all_epicurves <- map(all_data, 
    ~.x %>% 
      group_by(year_week_factor) %>% 
      summarise(count = n(), 
                cfr = 100*sum(decede_non == "decede", na.rm = TRUE)/
                  (sum(decede_non == "decede", na.rm = TRUE)+
                     sum(decede_non == "non_decede", na.rm = TRUE))) %>% 
      ungroup() %>% 
      full_join(all_weeks, by = c("year_week_factor" = "week")) %>% 
      mutate(across(c(count, cfr), ~replace_na(.x, 0)))
)

temp <- all_epicurves[[2]]


epicurves <- map2(all_epicurves, list("grey",
                                     "firebrick4", 
                                     "cadetblue4", 
                                     "blueviolet", 
                                     "wheat4"),
                 function(x, y){
                   max <- max(all_epicurves[[1]]$count, na.rm = TRUE)
                   
                   a <-ggplot(x)+
                   geom_col(aes(x = year_week_factor, y = count), 
                            color = "black", 
                            fill = y)+
                     coord_cartesian(ylim = c(0, max+20))+
                     scale_x_discrete(breaks = unique(data_6$year_week_factor), 
                                      labels = unique(data_6$year_week_factor))+
                     labs(x = element_blank(), 
                          y = "Count")+
                     theme(axis.text.x = element_blank())
                    
                   
                   b <- ggplot(x)+
                     geom_col(aes(x = year_week_factor, y = cfr), 
                              fill = "grey35", 
                              color = "black")+
                     labs(x = "Week", 
                          y = "Case fatality\nrate (%)")+
                      theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                                      hjust = 1))
                   
                   cowplot::plot_grid(a,
                                      b,
                                      ncol = 1, 
                                      align = "hv", 
                                      axis = "tblr")
                                      
                 }
)

```

### All Cases

```{r}

epicurves[[1]]

```

### TDR Positive

```{r}

epicurves[[2]]

```

### Respiratory (Fever + Cough)

```{r}

epicurves[[3]]

```

### TDR Positive + Respiratory

```{r}

epicurves[[4]]

```

### Other (TDR negative/unknown + not _both_ fever and cough)

```{r}

epicurves[[5]]

```

### Malnutrition
Data on malnutrition are only available for `r nrow(mas)` individuals at the 
of coding; these are not shown graphically



## **Patient demographics**

### Table

```{r}

prop_var <- list("age_cat3",
                 "sexe")

map(prop_var, function(x){
           y <- sym(x)
           a <- data5_a %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1)

         return(a)
         }
         ) %>% 
  set_names(prop_var) %>% 
  list_rbind(names_to = "element") %>% 
  mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
  mutate(total = rowSums(select(., decede, non_decede)), 
         cfr = round(100*decede/total, 1), 
         element = case_when(element == "age_cat3" ~ "Age (annees)", 
                             element == "sexe" ~ "Sexe", 
                             .default = "error"), 
         category = case_when(category == "m" ~ "Masculin", 
                              category == "f" ~ "Feminin", 
                              .default = category)) %>% 
  rename(Variable = element, 
         Groupe = category, 
         "Decede\n(nombre)" = decede, 
         "Non decede\n(nombre)" = non_decede, 
         `Total (nombre)` = total, 
         `Taux de mortalite (%)` = cfr) %>% 
  flextable::flextable() %>% 
  flextable::autofit()
           
  
```

### Age/Sex Pyramid

```{r}

deces_5 <- data5_a %>% 
  filter(evolution == "decede")


prop_var <- list("age_cat1",
                 "age_cat2", 
                 "sexe", 
                 "as",
                 "fievre",
                 "toux", 
                 "cough_fever",
                 "consult_pre_dec01")

demo_prop_list <- map(prop_var, function(x){
           y <- sym(x)
           a <- data5_a %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1)

         return(a)
         }
         ) %>% 
  set_names(prop_var) %>% 
  list_rbind(names_to = "element") %>% 
  mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
  mutate(total = rowSums(select(., decede, non_decede)), 
         cfr = round(100*decede/total, 1))
  

age_pyr <- map(list(data5_a, deces_5),
               ~.x %>% 
  filter(!is.na(sexe)) %>% 
  group_by(age_cat3, sexe) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(count = ifelse(sexe == "f", -1*count, count)) %>% 
    ggplot()+
  geom_col(aes(x = age_cat3, y = count, fill = sexe))+
  scale_fill_manual(values = c("coral2", "cadetblue"))+
    theme_minimal()+
  coord_flip()+
    labs(y = "Count", 
         x = "Age category")+
    scale_y_continuous(labels = function(x) abs(x))
    
)

pyr_button <- download_this(age_pyr[[1]])

age_pyr[[1]]

```

```{r echo = FALSE}

pyr_button

```


```{r}

drc_pop <- rio::import("population_structure.xlsx") %>% 
  select(c(3,5,7,9)) %>% 
  mutate(across(everything(), ~as.numeric(str_remove_all(.x, ","))))

drc_pyr <- drc_pop %>% 
  rename(age = GROUP) %>% 
  mutate(age_cat = factor(case_when(age <= 2 ~ "(0,2]", 
                             age <=5 ~ "(2,5]",
                             age <=15 ~ "(5,15]",
                             age <=25 ~ "(15,25]",
                             age <=35 ~ "(25,35]",
                             age <=45 ~ "(35,45]",
                             age <=55 ~ "(45,55]",
                             age <=65 ~ "(55,65]",
                             age > 65 ~ "(65,Inf]", 
                             .default = "error"), 
                          levels = sort(unique(data5_a$age_cat3)))) %>% 
  filter(!is.na(age)) %>% 
  group_by(age_cat) %>% 
  summarise(m = sum(`Male Population`), 
            f = sum(`Female Population`)) %>% 
  ungroup() %>% 
  pivot_longer(-1) %>% 
  mutate(perc_tot_pop = 100*value/sum(.$value))

age_pyr <- data5_a %>% 
  filter(!is.na(sexe)) %>% 
  group_by(age_cat3, sexe) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(perc_tot_cases = 100*count/sum(.$count)) %>% 
  left_join(select(drc_pyr, age_cat, name, perc_tot_pop), 
            by = c("age_cat3" = "age_cat", 
                   "sexe" = "name"))

plot <- ggplot(age_pyr)+
  geom_abline(slope = 1,
              intercept = 0,
              color="grey80")+
  geom_point(aes(x = perc_tot_pop, y = perc_tot_cases, 
                 color = sexe, text = age_cat3))+
  scale_fill_manual(values = c("coral2", "cadetblue"))+
  labs(x = "Pourcentage de la population", 
       y = "Pourcentage des cas")+
  theme(legend.position = "none", 
        aspect.ratio=1)+
  coord_fixed(xlim = c(0,15), 
                  ylim = c(0,15))

plotly::ggplotly(plot, 
                 tooltip = "text")

```


```{r}

mal <- filter(data_6, tdr1 == "positif" & cough_fever != "both")
resp <- filter(data_6, cough_fever == "both" & tdr1 == "negatif")
resp_mal <- filter(data_6, tdr1 == "positif" & cough_fever == "both")
unk <- filter(data_6, tdr1 == "unknown")

temp <- filter(data_6, cough_fever == "both" | tdr1 == "positif")
other <- filter(data_6, !n %in% temp$n)


prop_var <- list("age_cat3",
                 "sexe")

test <- map(list(data_6, 
         mal, 
         resp, 
         resp_mal, 
         unk,
         other), 
    function(z){map(prop_var, function(x){
           y <- sym(x)
           a <- z %>%
             group_by(decede_non, {{y}}) %>% 
             summarise(count = n()) %>% 
             pivot_wider(names_from = "decede_non", 
                         values_from = "count") %>% 
             rename(category = 1)

         return(a)
           }) %>% 
        set_names(prop_var) %>% 
        list_rbind(names_to = "element") %>% 
        mutate(across(c(decede, non_decede), ~replace_na(.x, 0))) %>% 
        mutate(total = rowSums(select(., decede, non_decede)),
               cfr = round(100*decede/total, 1), 
               element = case_when(element == "age_cat3" ~ "Age (annees)", 
                             element == "sexe" ~ "Sexe", 
                             .default = "error"), 
               category = case_when(category == "m" ~ "Masculin", 
                              category == "f" ~ "Feminin", 
                              .default = category)) %>% 
        select(Variable = element, 
               Groupe = category, 
               `Total (nombre)` = total, 
               `Taux de mortalite (%)` = cfr)}
         ) %>% 
  reduce(~left_join(.x, .y, by = c("Variable", "Groupe"))) %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(`Total (nombre).x` = "Total (nombre)",
                               `Total (nombre).y` = "Total (nombre)", 
                               `Total (nombre).x.x` = "Total (nombre)", 
                               `Total (nombre).y.y` = "Total (nombre)", 
                               `Total (nombre).x.x.x` = "Total (nombre)", 
                               `Total (nombre).y.y.y` = "Total (nombre)", 
                               `Taux de mortalite (%).x` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).y` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).x.x` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).y.y` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).x.x.x` =  "Taux de mortalite (%)",
                               `Taux de mortalite (%).y.y.y` =  "Taux de mortalite (%)") %>% 
  flextable::add_header_row(values = c("", "All data", "Malaria only", 
                                       "Respiratory only", 
                                       "Respiratory and Malaria", 
                                       "TDR Unknown", 
                                       "Other"), 
                            colwidths = c(2, 2, 2, 2, 2, 2, 2)) %>% 
  flextable::vline(j = c(4,6,8,10,12)) %>% 
    flextable::autofit()

test

```


### Location

```{r}

case_loc_a <- data5_a %>% 
  group_by(decede_non, as, etablissement_recu) %>% 
  summarise(nombre = n(), 
            reported_cases = list(as.Date(date_de_consultation)),
            first_case = map(reported_cases, ~ min(.x, na.rm = TRUE)), 
            last_case = map(reported_cases, ~ max(.x, na.rm = TRUE)), 
            cases_with_rdt_results = sum(!is.na(tdr1)), 
            cases_with_pos_rdt = sum(tdr1 == "positif", na.rm = TRUE), 
            no_rdt = sum(is.na(tdr1)), 
            any_art = sum(any_artemisinins == TRUE)) %>% 
  ungroup() %>% 
  mutate(any_art = replace_na(any_art, 0), 
         tpr = cases_with_pos_rdt/cases_with_rdt_results) %>% 
  select(-reported_cases) %>% 
  pivot_wider(names_from = decede_non, 
              values_from = c(nombre, 
                              first_case, last_case, 
                              cases_with_rdt_results, 
                              cases_with_pos_rdt,
                              tpr,
                              no_rdt, 
                              any_art), 
              names_glue = "{decede_non}_{.value}")
  
### needs updating below with new variables; as well as adding totals  

case_loc <- case_loc_a %>% 
  relocate(as, etablissement_recu, 
           non_decede_nombre, non_decede_first_case, 
           non_decede_last_case, 
           decede_nombre, decede_first_case, decede_last_case) %>% 
  mutate(across(contains("nombre"), ~replace_na(.x, 0)), 
         cfr = round(100*decede_nombre/(decede_nombre+non_decede_nombre),1), 
         as = str_to_title(str_replace_all(as, "\\.", " ")), 
         etablissement_recu = str_to_title(str_replace_all(etablissement_recu,
                                                           "_", " ")), 
         etablissement_recu = str_replace_all(etablissement_recu, 
                                              c("Cs" = "CS", 
                                                "Ps" = "PS", 
                                                "Hgr" = "HGR"))) %>% 
  rowwise() %>% 
  mutate(overall_last = max(as.Date(non_decede_last_case), as.Date(decede_last_case),
                            na.rm = TRUE), 
         overall_first = min(as.Date(non_decede_first_case), as.Date(decede_first_case),
                            na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(across(c(decede_nombre, non_decede_nombre),~replace_na(.x, 0)), 
         cas_total = decede_nombre +non_decede_nombre, 
         overall_first = as.Date (overall_first), 
         overall_last = as.Date(overall_last)) %>% 
  select(`Aire de Sante` = as, 
         Etablissement = etablissement_recu, 
         `Decede (nombre)` = decede_nombre, 
         `Cas Total` = cas_total, 
         `Taux de Mortalite (%)` = cfr, 
         `Primier Cas` = overall_first, 
         `Dernier Cas` = overall_last, 
         `Dernier Dece` = decede_last_case
         ) %>% 
  arrange(-`Decede (nombre)`, -`Cas Total`) 

case_loc %>% 
  DT::datatable(filter = 'top')

```


```{r eval = FALSE}

## Focus on deaths by time and cause

mal <- filter(data_6, tdr1 == "positif" & cough_fever != "both")
resp <- filter(data_6, cough_fever == "both" & tdr1 == "negatif")
resp_mal <- filter(data_6, tdr1 == "positif" & cough_fever == "both")
unk <- filter(data_6, tdr1 == "unknown")



temp <- filter(data_6, cough_fever == "both" | tdr1 == "positif")
other <- filter(data_6, !n %in% temp$n)


all_deaths <- map(list(mal, resp, resp_mal, unk), 
    ~.x %>% 
      filter(decede_non == "decede") %>% 
      group_by(year_week_factor) %>% 
      summarise(count = n())
) %>% 
  set_names(c("malaria_only", "respiratory_only", 
              "malaria_and_respiratory", "unknown")) %>% 
  list_rbind(names_to = "presentation") %>% 
  complete(year_week_factor, presentation, fill = list(count = 0))

ggplot(all_deaths)+
  geom_col(aes(x = year_week_factor, y = count, 
               fill = presentation, group = presentation),
           position = "dodge")

```

```{r eval = FALSE}


sympt_specific_out <- function(x, db){
  y <- sym(x)
  a <- db %>% 
    ungroup() %>% 
    filter({{y}} == "oui") %>% 
    summarise(nombre = n(), 
              tpr = round(100*sum(tdr1 == "positif", na.rm = TRUE)/(sum(tdr1 == "negatif", 
                                                                        na.rm = TRUE) + 
                                                                      sum(tdr1 == "positif",
                                                                          na.rm = TRUE)),1),
              taux_mortalite = round(100*sum(evolution == "decede", na.rm = TRUE)/(sum(evolution != "decede", 
                                                                                       na.rm = TRUE)+sum(evolution == "decede", na.rm = TRUE)),2)
              )
  
  return(a)
  }


a <- map(names(data5[14:30]), ~sympt_specific_out(.x, data5)) %>% 
  set_names(names(data5[14:30])) %>% 
  list_rbind(names_to = "presentation")

rio::export(a, "outcome_par_symptom.xlsx")

a_flex <- a %>% 
  mutate(presentation = str_to_title(str_replace_all(presentation, "_", " "))) %>% 
  arrange(-nombre) %>% 
  rename("Symptômes" = presentation, 
         "Nombre de Cas" = nombre, 
         "Taux de positivité - TDR (%)" = tpr, 
         "Taux de mortalité (%)" = taux_mortalite) %>% 
  flextable::flextable() %>% 
  flextable::colformat_num(big.mark = "", digits = 1) %>% 
  flextable::autofit()

flextable::save_as_docx(a, path = paste0(here::here("linelist", 
                                                    "output", 
                                                    "symptom_outcome_all.docx")))




################################################################################
#############################################  complications ###################




```

